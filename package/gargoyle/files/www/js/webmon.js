/*
 * This program is copyright © 2008-2010 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){if(updateInProgress)return;updateInProgress=!0,errorList=proofreadAll();if(errorList.length>0)updateInProgress=!1,errorString=errorList.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{setControlsEnabled(!1,!0),webmonUpdater!=null&&clearInterval(webmonUpdater);var a=document.getElementById("webmon_enabled").checked,b="/etc/init.d/webmon_gargoyle "+(a?"enable":"disable")+"\n",c="/etc/init.d/webmon_gargoyle stop";uci=uciOriginal.clone();if(a){uci.set("webmon_gargoyle","webmon","max_domains",document.getElementById("num_domains").value),uci.set("webmon_gargoyle","webmon","max_searches",document.getElementById("num_searches").value);var d=document.getElementById("ip_table_container").firstChild,e=getTableDataArray(d,!0,!1),f=[],g;for(g=0;g<e.length;g++)f.push(e[g][0].replace(/[\t ]+/,""));uci.remove("webmon_gargoyle","webmon","include_ips"),uci.remove("webmon_gargoyle","webmon","exclude_ips");var h=getSelectedValue("include_exclude");h=="exclude"&&f.length>0?uci.set("webmon_gargoyle","webmon","exclude_ips",f.join(",")):h=="include"&&f.length>0&&uci.set("webmon_gargoyle","webmon","include_ips",f.join(",")),c="/etc/init.d/webmon_gargoyle restart\n"}commands=uci.getScriptCommands(uciOriginal)+"\n"+b+c;var i=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),j=function(a){if(a.readyState==4){webmonEnabled=document.getElementById("webmon_enabled").checked,includeData=[],excludeData=[];var b=document.getElementById("ip_table_container").firstChild;uciOriginal=uci.clone(),setControlsEnabled(!0),updateInProgress=!1,webmonEnabled&&updateMonitorTable(),resetData()}};runAjax("POST","utility/run_commands.sh",i,j)}}function clearHistory(){if(updateInProgress)return;updateInProgress=!0,setControlsEnabled(!1,!0);var a=uciOriginal.get("webmon_gargoyle","webmon","domain_save_path"),b=uciOriginal.get("webmon_gargoyle","webmon","search_save_path"),c="/etc/init.d/webmon_gargoyle stop\nrm -rf "+a+" 2>/dev/null ; rm -rf "+b+" 2>/dev/null";webmonEnabled&&(c+="\n/etc/init.d/webmon_gargoyle start");var d=function(a){if(a.readyState==4){setControlsEnabled(!0),updateInProgress=!1;var b=["webmon_domain_table_container","webmon_search_table_container"],c;for(c=0;c<b.length;c++)tableContainer=document.getElementById(b[c]),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild);setElementEnabled(document.getElementById("domain_host_display"),webmonEnabled),setElementEnabled(document.getElementById("search_host_display"),webmonEnabled),webmonEnabled&&updateMonitorTable()}},e=getParameterDefinition("commands",c)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,""));runAjax("POST","utility/run_commands.sh",e,d)}function proofreadAll(){var a=function(a){return validateNumericRange(a,1,9999)};return proofreadFields(["num_domains","num_searches"],["num_domains_label","num_searches_label"],[a,a],[0,0],["num_domains_label","num_searches_label"])}function getHostDisplay(a,b){var c=a;return b=="hostname"&&ipToHostname[a]!=null&&(c=ipToHostname[a],c=c.length<25?c:c.substr(0,22)+"..."),c}function resetData(){document.getElementById("webmon_enabled").checked=webmonEnabled;var a=uciOriginal.get("webmon_gargoyle","webmon","max_domains"),b=uciOriginal.get("webmon_gargoyle","webmon","max_searches");document.getElementById("num_domains").value=a==""?300:a,document.getElementById("num_searches").value=b==""?300:b;var c=[];uciOriginal.get("webmon_gargoyle","webmon","exclude_ips")!=""?(c=uciOriginal.get("webmon_gargoyle","webmon","exclude_ips").split(/,/),setSelectedValue("include_exclude","exclude")):uciOriginal.get("webmon_gargoyle","webmon","include_ips")!=""?(c=uciOriginal.get("webmon_gargoyle","webmon","include_ips").split(/,/),setSelectedValue("include_exclude","include")):setSelectedValue("include_exclude","all");var d=[];while(c.length>0)d.push([c.shift()]);var e=createTable([""],d,"ip_table",!0,!1),f=document.getElementById("ip_table_container");f.firstChild!=null&&f.removeChild(f.firstChild),f.appendChild(e),setIncludeExclude(),setWebmonEnabled();var g=["webmon_domain_table_container","webmon_search_table_container"],h;for(h=0;h<g.length;h++)f=document.getElementById(g[h]),f.firstChild!=null&&f.removeChild(f.firstChild);webmonEnabled&&(updateMonitorTable(),webmonUpdater!=null&&clearInterval(webmonUpdater),webmonUpdater=setInterval("updateMonitorTable()",1e4)),setElementEnabled(document.getElementById("domain_host_display"),webmonEnabled),setElementEnabled(document.getElementById("search_host_display"),webmonEnabled),setElementEnabled(document.getElementById("download_domain_button"),webmonEnabled),setElementEnabled(document.getElementById("download_search_button"),webmonEnabled)}function setIncludeExclude(){document.getElementById("add_ip_container").style.display=getSelectedValue("include_exclude")=="all"?"none":"block"}function setWebmonEnabled(){var a=document.getElementById("webmon_enabled").checked,b=["num_domains","num_searches","include_exclude","add_ip"];for(idIndex in b)element=document.getElementById(b[idIndex]),element.disabled=!a,element.readonly=!a,element.style.color=a?"#000000":"#AAAAAA";var c=document.getElementById("add_ip_button");c.className=a?"default_button":"default_button_disabled",c.disabled=!a,addIpTable=document.getElementById("ip_table_container").firstChild,addIpTable!=null&&setRowClasses(addIpTable,a)}function updateMonitorTable(){if(!updateInProgress){updateInProgress=!0;var a="echo domains ; cat /proc/webmon_recent_domains 2>/dev/null; echo searches ; cat /proc/webmon_recent_searches 2>/dev/null ; echo webmon_done",b=getParameterDefinition("commands",a)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),c=function(a){if(a.readyState==4){var b=[],c=a.responseText.split(/[\n\r]+/),d=c!=null;if(d){var e=[],f=[],g="domains",h=getSelectedValue("domain_host_display"),i=0;while(c[i]!="domains"&&i<c.length)i++;for(i++;d&&c[i]!="webmon_done"&&i<c.length;i++)if(c[i]=="searches")g="searches",h=getSelectedValue("search_host_display");else{var j=c[i].split(/[\t]+/);d=d&&parseInt(j[0])!="NaN";var k=new Date;k.setTime(1e3*parseInt(j[0]));var l=uciOriginal.get("gargoyle","global","dateformat"),m=function(a){var b=""+a;return b=b.length==1?"0"+b:b,b},n=m(k.getMonth()+1),o=m(k.getDate()),p=" "+k.getHours()+":"+m(k.getMinutes())+":"+m(k.getSeconds()),q=l==""||l=="usa"?n+"/"+o+p:o+"/"+n+p;q=l=="russia"?o+"."+n+p:q,q=l=="iso8601"?n+"-"+o+p:q;var r=getHostDisplay(j[1],h),s=j[2];if(g=="domains"){var t=document.createElement("a");t.setAttribute("href","http://"+s);var u=s;u.length>43&&(u=u.substr(0,40)+"..."),t.appendChild(document.createTextNode(u)),e.push([r,q,t])}else{var v=s.replace(/\+/g," ");v.length>43&&(v=v.substr(0,40)+"..."),f.push([r,q,v])}}}if(d){var w=["本地主机","最后访问时间","访问地址"],x=["本地主机","最后访问时间","搜索关键字"],y=createTable(w,e,"webmon_domain_table",!1,!1),z=createTable(x,f,"webmon_search_table",!1,!1),A=["webmon_domain_table_container","webmon_search_table_container"],B;for(B=0;B<A.length;B++)tableContainer=document.getElementById(A[B]),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild),tableContainer.appendChild(A[B].match(/domain/)!=null?y:z)}updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",b,c)}}var updateInProgress,timeSinceUpdate,webmonUpdater=null;