/*
 * This program is copyright � 2008 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){errorList=proofreadAll();if(errorList.length>0)errorString=errorList.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{setControlsEnabled(!1,!0);var a=[],b=["redirect","redirect_disabled","dmz"];for(typeIndex=0;typeIndex<b.length;typeIndex++){var c=b[typeIndex],d=uciOriginal.getAllSectionsOfType("firewall",c);while(d.length>0){var e=d.pop();uciOriginal.removeSection("firewall",e),a.push("uci del firewall."+e)}}var f=uciOriginal.clone(),g=document.getElementById("portf_table_container").firstChild,h=getTableDataArray(g,!0,!1),i=0,j=0;for(rowIndex=0;rowIndex<h.length;rowIndex++){var k=h[rowIndex],l=k[5].checked,m=k[1].toLowerCase()=="both"?["tcp","udp"]:[k[1].toLowerCase()],n=0;for(n=0;n<m.length;n++){var o="redirect_"+(l?"enabled":"disabled")+"_number_"+(l?i:j);a.push("uci set firewall."+o+"="+(l?"redirect":"redirect_disabled")),f.set("firewall",o,"",l?"redirect":"redirect_disabled"),f.set("firewall",o,"name",k[0]),f.set("firewall",o,"src","wan"),f.set("firewall",o,"dest","lan"),f.set("firewall",o,"proto",m[n]),f.set("firewall",o,"src_dport",k[2]),f.set("firewall",o,"dest_ip",k[3]),f.set("firewall",o,"dest_port",k[4]),i+=l?1:0,j+=l?0:1}}var p=document.getElementById("portfrange_table_container").firstChild,q=getTableDataArray(p,!0,!1);for(rowIndex=0;rowIndex<q.length;rowIndex++){var k=q[rowIndex],l=k[5].checked,m=k[1].toLowerCase()=="both"?["tcp","udp"]:[k[1].toLowerCase()],n=0;for(n=0;n<m.length;n++){var o="redirect_"+(l?"enabled":"disabled")+"_number_"+(l?i:j);a.push("uci set firewall."+o+"="+(l?"redirect":"redirect_disabled")),f.set("firewall",o,"",l?"redirect":"redirect_disabled"),f.set("firewall",o,"name",k[0]),f.set("firewall",o,"src","wan"),f.set("firewall",o,"dest","lan"),f.set("firewall",o,"proto",m[n]),f.set("firewall",o,"src_dport",k[2]+"-"+k[3]),f.set("firewall",o,"dest_port",k[2]+"-"+k[3]),f.set("firewall",o,"dest_ip",k[4]),i+=l?1:0,j+=l?0:1}}if(document.getElementById("dmz_enabled").checked){var o="dmz";a.push("uci firewall.dmz=dmz"),f.set("firewall",o,"","dmz"),f.set("firewall",o,"from","wan"),f.set("firewall",o,"to_ip",document.getElementById("dmz_ip").value)}a.push("uci commit"),restartFirewallCommand="\nsh /usr/lib/gargoyle/restart_firewall.sh ;\n",upnpStartCommands=new Array,upnpdEnabled=document.getElementById("upnp_enabled").checked,upnpdEnabled?(upnpStartCommands.push("/etc/init.d/miniupnpd enable"),f.set("upnpd","config","enable_upnp","1"),f.set("upnpd","config","enable_natpmp","1"),f.set("upnpd","config","upload",document.getElementById("upnp_up").value),f.set("upnpd","config","download",document.getElementById("upnp_down").value)):(f.set("upnpd","config","enable_upnp","0"),f.set("upnpd","config","enable_natpmp","0"),upnpStartCommands.push("/etc/init.d/miniupnpd disable")),commands=a.join("\n")+"\n"+f.getScriptCommands(uciOriginal)+"\n"+upnpStartCommands.join("\n")+"\n"+restartFirewallCommand;var r=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),s=function(a){a.readyState==4&&(uciOriginal=f.clone(),resetData(),setControlsEnabled(!0))};runAjax("POST","utility/run_commands.sh",r,s)}}function proofreadAll(){return controlIds=["dmz_ip","upnp_up","upnp_down"],labelIds=["dmz_ip_label","upnp_up_label","upnp_down_label"],functions=[validateIP,validateNumeric,validateNumeric],returnCodes=[0,0,0],visibilityIds=controlIds,errors=proofreadFields(controlIds,labelIds,functions,returnCodes,visibilityIds),errors}function addPortfRule(){errors=proofreadForwardSingle();if(errors.length>0)alert(errors.join("\n")+"\n\nCould not add forwarding rule.");else{values=new Array,ids=["add_desc","add_prot","add_fp","add_ip","add_dp"];for(idIndex in ids)element=document.getElementById(ids[idIndex]),v=element.value,v=v==""?"-":v,values.push(v),element.type=="text"&&(element.value="");values[4]=values[4]=="-"?values[2]:values[4],portfTable=document.getElementById("portf_table_container").firstChild,currentPortfData=getTableDataArray(portfTable,!0,!1),otherProto=values[1]=="TCP"?"UDP":"TCP",mergedWithExistingRule=!1;for(rowDataIndex in currentPortfData)rowData=currentPortfData[rowDataIndex],otherProto==rowData[1]&&values[2]==rowData[2]&&values[3]==rowData[3]&&values[4]==rowData[4]&&(portfTable.rows[rowDataIndex*1+1].childNodes[1].firstChild.data="Both",values[0]!="-"&&rowData[0]=="-"&&(portfTable.rows[rowDataIndex*1+1].childNodes[0].firstChild.data=values[0]),table1Container=document.getElementById("portf_table_container"),table1Container.firstChild!=null&&table1Container.removeChild(table1Container.firstChild),table1Container.appendChild(portfTable),mergedWithExistingRule=!0);mergedWithExistingRule||(checkbox=createInput("checkbox"),checkbox.checked=!0,values.push(checkbox),values.push(createEditButton(!0)),addTableRow(portfTable,values,!0,!1))}}function addPortfRangeRule(){errors=proofreadForwardRange();if(errors.length>0)alert(errors.join("\n")+"\n\nCould not add forwarding rule.");else{values=new Array,ids=["addr_desc","addr_prot","addr_sp","addr_ep","addr_ip"];for(idIndex in ids)element=document.getElementById(ids[idIndex]),v=element.value,v=v==""?"-":v,values.push(v),element.type=="text"&&(element.value="");portfRangeTable=document.getElementById("portfrange_table_container").firstChild,currentRangeData=getTableDataArray(portfRangeTable,!0,!1),otherProto=values[1]=="TCP"?"UDP":"TCP",mergedWithExistingRule=!1;for(rowDataIndex in currentRangeData)rowData=currentRangeData[rowDataIndex],otherProto==rowData[1]&&values[2]==rowData[2]&&values[3]==rowData[3]&&values[4]==rowData[4]&&(portfRangeTable.rows[rowDataIndex*1+1].childNodes[1].firstChild.data="Both",values[0]!="-"&&rowData[0]=="-"&&(portfRangeTable.rows[rowDataIndex*1+1].childNodes[0].firstChild.data=values[0]),table2Container=document.getElementById("portfrange_table_container"),table2Container.firstChild!=null&&table2Container.removeChild(table2Container.firstChild),table2Container.appendChild(portfRangeTable),mergedWithExistingRule=!0);mergedWithExistingRule||(checkbox=createInput("checkbox"),checkbox.checked=!0,values.push(checkbox),values.push(createEditButton(!1)),portfrangeTable=document.getElementById("portfrange_table_container").firstChild,addTableRow(portfrangeTable,values,!0,!1))}}function proofreadForwardRange(a,b,c){a=a==null?document:a,b=b==null?document:b;var d=["addr_sp","addr_ep","addr_ip"],e=["addr_sp_label","addr_ep_label","addr_ip_label"],f=[validateNumeric,validateNumeric,validateIP],g=[0,0,0],h=d,i=proofreadFields(d,e,f,g,h,a);if(i.length==0){1*a.getElementById("addr_sp").value>1*a.getElementById("addr_ep").value&&i.push("Start Port > End Port");var j=b.getElementById("portf_table_container").firstChild,k=getTableDataArray(j,!0,!1),l=a.getElementById("addr_sp").value,m=a.getElementById("addr_ep").value,n=a.getElementById("addr_prot").value,o=0;for(o=0;o<k.length;o++){var p=k[o];(n==p[1]||n=="Both"||p[1]=="Both")&&l*1<=p[2]*1&&m*1>=p[2]*1&&i.push("Port(s) Within Range Is/Are Already Being Forwarded")}var q=b.getElementById("portfrange_table_container").firstChild,r=getTableDataArray(q,!0,!1);for(o=0;o<r.length;o++)if(q.rows[o+1]!=c){var p=r[o];(n==p[1]||n=="Both"||p[1]=="Both")&&p[2]*1<=m*1&&p[3]*1>=l*1&&i.push("Port(s) Within Range Is/Are Already Being Forwarded")}}return i}function proofreadForwardSingle(a,b,c){a=a==null?document:a,b=b==null?document:b;var d=["add_fp","add_ip"],e=["add_fp_label","add_ip_label","add_dp_label"],f=[validateNumeric,validateIP,validateNumeric],g=[0,0,0],h=d;a.getElementById("add_dp").value.length>0&&d.push("add_dp");var i=proofreadFields(d,e,f,g,h,a);if(i.length==0){var j=b.getElementById("portf_table_container").firstChild,k=getTableDataArray(j,!0,!1),l=a.getElementById("add_fp").value,m=a.getElementById("add_prot").value,n=0;for(n=0;n<k.length;n++)if(j.rows[n+1]!=c){var o=k[n];(m==o[1]||m=="Both"||o[1]=="Both")&&l==o[2]&&i.push("Port Is Already Being Forwarded")}var p=b.getElementById("portfrange_table_container").firstChild,q=getTableDataArray(p,!0,!1);for(n=0;n<q;n++){var o=q[n];(m==o[1]||m=="Both"||o[1]=="Both")&&o[2]*1<=l*1&&o[3]*1>=l*1&&i.push("Port Is Already Being Forwarded")}}return i}function resetData(){var a=new Array,b=new Array,c=new Array,d=new Array,e="",f=[],g=[];f.tcp=[],f.udp=[],g.tcp=[],g.udp=[];var h=["redirect","redirect_disabled"];for(typeIndex=0;typeIndex<h.length;typeIndex++){var i=h[typeIndex],j=uciOriginal.getAllSectionsOfType("firewall",h[typeIndex]);for(rdIndex=0;rdIndex<j.length;rdIndex++){var k=j[rdIndex],l=uciOriginal.get("firewall",k,"name");l=l==""?"-":l;var m=uciOriginal.get("firewall",k,"proto").toLowerCase(),n=uciOriginal.get("firewall",k,"src_dport"),o=uciOriginal.get("firewall",k,"dest_ip"),p=uciOriginal.get("firewall",k,"dest_port");if(n==""&&p==""&&i=="redirect")e=e==""?o:e;else if(m.toLowerCase()=="tcp"||m.toLowerCase()=="udp"){checkbox=createInput("checkbox"),checkbox.checked=i=="redirect"?!0:!1,p=p==""?n:p,otherProto=m=="tcp"?"udp":"tcp",hashStr=l+"-"+n+"-"+o+"-"+p;if(n.match(/-/)){var q=n.split(/-/);if(g[otherProto][hashStr]!=null)g[otherProto][hashStr][1]="Both";else{var r=[l,m.toUpperCase(),q[0],q[1],o,checkbox,createEditButton(!1)];b.push(r),g[m][hashStr]=r,d.push(checkbox.checked)}}else if(f[otherProto][hashStr]!=null)f[otherProto][hashStr][1]="Both";else{var r=[l,m.toUpperCase(),n,o,p,checkbox,createEditButton(!0)];a.push(r),f[m][hashStr]=r,c.push(checkbox.checked)}}}}x=["描述","协议","来源端口","目标 IP","目标端口","已启用",""],portfTable=createTable(x,a,"portf_table",!0,!1),table1Container=document.getElementById("portf_table_container"),table1Container.firstChild!=null&&table1Container.removeChild(table1Container.firstChild),table1Container.appendChild(portfTable),x=["描述","协议","起始端口","结束端口","目标 IP","已启用",""],portfrangeTable=createTable(x,b,"portf_range_table",!0,!1),table2Container=document.getElementById("portfrange_table_container"),document.getElementById("portfrange_table_container").firstChild!=null&&table2Container.removeChild(table2Container.firstChild),table2Container.appendChild(portfrangeTable);for(spIndex=0;spIndex<c.length;spIndex++)a[spIndex][5].checked=c[spIndex];for(prIndex=0;prIndex<d.length;prIndex++)b[prIndex][5].checked=d[prIndex];clearIds=["add_desc","add_fp","add_ip","add_dp","addr_desc","addr_sp","addr_ep","addr_ip"];for(clearIndex=0;clearIndex<clearIds.length;clearIndex++)document.getElementById(clearIds[clearIndex]).value="";var s=uciOriginal.getAllSectionsOfType("firewall","dmz");document.getElementById("dmz_enabled").checked=s.length>0;if(s.length>0)document.getElementById("dmz_ip").value=uciOriginal.get("firewall",s[0],"to_ip");else{var t=currentLanIp.split(/\.[^\.]*$/)[0],u=parseInt(currentLanIp.split(".")[3]);u>=254?u--:u++,t=t+"."+u,document.getElementById("dmz_ip").value=t}setDmzEnabled(),document.getElementById("upnp_enabled").checked=upnpdEnabled,upElement=document.getElementById("upnp_up"),downElement=document.getElementById("upnp_down"),upElement.value=uciOriginal.get("upnpd","config","upload"),upElement.value=upElement.value==""?1250:upElement.value,downElement.value=uciOriginal.get("upnpd","config","download"),downElement.value=downElement.value==""?1250:downElement.value,setUpnpEnabled(),initializeDescriptionVisibility(uciOriginal,"upnp_help"),uciOriginal.removeSection("gargoyle","help");if(upnpdEnabled)update_upnp(),timerid=setInterval("update_upnp()",1e4);else{clearInterval(timerid),timerid=null;var v=new Array,w=["***","***********","***** "];v.push(w);var x=["Proto","LAN Host","Port"],y=createTable(x,v,"upnp_table",!1,!1),z=document.getElementById("upnp_table_container");z.firstChild!=null&&z.removeChild(z.firstChild),z.appendChild(y)}}function setUpnpEnabled(){enableAssociatedField(document.getElementById("upnp_enabled"),"upnp_up",document.getElementById("upnp_up").value),enableAssociatedField(document.getElementById("upnp_enabled"),"upnp_down",document.getElementById("upnp_down").value)}function setDmzEnabled(){enableAssociatedField(document.getElementById("dmz_enabled"),"dmz_ip",document.getElementById("dmz_ip").value)}function createEditButton(a){var b=createInput("button");return b.value="编辑",b.className="default_button",b.onclick=a?function(){editForward(!0,this)}:function(){editForward(!1,this)},b}function editForward(a,b){if(typeof editForwardWindow!="undefined")try{editForwardWindow.close()}catch(c){}try{xCoor=window.screenX+225,yCoor=window.screenY+225}catch(c){xCoor=window.left+225,yCoor=window.top+225}var d=a?"single_forward_edit.sh":"multi_forward_edit.sh";editForwardWindow=window.open(d,"edit","width=560,height=180,left="+xCoor+",top="+yCoor),saveButton=createInput("button",editForwardWindow.document),closeButton=createInput("button",editForwardWindow.document),saveButton.value="关闭且保存设置",saveButton.className="default_button",closeButton.value="关闭不保存设置",closeButton.className="default_button",editRow=b.parentNode.parentNode,runOnEditorLoaded=function(){updateDone=!1;if(editForwardWindow.document!=null&&editForwardWindow.document.getElementById("bottom_button_container")!=null){editForwardWindow.document.getElementById("bottom_button_container").appendChild(saveButton),editForwardWindow.document.getElementById("bottom_button_container").appendChild(closeButton);var b=a?"":"r";editForwardWindow.document.getElementById("add"+b+"_button").style.display="none",editForwardWindow.document.getElementById("add"+b+"_desc").value=editRow.childNodes[0].firstChild.data,setSelectedText("add"+b+"_prot",editRow.childNodes[1].firstChild.data,editForwardWindow.document),a?(editForwardWindow.document.getElementById("add_fp").value=editRow.childNodes[2].firstChild.data,editForwardWindow.document.getElementById("add_ip").value=editRow.childNodes[3].firstChild.data,editForwardWindow.document.getElementById("add_dp").value=editRow.childNodes[4].firstChild.data):(editForwardWindow.document.getElementById("addr_sp").value=editRow.childNodes[2].firstChild.data,editForwardWindow.document.getElementById("addr_ep").value=editRow.childNodes[3].firstChild.data,editForwardWindow.document.getElementById("addr_ip").value=editRow.childNodes[4].firstChild.data),closeButton.onclick=function(){editForwardWindow.close()},saveButton.onclick=function(){var c;a?c=proofreadForwardSingle(editForwardWindow.document,document,editRow):c=proofreadForwardRange(editForwardWindow.document,document,editRow),c.length>0?alert(c.join("\n")+"\nCould not update port forward."):(editRow.childNodes[0].firstChild.data=editForwardWindow.document.getElementById("add"+b+"_desc").value,editRow.childNodes[1].firstChild.data=getSelectedValue("add"+b+"_prot",editForwardWindow.document),a?(editRow.childNodes[2].firstChild.data=editForwardWindow.document.getElementById("add_fp").value,editRow.childNodes[3].firstChild.data=editForwardWindow.document.getElementById("add_ip").value,editRow.childNodes[4].firstChild.data=editForwardWindow.document.getElementById("add_dp").value):(editRow.childNodes[2].firstChild.data=editForwardWindow.document.getElementById("addr_sp").value,editRow.childNodes[3].firstChild.data=editForwardWindow.document.getElementById("addr_ep").value,editRow.childNodes[4].firstChild.data=editForwardWindow.document.getElementById("addr_ip").value),editForwardWindow.close())},editForwardWindow.moveTo(xCoor,yCoor),editForwardWindow.focus(),updateDone=!0}updateDone||setTimeout("runOnEditorLoaded()",250)},runOnEditorLoaded()}function update_upnp(){if(!updateInProgress){updateInProgress=!0;var a="iptables -nL MINIUPNPD | grep ACCEPT",b=getParameterDefinition("commands",a)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),c=function(a){if(a.readyState==4){var b=a.responseText.split("\n"),c=new Array,d,e=0;if(b!=null)for(d=0;d<b.length;d++){var f=b[d].split(/\s+/);if(typeof f[6]!="undefined"){var g=[f[1],f[4],f[6].substr(4)];c.push(g),e+=1}}if(e==0){var g=["***","***********","***** "];c.push(g)}var h=["协议","LAN 主机","端口"],i=createTable(h,c,"upnp_table",!1,!1),j=document.getElementById("upnp_table_container");j.firstChild!=null&&j.removeChild(j.firstChild),j.appendChild(i),updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",b,c)}}var updateInProgress=!1,timerid=null;