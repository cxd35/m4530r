/*
 * This program is copyright ï¿½ 2008-2010 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function resetData(){allQuotaIds=quotaIdList,allQuotaIps=quotaIpLists,allQuotaUsed=quotaUsed,allQuotaLimits=quotaLimits,allQuotaPercents=quotaPercents,idToSection=[],idToIpStr=[],idToTimeParams=[];var a=uciOriginal.getAllSectionsOfType(pkg,"quota"),b;for(b=0;b<a.length;b++){var c=getIpFromUci(uciOriginal,a[b]),d=uciOriginal.get(pkg,a[b],"id");d=d==""?getIdFromIp(c,uciOriginal):d,idToSection[d]=a[b],idToIpStr[d]=c,idToTimeParams[d]=getTimeParametersFromUci(uciOriginal,a[b])}refreshTableData(),setInterval("updateTableData()",1500)}function getIpFromUci(a,b){var c=a.get(pkg,b,"ip");if(c=="ALL_OTHERS_INDIVIDUAL")c="Others (Individual)";else if(c=="ALL_OTHERS_COMBINED")c="Others (Combined)";else if(c=="ALL"||c=="")c="All";return c}function getIdFromIp(a,b){id=a==""?"ALL":a.replace(/[\t, ]+.*$/,""),id=id.replace(/\//,"_");var c=id,d=!0,e=0,f=b.getAllSectionsOfType(pkg,"quota");while(d){d=!1;var g;for(g=0;g<f.length&&!d;g++)d=d||b.get(pkg,f[g],"id")==id;if(d){var h="ABCDEFGHIJKLMNOPQRSTUVWXYZ",i=e<26?"_"+h.substr(e,1):"_Z"+(e-25);id=c+i}e++}return id}function getTimeParametersFromUci(a,b){var c=a.get(pkg,b,"offpeak_hours"),d=a.get(pkg,b,"offpeak_weekdays"),e=a.get(pkg,b,"offpeak_weekly_ranges"),f=c!=""||d!=""||e!=""?"except":"always";return f=="always"&&(c=a.get(pkg,b,"onpeak_hours"),d=a.get(pkg,b,"onpeak_weekdays"),e=a.get(pkg,b,"onpeak_weekly_ranges"),f=c!=""||d!=""||e!=""?"only":"always"),[c,d,e,f]}function timeParamsToTableSpan(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=[];return e=="always"?f.unshift("Always"):(d!=""?f=d.match(",")?d.split(/[\t ]*,[\t ]*/):[d]:(b!=""&&(f=b.match(",")?b.split(/[\t ]*,[\t ]*/):[b]),c!=""&&f.unshift(c)),f.unshift(e=="only"?"Only:":"All Times Except:")),textListToSpanElement(f,!1,document)}function getHostDisplay(a){var b=getSelectedValue("host_display"),c=a;return b=="hostname"&&ipToHostname[a]!=null&&(c=ipToHostname[a],c=c.length<25?c:c.substr(0,22)+"..."),c}function getHostList(a){var b=[],c=0;for(c=0;c<a.length;c++)b.push(getHostDisplay(a[c]));return b}function refreshTableData(){var a=uciOriginal.getAllSectionsOfType(pkg,"quota"),b=[],c;for(c=0;c<allQuotaIds.length;c++){var d,e=allQuotaIds[c],f=allQuotaIps[e],g=idToTimeParams[e];for(d=0;d<f.length;d++){var h=f[d],i="N/A",j="N/A",k="N/A";if(allQuotaPercents[e]!=null&&allQuotaPercents[e][h]!=null){var l=allQuotaUsed[e][h],m=allQuotaLimits[e][h],n=allQuotaPercents[e][h];k=n[0]>=0?n[0]+"%":k,j=n[1]>=0?n[1]+"%":j,i=n[2]>=0?n[2]+"%":i}ipList=h.split(/[\t ]*,[\t ]*/),hostList=getHostList(ipList),b.push([textListToSpanElement(hostList,!0,document),timeParamsToTableSpan(g),k,j,i])}}var o=["Host(s)","Active","% Total Used","% Down Used","% Up Used"],p=createTable(o,b,"quota_usage_table",!1,!1),q=document.getElementById("quota_table_container");while(q.firstChild!=null)q.removeChild(q.firstChild);q.appendChild(p)}function updateTableData(){if(!updateInProgress){updateInProgress=!0;var command="print_quotas\n",param=getParameterDefinition("commands",command)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),stateChangeFunction=function(req){if(req.readyState==4){var text=req.responseText.split(/[\r\n]+/),next="";while(text.length>0&&next!="Success")next=text.pop();eval(text.join("\n")),allQuotaIds=quotaIdList,allQuotaIps=quotaIpLists,allQuotaUsed=quotaUsed,allQuotaLimits=quotaLimits,allQuotaPercents=quotaPercents,refreshTableData(),updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",param,stateChangeFunction)}}var pkg="firewall",updateInProgress=!1,allQuotaIds,allQuotaIps,allQuotaUsed,allQuotaLimits,allQuotaPercents,idToSection=[],idToIpStr=[],idToTimeParams=[];