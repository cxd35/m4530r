/*
 * This program is copyright � 2008 Eric Bishop and is distributed under the terms of the GNU GPL
 * version 2.0 with a special clarification/exception that permits adapting the program to
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL.
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function initializeConnectionTable(){httpsPort=uciOriginal.get("httpd_gargoyle","server","https_port"),httpPort=uciOriginal.get("httpd_gargoyle","server","http_port"),setSelectedValue("host_display","hostname"),remoteHttpsPort="",remoteHttpPort="";var a=uciOriginal.getAllSectionsOfType("firewall","remote_accept"),b=0;for(b=0;b<a.length;b++){var c=a[b],d=uciOriginal.get("firewall",c,"local_port"),e=uciOriginal.get("firewall",c,"remote_port"),f=uciOriginal.get("firewall",c,"proto").toLowerCase(),g=uciOriginal.get("firewall",c,"zone").toLowerCase();(g=="wan"||g=="")&&(f=="tcp"||f=="")&&(e=e==""?d:e,d==httpsPort&&d!=""?remoteHttpsPort=e:d==httpPort&&d!=""&&(remoteHttpPort=e))}var h=0;for(h=0;h<qosMarkList.length;h++){var i=parseInt(qosMarkList[h][3].toLowerCase());qosUpMask=qosMarkList[h][0]=="upload"?i:qosUpMask,qosDownMask=qosMarkList[h][0]=="download"?i:qosDownMask,markToQosClass[parseInt(qosMarkList[h][2])]=qosMarkList[h][1]}updateInProgress=!1,timeSinceUpdate=-5e3,setInterval("checkForRefresh()",500)}function checkForRefresh(){timeSinceUpdate+=500,refreshRate=getSelectedValue("refresh_rate"),refreshRate=refreshRate=="never"?timeSinceUpdate+500:refreshRate;if(timeSinceUpdate<0||timeSinceUpdate>=refreshRate)timeSinceUpdate=0,updateConnectionTable()}function getHostDisplay(a){var b=getSelectedValue("host_display"),c=a;return b=="hostname"&&ipToHostname[a]!=null&&(c=ipToHostname[a],c=c.length<25?c:c.substr(0,22)+"..."),c}function updateConnectionTable(){if(!updateInProgress){updateInProgress=!0;var a="cat /proc/net/nf_conntrack",b=getParameterDefinition("commands",a)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),c=function(a){if(a.readyState==4){var b=getSelectedValue("bw_units"),c=a.responseText.split(/[\n\r]+/),d=new Array,e;for(e=0;c[e].match(/^Success/)==null;e++){var f=c[e];try{var g=f.split(/[\t ]+/)[2],h=f.match(/src=([^ \t]*)[\t ]+/)[1],i=f.match(/sport=([^ \t]*)[\t ]+/)[1],j=f.match(/dst=([^ \t]*)[\t ]+/)[1],k=f.match(/dport=([^ \t]*)[\t ]+/)[1],l=f.match(/bytes=([^ \t]*)[\t ]+/)[1],m=f.match(/mark=/)?parseInt(f.match(/mark=([^ \t]*)[\t ]+/)[1]):"",n=f.match(/l7proto=/)?f.match(/l7proto=([^ \t]*)[\t ]+/)[1]:"",o=f.match(/src=([^ \t]*)[\t ]+.*src=([^ \t]*)[\t ]+/)[2],p=f.match(/sport=([^ \t]*)[\t ]+.*sport=([^ \t]*)[\t ]+/)[2],q=f.match(/dst=([^ \t]*)[\t ]+.*dst=([^ \t]*)[\t ]+/)[2],r=f.match(/dport=([^ \t]*)[\t ]+.*dport=([^ \t]*)[\t ]+/)[2],s=f.match(/bytes=([^ \t]*)[\t ]+.*bytes=([^ \t]*)[\t ]+/)[2],t=currentLanIp.lastIndexOf(".");if(h.substr(0,t)!=j.substr(0,t)){q==currentWanIp?(downloadBytes=s,uploadBytes=l,localIp=h,localPort=i,WanIp=o,WanPort=p):(downloadBytes=l,uploadBytes=s,localIp=o,localPort=p,WanIp=q,WanPort=r);var u=[parseInt(uploadBytes)+parseInt(downloadBytes),g,textListToSpanElement([getHostDisplay(WanIp)+":"+WanPort,getHostDisplay(localIp)+":"+localPort]),textListToSpanElement([parseBytes(uploadBytes,b),parseBytes(downloadBytes,b)])];if(qosEnabled){var v=function(a,b){var c=a==""?"":markToQosClass[a&b],d=uciOriginal.get("qos_gargoyle",c,"name");return d==""?"NA":d};u.push(textListToSpanElement([v(qosUpMask,m),v(qosDownMask,m)]))}u.push(n),d.push(u)}}catch(w){}}var x=function(a,b){return parseInt(b[0])-parseInt(a[0])};d.sort(x);var y;for(y=0;y<d.length;y++)d[y].shift();var z=["协议","WAN 主机/LAN 主机","速率 上传/下载"];qosEnabled&&z.push("Qos 上传/下载"),z.push("L7 协议");var A=createTable(z,d,"connection_table",!1,!1);if(d.length>0){var B;try{for(B=0;B<5;B++)A.firstChild.firstChild.childNodes[B].style.textAlign="left"}catch(w){}}var C=document.getElementById("connection_table_container");C.firstChild!=null&&C.removeChild(C.firstChild),C.appendChild(A),updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",b,c)}}var updateInProgress,timeSinceUpdate,httpsPort="",httpPort="",remoteHttpsPort="",remoteHttpPort="",qosUpMask="",qosDownMask="",markToQosClass=[];