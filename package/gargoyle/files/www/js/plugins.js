/*
 *     Copyright (c) 2011 Cezary Jackiewicz <cezary@eko.one.pl>
 *     Copyright (c) 2012 Eric Bishop <eric@gargoyle-router.com>
 *
 *     This program is free software; you can redistribute it and/or modify
 *     it under the terms of the GNU General Public License as published by
 *     the Free Software Foundation; either version 2 of the License, or
 *     (at your option) any later version.
 *
 *     This program is distributed in the hope that it will be useful,
 *     but WITHOUT ANY WARRANTY; without even the implied warranty of
 *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *     GNU General Public License for more details.
 *
 *     You should have received a copy of the GNU General Public License
 *     along with this program; if not, write to the Free Software
 *     Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 *     MA 02110-1301, USA.
 */function createDisplayDiv(a,b){var c=document.createElement("div");c.style.width="320px",c.id=a;var d=function(a,b,c,d){var e;if(c){e=document.createElement("span");var f=b.split(/\n/);while(f.length>0)e.appendChild(document.createTextNode(f.shift())),f.length>0&&e.appendChild(document.createElement("br"))}else e=document.createElement(b);return a.appendChild(e),d&&a.appendChild(document.createElement("br")),e},e=b["Description"]==null?a:b.Description,f=[];f.not_installed="Not Installed",f.root="Pre-Installed",f.plugin_root="Installed";var g=f[b["Install-Destination"]];d(c,"strong",!1,!0),d(c.firstChild,e,!0,!0),d(c,"Version: "+b.Version,!0,!0),d(c,"Status: "+g,!0,g=="Not Installed"?!0:!1);if(g=="Not Installed"){var h=!1;for(var i in b["Required-Depends"])i.match(/^kmod.*usb/)&&(h=!0);canInstall=!h&&b["Will-Fit"]=="true",d(c,"Required Disk Space: "+parseBytes(b["Required-Size"]),!0,!canInstall);if(!canInstall){var j=d(c,"em",!1,!1);j.style.color="#FF0000",h?d(j,"Package Cannot Be Installed (Requires USB support)",!0,!1):b["Will-Fit"]=="false"&&d(j,"Package Cannot Be Installed (Insufficient Disk Space)",!0,!1),b["Can-Install"]=!1}else b["Can-Install"]=!0}return c}function updatePluginRootDisplay(){var a=getSelectedValue("plugin_root_drive_select");document.getElementById("plugin_root_static").style.display=a=="root"?"block":"none",document.getElementById("plugin_root_text").style.display=a=="root"?"none":"block"}function changePluginRoot(){var a=document.getElementById("plugin_root_text"),b=a.style.display!="none"?a.value:"/plugin_root",c=getSelectedValue("plugin_root_drive_select"),d=uciOriginal.get("gargoyle","plugin_options","root_drive");d=d==""?"root":d;var e=[],f=driveToPath[c]+"/"+b;if(d=="root"&&c!="root"){if(!confirm("You are switching your plugin root directory to a USB drive. This means that in order for your plugins to work correctly you must NOT remove this drive.\n\nContinue?"))return;e.push("mkdir -p '"+f+"'"),e.push("mv -f '/plugin_root/'* '"+f+"/'"),e.push("rm -r '/plugin_root/'"),e.push("ln -s '"+f+"' '/plugin_root'")}else d!="root"&&c=="root"?(e.push("mkdir -p '/plugin.root.tmp'"),e.push("mv -f '/plugin_root/'* '/plugin.root.tmp/'"),e.push("rm '/plugin_root'"),e.push("mv '/plugin.root.tmp' '/plugin_root'")):d!="root"&&c!="root"&&(e.push("mkdir -p '"+f+"'"),e.push("mv -f '/plugin_root/'* '"+f+"/'"),e.push("rm '/plugin_root/'"),e.push("ln -s '"+f+"' '/plugin_root'"));e.push("/sbin/uci set gargoyle.plugin_options=plugin_options"),e.push("/sbin/uci set gargoyle.plugin_options.root_dir='"+b+"'"),e.push("/sbin/uci set gargoyle.plugin_options.root_drive='"+c+"'"),e.push("/sbin/uci commit"),execute(e)}function removePluginSource(){var a=this.parentNode.parentNode.firstChild.firstChild.data,b=[];b.push('awk \' $1 != "src/gz" || $2 != "'+a+"\"  { print $0 } ' /etc/opkg.conf >/tmp/opkg.conf.tmp"),b.push("mv /tmp/opkg.conf.tmp /etc/opkg.conf"),b.push("rm -r '/tmp/opkg-lists/"+a+"'"),b.push("opkg update"),execute(b)}function addPluginSource(){var a=document.getElementById("add_source_name").value,b=document.getElementById("add_source_url").value,c=[];if(!a.match(/^[A-Za-z0-9_\-]+$/)){var d="ERROR: Invalid Character(s) In Source Name"+(a.match(/ /)?" (no spaces allowed)":"");c.push(d)}a.length==0&&c.push("ERROR: You must specify Source Name"),b.length==0&&c.push("ERROR: You must specify Source URL");var e=!1,f=!1,g;for(g=0;g<pluginSources.length;g++)e=a==pluginSources[g][0]?!0:e,f=b==pluginSources[g][1]?!0:f;e&&c.push("ERROR: Duplicate Source Name"),f&&c.push("ERROR: Duplicate Source URL");if(c.length>0)alert(c.join("\n")+"\n\nCannot Add Plugin Source");else{document.getElementById("add_source_name").value="",document.getElementById("add_source_url").value="";var h=[];b=b.replace(/'/,"%27"),h.push("echo 'src/gz "+a+" "+b+"'>> /etc/opkg.conf"),h.push("opkg update"),execute(h)}}function proofreadSourceName(a){var b=function(a){return a.length>0&&a.match(/^[A-Za-z0-9_\-]+$/)?0:1};proofreadText(a,b,0)}function resetData(){var a=uciOriginal.get("gargoyle","plugin_options","root_dir"),b=uciOriginal.get("gargoyle","plugin_options","root_drive");b=b==""?"root":b,a=a==""||b=="root"?"/plugin_root":a,document.getElementById("plugin_root_static").style.display=b=="root"?"block":"none",document.getElementById("plugin_root_text").style.display=b=="root"?"none":"block",document.getElementById("plugin_root_drive_static").style.display=storageDrives.length==0?"block":"none",document.getElementById("plugin_root_drive_select").style.display=storageDrives.length==0?"none":"block",document.getElementById("plugin_root_text").value=a,driveToPath.Root="/";if(storageDrives.length>0){var c=[],d=[];c.push("Root Drive "+parseBytes(opkg_dests.root["Bytes-Total"])+" Total, "+parseBytes(opkg_dests.root["Bytes-Free"])+" Free"),d.push("root");var e;for(e=0;e<storageDrives.length;e++)c.push(storageDrives[e][0]+" "+parseBytes(storageDrives[e][4])+" Total, "+parseBytes(storageDrives[e][5])+" Free"),d.push(storageDrives[e][0]),driveToPath[storageDrives[e][0]]=storageDrives[e][1];setAllowableSelections("plugin_root_drive_select",d,c,document),setSelectedValue("plugin_root_drive_select",b),document.getElementById("plugin_root_change_container").style.display="block"}else setChildText("plugin_root_drive_static","Root Drive "+parseBytes(opkg_dests.root["Bytes-Total"])+" Total, "+parseBytes(opkg_dests.root["Bytes-Free"])+" Free",null,null,null,document),document.getElementById("plugin_root_change_container").style.display="none";var f=[],g;for(g=0;g<pluginSources.length;g++){var h=pluginSources[g][0],i=pluginSources[g][1];i.match(/\/\/downloads.openwrt.org/)||i.match(/\/\/www.gargoyle-router.com/)?(remove=document.createElement("em"),remove.appendChild(document.createTextNode("预设"))):(remove=createInput("button"),remove.className="default_button",remove.value="删除",remove.onclick=removePluginSource),f.push([h+"\n"+i,remove])}var j=createTable(["名称",""],f,"package_source_table",!1,!1),k=document.getElementById("package_source_table_container");setSingleChild(k,j);var l=["软件包","已安装",""],m=new Array,n=0;for(n=0;n<opkg_matching_packages.length;n++){var o=opkg_matching_packages[n],p=opkg_info[o];if(p!=null){var q=createDisplayDiv(o,p),r=createInput("checkbox");r.disabled=!0,r.checked=p["Install-Destination"]=="not_installed"?!1:!0;var s=createInput("button");s.className="default_button",r.checked?(s.value="卸载",p["Install-Destination"]=="root"?(s.disabled=!0,s.className="default_button_disabled"):s.onclick=uninstallPackage):(s.value="安装",p["Can-Install"]?s.onclick=installPackage:(s.disabled=!0,s.className="default_button_disabled")),m.push([q,r,s])}}if(m.length==0)document.getElementById("no_packages").style.display="block";else{m.sort();var t=createTable(l,m,"packages_table",!1,!1),u=document.getElementById("packages_table_container");setSingleChild(u,t)}}function installPackage(){var a=this.parentNode.parentNode.firstChild.firstChild.id,b=["sh /usr/lib/gargoyle/install_gargoyle_package.sh "+a];execute(b)}function uninstallPackage(){var a=this.parentNode.parentNode.firstChild.firstChild.id,b=["sh /usr/lib/gargoyle/remove_gargoyle_package.sh "+a];execute(b)}function updatePackagesList(){var a=["opkg update"];execute(a)}function execute(a){var b=a.join("\n"),c=getParameterDefinition("commands",b)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,""));setControlsEnabled(!1,!0,"Please wait...");var d=function(a){a.readyState==4&&(setControlsEnabled(!0),window.location.href=window.location.href)};runAjax("POST","utility/run_commands.sh",c,d)}var driveToPath=[];