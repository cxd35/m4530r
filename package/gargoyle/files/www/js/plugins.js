/*
 *     Copyright (c) 2011 Cezary Jackiewicz <cezary@eko.one.pl>
 *     Copyright (c) 2012 Eric Bishop <eric@gargoyle-router.com>
 *
 *     This program is free software; you can redistribute it and/or modify
 *     it under the terms of the GNU General Public License as published by
 *     the Free Software Foundation; either version 2 of the License, or
 *     (at your option) any later version.
 *
 *     This program is distributed in the hope that it will be useful,
 *     but WITHOUT ANY WARRANTY; without even the implied warranty of
 *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *     GNU General Public License for more details.
 *
 *     You should have received a copy of the GNU General Public License
 *     along with this program; if not, write to the Free Software
 *     Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
 *     MA 02110-1301, USA.
 */function createDisplayDiv(e,t){var n=document.createElement("div");n.style.width="320px",n.id=e;var r=function(e,t,n,r){var i;if(n){i=document.createElement("span");var s=t.split(/\n/);while(s.length>0)i.appendChild(document.createTextNode(s.shift())),s.length>0&&i.appendChild(document.createElement("br"))}else i=document.createElement(t);return e.appendChild(i),r&&e.appendChild(document.createElement("br")),i},i=t["Description"]==null?e:t.Description,s=[];s.not_installed="Not Installed",s.root="Pre-Installed",s.plugin_root="Installed";var o=s[t["Install-Destination"]];r(n,"strong",!1,!0),r(n.firstChild,i,!0,!0),r(n,"Version: "+t.Version,!0,!0),r(n,"Status: "+o,!0,o=="Not Installed"?!0:!1);if(o=="Not Installed"){var u=!1;for(var a in t["Required-Depends"])a.match(/^kmod.*usb/)&&(u=!0);canInstall=!u&&t["Will-Fit"]=="true",r(n,"Required Disk Space: "+parseBytes(t["Required-Size"]),!0,!canInstall);if(!canInstall){var f=r(n,"em",!1,!1);f.style.color="#FF0000",u?r(f,"Package Cannot Be Installed (Requires USB support)",!0,!1):t["Will-Fit"]=="false"&&r(f,"Package Cannot Be Installed (Insufficient Disk Space)",!0,!1),t["Can-Install"]=!1}else t["Can-Install"]=!0}return n}function updatePluginRootDisplay(){var e=getSelectedValue("plugin_root_drive_select");document.getElementById("plugin_root_static").style.display=e=="root"?"block":"none",document.getElementById("plugin_root_text").style.display=e=="root"?"none":"block"}function changePluginRoot(){var e=document.getElementById("plugin_root_text"),t=e.style.display!="none"?e.value:"/plugin_root",n=getSelectedValue("plugin_root_drive_select"),r=uciOriginal.get("gargoyle","plugin_options","root_drive");r=r==""?"root":r;var i=[],s=driveToPath[n]+"/"+t;if(r=="root"&&n!="root"){if(!confirm("You are switching your plugin root directory to a USB drive. This means that in order for your plugins to work correctly you must NOT remove this drive.\n\nContinue?"))return;i.push("mkdir -p '"+s+"'"),i.push("mv -f '/plugin_root/'* '"+s+"/'"),i.push("rm -r '/plugin_root/'"),i.push("ln -s '"+s+"' '/plugin_root'")}else r!="root"&&n=="root"?(i.push("mkdir -p '/plugin.root.tmp'"),i.push("mv -f '/plugin_root/'* '/plugin.root.tmp/'"),i.push("rm '/plugin_root'"),i.push("mv '/plugin.root.tmp' '/plugin_root'")):r!="root"&&n!="root"&&(i.push("mkdir -p '"+s+"'"),i.push("mv -f '/plugin_root/'* '"+s+"/'"),i.push("rm '/plugin_root/'"),i.push("ln -s '"+s+"' '/plugin_root'"));i.push("/sbin/uci set gargoyle.plugin_options=plugin_options"),i.push("/sbin/uci set gargoyle.plugin_options.root_dir='"+t+"'"),i.push("/sbin/uci set gargoyle.plugin_options.root_drive='"+n+"'"),i.push("/sbin/uci commit"),execute(i)}function removePluginSource(){var e=this.parentNode.parentNode.firstChild.firstChild.data,t=[];t.push('awk \' $1 != "src/gz" || $2 != "'+e+"\"  { print $0 } ' /etc/opkg.conf >/tmp/opkg.conf.tmp"),t.push("mv /tmp/opkg.conf.tmp /etc/opkg.conf"),t.push("rm -r '/tmp/opkg-lists/"+e+"'"),t.push("opkg update"),execute(t)}function addPluginSource(){var e=document.getElementById("add_source_name").value,t=document.getElementById("add_source_url").value,n=[];if(!e.match(/^[A-Za-z0-9_\-]+$/)){var r="ERROR: Invalid Character(s) In Source Name"+(e.match(/ /)?" (no spaces allowed)":"");n.push(r)}e.length==0&&n.push("ERROR: You must specify Source Name"),t.length==0&&n.push("ERROR: You must specify Source URL");var i=!1,s=!1,o;for(o=0;o<pluginSources.length;o++)i=e==pluginSources[o][0]?!0:i,s=t==pluginSources[o][1]?!0:s;i&&n.push("ERROR: Duplicate Source Name"),s&&n.push("ERROR: Duplicate Source URL");if(n.length>0)alert(n.join("\n")+"\n\nCannot Add Plugin Source");else{document.getElementById("add_source_name").value="",document.getElementById("add_source_url").value="";var u=[];t=t.replace(/'/,"%27"),u.push("echo 'src/gz "+e+" "+t+"'>> /etc/opkg.conf"),u.push("opkg update"),execute(u)}}function proofreadSourceName(e){var t=function(e){return e.length>0&&e.match(/^[A-Za-z0-9_\-]+$/)?0:1};proofreadText(e,t,0)}function resetData(){var e=uciOriginal.get("gargoyle","plugin_options","root_dir"),t=uciOriginal.get("gargoyle","plugin_options","root_drive");t=t==""?"root":t,e=e==""||t=="root"?"/plugin_root":e,document.getElementById("plugin_root_static").style.display=t=="root"?"block":"none",document.getElementById("plugin_root_text").style.display=t=="root"?"none":"block",document.getElementById("plugin_root_drive_static").style.display=storageDrives.length==0?"block":"none",document.getElementById("plugin_root_drive_select").style.display=storageDrives.length==0?"none":"block",document.getElementById("plugin_root_text").value=e,driveToPath.Root="/";if(storageDrives.length>0){var n=[],r=[];n.push("Root Drive "+parseBytes(opkg_dests.root["Bytes-Total"])+" Total, "+parseBytes(opkg_dests.root["Bytes-Free"])+" Free"),r.push("root");var i;for(i=0;i<storageDrives.length;i++)n.push(storageDrives[i][0]+" "+parseBytes(storageDrives[i][4])+" Total, "+parseBytes(storageDrives[i][5])+" Free"),r.push(storageDrives[i][0]),driveToPath[storageDrives[i][0]]=storageDrives[i][1];setAllowableSelections("plugin_root_drive_select",r,n,document),setSelectedValue("plugin_root_drive_select",t),document.getElementById("plugin_root_change_container").style.display="block"}else setChildText("plugin_root_drive_static","Root Drive "+parseBytes(opkg_dests.root["Bytes-Total"])+" Total, "+parseBytes(opkg_dests.root["Bytes-Free"])+" Free",null,null,null,document),document.getElementById("plugin_root_change_container").style.display="none";var s=[],o;for(o=0;o<pluginSources.length;o++){var u=pluginSources[o][0],a=pluginSources[o][1];a.match(/\/\/downloads.openwrt.org/)||a.match(/\/\/www.gargoyle-router.com/)?(remove=document.createElement("em"),remove.appendChild(document.createTextNode("Preset"))):(remove=createInput("button"),remove.className="default_button",remove.value="Remove",remove.onclick=removePluginSource),s.push([u+"\n"+a,remove])}var f=createTable(["Name",""],s,"package_source_table",!1,!1),l=document.getElementById("package_source_table_container");setSingleChild(l,f);var c=["Package","Installed",""],h=new Array,p=0;for(p=0;p<opkg_matching_packages.length;p++){var d=opkg_matching_packages[p],v=opkg_info[d];if(v!=null){var m=createDisplayDiv(d,v),g=createInput("checkbox");g.disabled=!0,g.checked=v["Install-Destination"]=="not_installed"?!1:!0;var y=createInput("button");y.className="default_button",g.checked?(y.value="Uninstall",v["Install-Destination"]=="root"?(y.disabled=!0,y.className="default_button_disabled"):y.onclick=uninstallPackage):(y.value="Install",v["Can-Install"]?y.onclick=installPackage:(y.disabled=!0,y.className="default_button_disabled")),h.push([m,g,y])}}if(h.length==0)document.getElementById("no_packages").style.display="block";else{h.sort();var b=createTable(c,h,"packages_table",!1,!1),w=document.getElementById("packages_table_container");setSingleChild(w,b)}}function installPackage(){var e=this.parentNode.parentNode.firstChild.firstChild.id,t=["sh /usr/lib/gargoyle/install_gargoyle_package.sh "+e];execute(t)}function uninstallPackage(){var e=this.parentNode.parentNode.firstChild.firstChild.id,t=["sh /usr/lib/gargoyle/remove_gargoyle_package.sh "+e];execute(t)}function updatePackagesList(){var e=["opkg update"];execute(e)}function execute(e){var t=e.join("\n"),n=getParameterDefinition("commands",t)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,""));setControlsEnabled(!1,!0,"Please wait...");var r=function(e){e.readyState==4&&(setControlsEnabled(!0),window.location.href=window.location.href)};runAjax("POST","utility/run_commands.sh",n,r)}var driveToPath=[];