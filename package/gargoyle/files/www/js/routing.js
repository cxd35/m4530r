function saveChanges(){setControlsEnabled(!1,!0,"Please Wait While Settings Are Applied");var a=[],b=uciOriginal.getAllSectionsOfType("network","route");while(b.length>0){var c=b.pop();uciOriginal.removeSection("network",c),a.push("uci del network."+c)}a.push("uci commit");var d=uciOriginal.clone(),e=document.getElementById("static_route_table_container").firstChild,f=getTableDataArray(e,!0,!1),g=0;for(g=0;g<f.length;g++){var h=f[g],i=parseDest(h[0]),j=i[0],k=i[1],l=h[1],m=h[2]=="*"?"0.0.0.0":h[2],n="route"+(g+1);d.set("network",n,"","route"),d.set("network",n,"target",j),d.set("network",n,"interface",l),d.set("network",n,"gateway",m),k!=""&&d.set("network",n,"netmask",k)}commands=a.join("\n")+"\n"+d.getScriptCommands(uciOriginal)+"\nsh /usr/lib/gargoyle/restart_network.sh ;\n";var o=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),p=function(a){a.readyState!=4};runAjax("POST","utility/run_commands.sh",o,p),currentProtocol=location.href.match(/^https:/)?"https":"http",testLocation=currentProtocol+"://"+window.location.host+"/utility/reboot_test.sh",testReboot=function(){toggleReload=!0,setTimeout("testReboot()",5e3),document.getElementById("reboot_test").src=testLocation},setTimeout("testReboot()",15e3),setTimeout("reloadPage()",24e4)}function reloadPage(){if(toggleReload){var a=document.getElementById("reboot_test").readyState;if(typeof a=="undefined"||a==null||a=="complete")toggleReload=!1,document.getElementById("reboot_test").src="",setTimeout("window.location.href = window.location.href;",1500)}}function resetData(){routingData.shift(),routingData.shift();var a=[];while(routingData.length>0){var b=routingData.shift(),c=b.split(/[\t ]+/),d=[],e=c[7];e=c[7]==wanIface?e+" (WAN)":e,e=c[7]==lanIface?e+" (LAN)":e,e!=""&&(l=c[0]=="default"&&c[2]=="0.0.0.0"?"":"/"+c[2],l=l=="/255.255.255.255"?"":l,d.push(c[0]+l,e,c[1],c[4]),a.push(d))}var f=document.getElementById("active_route_table_container");f.firstChild!=null&&f.removeChild(f.firstChild);var g=createTable(["目标地址","接口(网络)","网关","跃点数"],a,"active_route_table",!1,!1);f.appendChild(g);var h=uciOriginal.getAllSectionsOfType("network","route"),i=[];while(h.length>0){var j=h.shift(),k=uciOriginal.get("network",j,"target"),l=uciOriginal.get("network",j,"netmask"),e=uciOriginal.get("network",j,"interface"),m=uciOriginal.get("network",j,"gateway");m=m=="0.0.0.0"?"*":m,k=l==""?k:k+"/"+l,k=k=="0.0.0.0"||k=="0.0.0.0/0.0.0.0"?"default":k,i.push([k,e,m,createEditButton()])}f=document.getElementById("static_route_table_container"),f.firstChild!=null&&f.removeChild(f.firstChild);var n=createTable(["目标地址","接口","网关",""],i,"static_route_table",!0,!1);f.appendChild(n)}function createEditButton(){var a=createInput("button");return a.value="编辑",a.className="default_button",a.onclick=editStaticRoute,a}function addStaticRoute(){errors=proofreadStaticRoute(document);if(errors.length>0)alert(errors.join("\n")+"\n\nCould not add row.");else{var a=parseDest(document.getElementById("add_dest").value),b=a[1]==""?a[0]:a[0]+"/"+a[1],c=getSelectedValue("add_iface"),d=document.getElementById("add_gateway").value;d=d=="0.0.0.0"?"*":d,b=b=="0.0.0.0/0.0.0.0"?"default":b;var e=[b,c,d,createEditButton()],f=document.getElementById("static_route_table_container").firstChild;addTableRow(f,e,!0,!1),document.getElementById("add_dest").value="",document.getElementById("add_gateway").value=""}}function validateGatewayIp(a){return validateIP(a)==0||a=="0.0.0.0"||a=="*"?0:1}function proofreadGatewayIp(a){proofreadText(a,validateGatewayIp,0)}function validateRouteIp(a){return validateIpRange(a)==0||a=="0.0.0.0"||a=="0.0.0.0/0.0.0.0"||a=="0.0.0.0/0"||a=="default"?0:1}function proofreadRouteIp(a){proofreadText(a,validateRouteIp,0)}function proofreadStaticRoute(a){return a=a==null?document:a,addIds=["add_dest","add_gateway"],labelIds=["add_dest_label","add_gateway_label"],functions=[validateRouteIp,validateGatewayIp],returnCodes=[0,0],visibilityIds=addIds,proofreadFields(addIds,labelIds,functions,returnCodes,visibilityIds,a)}function parseDest(a){var b=a;if(b.toLowerCase()=="default"||b=="0.0.0.0"||b=="0.0.0.0/0"||b=="0.0.0.0/0.0.0.0")b="0.0.0.0/0.0.0.0";var c="";if(b.match(/\//)){var d=b.split(/\//);b=d[0],c=d[1];if(!c.match(/\./)){var e=parseInt(c),f=[];while(f.length<4){var g=e>8?8:e,h=255,i=g;while(i<8){var j=7-i;h-=Math.pow(2,j),i++}e-=g,f.push(""+h)}c=f.join(".")}d=b.split(/\./),splitMask=c.split(/\./);var k=3;while(k>0)d[k]=""+(parseInt(d[k])&parseInt(splitMask[k])),k--;b=d.join("."),c=splitMask.join(".")}return[b,c]}function editStaticRoute(){if(typeof editStaticWindow!="undefined")try{editStaticWindow.close()}catch(a){}try{xCoor=window.screenX+225,yCoor=window.screenY+225}catch(a){xCoor=window.left+225,yCoor=window.top+225}editStaticWindow=window.open("static_route_edit.sh","edit","width=560,height=180,left="+xCoor+",top="+yCoor),saveButton=createInput("button",editStaticWindow.document),closeButton=createInput("button",editStaticWindow.document),saveButton.value="Close and Apply Changes",saveButton.className="default_button",closeButton.value="Close and Discard Changes",closeButton.className="default_button",editRow=this.parentNode.parentNode,runOnEditorLoaded=function(){updateDone=!1;if(editStaticWindow.document!=null&&editStaticWindow.document.getElementById("bottom_button_container")!=null){editStaticWindow.document.getElementById("bottom_button_container").appendChild(saveButton),editStaticWindow.document.getElementById("bottom_button_container").appendChild(closeButton);var a=editRow.childNodes[0].firstChild.data,b=editRow.childNodes[2].firstChild.data;b=b=="*"?"0.0.0.0":b,a=a=="default"?"0.0.0.0/0.0.0.0":a,editStaticWindow.document.getElementById("add_dest").value=a,setSelectedValue("add_iface",editRow.childNodes[1].firstChild.data,editStaticWindow.document),editStaticWindow.document.getElementById("add_gateway").value=b,editStaticWindow.document.getElementById("add_button").style.display="none",closeButton.onclick=function(){editStaticWindow.close()},saveButton.onclick=function(){var a=proofreadStaticRoute(editStaticWindow.document,document,editRow);if(a.length>0)alert(a.join("\n")+"\nCould not update static route.");else{var b=editStaticWindow.document.getElementById("add_gateway").value;b=b=="0.0.0.0"?"*":b;var c=parseDest(editStaticWindow.document.getElementById("add_dest").value),d=c[1]==""?c[0]:c[0]+"/"+c[1];d=d=="0.0.0.0/0.0.0.0"?"default":d,editRow.childNodes[0].firstChild.data=d,editRow.childNodes[1].firstChild.data=getSelectedValue("add_iface",editStaticWindow.document),editRow.childNodes[2].firstChild.data=b,editStaticWindow.close()}},editStaticWindow.moveTo(xCoor,yCoor),editStaticWindow.focus(),updateDone=!0}updateDone||setTimeout("runOnEditorLoaded()",250)},runOnEditorLoaded()}var toggleReload=!1;