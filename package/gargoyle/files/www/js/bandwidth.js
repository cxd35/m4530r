/*
 * This program is copyright 2008-2012 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function stopInterval(){updateInterval!=null&&clearInterval(updateInterval)}function trim(a){return a?a.replace(/^\s\s*/,"").replace(/\s\s*$/,""):a}function BandwidthCookieContainer(){this.prefix="gargoyle.bandwidth_display.",this.set=function(a,b){var c=new Date((new Date).getTime()+864e7);document.cookie=this.prefix+a+"="+escape(b)+";expires="+c.toUTCString()},this.remove=function(a){var b=new Date(0);document.cookie=this.prefix+a+";expires="+b.toUTCString()},this.get=function(a,b){var c=document.cookie.split(";");for(var d=0;d<c.length;d++){var e=c[d].split("=");if(trim(e[0])==this.prefix+a)return trim(e[1])}return b}}function initializePlotsAndTable(){var a=bandwidthSettings.get("plot_time_frame","1"),b=bandwidthSettings.get("table_time_frame","1");setSelectedValue("plot_time_frame",a),setSelectedValue("table_time_frame",b),setSelectedValue("table_units","mixed"),document.getElementById("use_high_res_15m").checked=uciOriginal.get("gargoyle","bandwidth_display","high_res_15m")=="1"?!0:!1;var c=!1,d=!1,e=!1,f=!1,g;for(g=0;g<monitorNames.length;g++){var h=monitorNames[g];if(h.match(/qos/)){var i=h.match(/up/),j=h.match(/down/);c=c||i,d=d||j;var k=h.split("-");k.shift(),k.shift(),k.pop(),k.pop();var l=k.join("-"),m=uciOriginal.get("qos_gargoyle",l,"name");i&&definedUploadClasses[l]==null&&(qosUploadClasses.push(l),qosUploadNames.push(m),definedUploadClasses[l]=1),j&&definedDownloadClasses[l]==null&&(qosDownloadClasses.push(l),qosDownloadNames.push(m),definedDownloadClasses[l]=1)}e=h.match(/tor/)?!0:e,f=h.match(/openvpn/)?!0:f}var n=["plot1_type","plot2_type","plot3_type","table_type"],o;for(o=0;o<n.length;o++){var p=n[o];c&&addOptionToSelectElement(p,"QoS Upload Class","qos-upload"),d&&addOptionToSelectElement(p,"QoS Download Class","qos-download"),e&&addOptionToSelectElement(p,"Tor","tor"),f&&addOptionToSelectElement(p,"OpenVPN","openvpn"),addOptionToSelectElement(p,"Hostname","hostname"),addOptionToSelectElement(p,"IP","ip");var q=bandwidthSettings.get(p,"none");setSelectedValue(p,q)}plotsInitializedToDefaults=!1,uploadMonitors=["","",""],downloadMonitors=["","",""],updateInProgress=!1,setTimeout(resetPlots,150),updateInterval=setInterval(doUpdate,2e3)}function getEmbeddedSvgPlotFunction(a,b){return b==null&&(b=document),windowElement=getEmbeddedSvgWindow(a,b),windowElement!=null?windowElement.plotAll:null}function getMonitorId(a,b,c,d,e){var f,g=null,h="",i="",j=uciOriginal.get("gargoyle","bandwidth_display","high_res_15m");b=b==1&&c!="total"&&!c.match(/tor/)&&!c.match(/openvpn/)&&j=="1"&&!e?0:b;if(c=="total")h=e?"bdist"+b:"total"+b;else if(c.match(/qos/))a&&c.match(/up/)||!a&&c.match(/down/)?(h="qos"+b,i=d):c="none";else if(c.match(/tor/))h=e?"tor-lr"+b:"tor-hr"+b;else if(c.match(/openvpn/))h=e?"openvpn-lr"+b:"openvpn-hr"+b;else if(c=="ip"||c=="hostname")h="bdist"+b;if(c!="none")for(f=0;f<monitorNames.length&&g==null;f++){var k=monitorNames[f];(k.match("up")&&a||k.match("down")&&!a)&&(h==""||k.match(h))&&(i==""||k.match(i))&&(g=k)}return g}function getHostnameList(a){var b=[],c=0;for(c=0;c<a.length;c++){var d=a[c],e=ipToHostname[d]==null?d:ipToHostname[d];e=e.length<25?e:e.substr(0,22)+"...",b.push(e)}return b}function resetPlots(){if(!updateInProgress&&updateTotalPlot!=null&&updateUploadPlot!=null&&updateDownloadPlot!=null){updateInProgress=!0;var a=tableDownloadMonitor,b=tableUploadMonitor,c=downloadMonitors.join("\n")+"\n",d=uploadMonitors.join("\n");uploadMonitors=[],downloadMonitors=[];var e=getSelectedValue("plot_time_frame"),f=getSelectedValue("table_time_frame"),g=!1,h;for(h=1;h<=3;h++){var i=getSelectedValue("plot"+h+"_type"),j=e==1&&uciOriginal.get("gargoyle","bandwidth_display","high_res_15m")=="1";g=g||i!="total"&&i!="none"&&i!="tor"&&i!="openvpn"&&!j}for(h=1;h<=4;h++){var k=h<4?"plot"+h+"_id":"table_id",l=h<4?k:k+"_container",m=h<4?"plot"+h+"_type":"table_type",n=getSelectedValue(m),o=getSelectedValue(k);o=o==null?"":o,n=="ip"||n=="hostname"?(o.match(/^[0-9]+\./)==null&&(n=="hostname"?setAllowableSelections(k,ipsWithData,getHostnameList(ipsWithData)):setAllowableSelections(k,ipsWithData,ipsWithData),setSelectedValue(k,ipsWithData[0]),o=ipsWithData[0]==null?"":ipsWithData[0]),document.getElementById(l).style.display="block"):n=="qos-upload"?(definedUploadClasses[o]==null&&(setAllowableSelections(k,qosUploadClasses,qosUploadNames),o=qosUploadClasses[0]),document.getElementById(l).style.display="block"):n=="qos-download"?(definedDownloadClasses[o]==null&&(setAllowableSelections(k,qosDownloadClasses,qosDownloadNames),o=qosDownloadClasses[0]),document.getElementById(l).style.display="block"):document.getElementById(l).style.display="none";if(!plotsInitializedToDefaults&&n!=""&&n!="none"&&n!="total"&&n!="tor"&&n!="openvpn"){var p=bandwidthSettings.get(k,"none");p!=""&&(n=="ip"||n=="hostname")&&setAllowableSelections(k,[p],[p]),setSelectedValue(k,p),o=p}if(h!=4)uploadMonitors[h-1]=getMonitorId(!0,e,n,o,g),downloadMonitors[h-1]=getMonitorId(!1,e,n,o,g),uploadMonitors[h-1]=uploadMonitors[h-1]==null?"":uploadMonitors[h-1],downloadMonitors[h-1]=downloadMonitors[h-1]==null?"":downloadMonitors[h-1];else{var q=n=="total"&&f==4?!1:!0;f=q?f:5,tableUploadMonitor=getMonitorId(!0,f,n,o,q),tableDownloadMonitor=getMonitorId(!1,f,n,o,q),tableUploadMonitor=tableUploadMonitor==null?"":tableUploadMonitor,tableDownloadMonitor=tableDownloadMonitor==null?"":tableDownloadMonitor}}plotsInitializedToDefaults=!0,updateInProgress=!1,(d!=uploadMonitors.join("\n")||c!=downloadMonitors.join("\n")||b!=tableUploadMonitor||a!=tableDownloadMonitor)&&doUpdate(),bandwidthSettings.set("plot_time_frame",getSelectedValue("plot_time_frame")),bandwidthSettings.set("table_time_frame",getSelectedValue("table_time_frame"));for(h=1;h<=4;h++){var k=h<4?"plot"+h+"_id":"table_id",m=h<4?"plot"+h+"_type":"table_type",n=getSelectedValue(m);bandwidthSettings.set(m,n),n!=""&&n!="none"&&n!="total"?bandwidthSettings.set(k,getSelectedValue(k)):(bandwidthSettings.remove(k),bandwidthSettings.remove(m))}}else{setTimeout(resetPlots,25);if(updateTotalPlot==null||updateDownloadPlot==null||updateUploadPlot==null)updateTotalPlot=getEmbeddedSvgPlotFunction("total_plot"),updateDownloadPlot=getEmbeddedSvgPlotFunction("download_plot"),updateUploadPlot=getEmbeddedSvgPlotFunction("upload_plot")}}function parseMonitors(a){var b=[],c=a.split(/[\r\n]+/),d=parseInt(c.shift());if(""+d=="NaN")return b;var e;for(e=0;e<c.length;e++)if(c[e]!=null&&c[e].length>0&&c[e].match(/ /)){var f=c[e].split(/[\t ]+/)[0],g=c[e].split(/[\t ]+/)[1];e++;var h=c[e];e++;var i=c[e];e++;var j=c[e];if(c[e+1]!=null)if(c[e+1].match(/,/)||c[e+1].match(/^[0-9]+$/)){e++;var k=c[e].split(",");b[f]=b[f]==null?[]:b[f],b[f][g]=[k,j,d],found=1}}return b}function getDisplayIp(a){var b=a;return b!=null&&currentWanIp!=null&&currentLanIp!=null&&b!=""&&(b=b==currentWanIp?currentLanIp:b),b}function getRealIp(a){var b=a;return b!=null&&currentWanIp!=null&&currentLanIp!=null&&currentWanIp!=""&&currentLanIp!=""&&b!=""&&(b=b==currentLanIp?currentWanIp:b),b}function doUpdate(){if(!updateInProgress&&updateUploadPlot!=null&&updateDownloadPlot!=null&&updateTotalPlot!=null){updateInProgress=!0;var a=uploadMonitors.join(" ")+" "+downloadMonitors.join(" ")+" "+tableDownloadMonitor+" "+tableUploadMonitor,b=getParameterDefinition("monitor",a)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),c=function(a){if(a.readyState==4){try{clearTimeout(updateTimeoutId)}catch(b){}updateReq=null;if(a.responseText.length>0&&!a.responseText.match(/ERROR/)){var c=parseMonitors(a.responseText),d=[],e=[],f=[],g=[],h=[],i=0,j=2,k=0,l=2,m=Math.floor((new Date).getTime()/1e3),n=m,o=m;for(monitorIndex=0;monitorIndex<4;monitorIndex++){var p=!1,q;for(q=0;q<2;q++){var r=!1,s,t;if(monitorIndex<3){var u=q==0?downloadMonitors:uploadMonitors;s=q==0?e:d,t=u[monitorIndex]}else s=g,t=q==0?tableDownloadMonitor:tableUploadMonitor;t=t==null?"":t;var v=monitorIndex<3?"plot"+(monitorIndex+1)+"_type":"table_type",w=getSelectedValue(v),x=t==""?null:c[t];if(x!=null){var y="",z=[],A;for(A in x)((w=="total"||w.match("qos")||w.match("tor")||w.match("openvpn"))&&A=="COMBINED"||w!="total"&&A!="COMBINED")&&z.push(getDisplayIp(A));if(z.length>0){var B=t.split("-");monitorIndex<3?(i=B.pop(),j=B.pop()):(k=B.pop(),l=B.pop());if(t.match("bdist")&&w!="total"){var C=monitorIndex<3?"plot"+(monitorIndex+1)+"_id":"table_id";A=getSelectedValue(C),A=A==null?"":getRealIp(A),A=x[A]!=null?A:z[0],w=="hostname"?setAllowableSelections(C,z,getHostnameList(z)):setAllowableSelections(C,z,z),ipsWithData=z}else A=z[0];A=A==null?"":getRealIp(A);var D=x[A][0];monitorIndex<3?(m=x[A][1],n=x[A][2]):o=x[A][1];var E;monitorIndex<3?E=f[monitorIndex]==null?[]:f[monitorIndex]:E=h;var F;for(F=0;F<D.length;F++){var G=D.length-(1+F),H=E.length<D.length?F:E.length-D.length+F;E[H]!=null?E[H]=parseInt(E[H])+parseInt(D[G]):E.push(D[G])}monitorIndex<3&&(f[monitorIndex]=E),s.push(D),r=!0}else if(t.match("bdist")&&monitorIndex<3){var v=monitorIndex<3?"plot"+(monitorIndex+1)+"_type":"table_type",C=monitorIndex<3?"plot"+(monitorIndex+1)+"_id":"table_id";u[monitorIndex]="",setSelectedValue(v,"none"),document.getElementById(C).display="none"}}else if(t.match("bdist")&&w!="total"&&monitorIndex<3){var C=monitorIndex<3?"plot"+(monitorIndex+1)+"_id":"table_id";u[monitorIndex]="",setSelectedValue(v,"none"),document.getElementById(C).style.display="none"}r||s.push(null)}monitorIndex<3?f[monitorIndex]=f[monitorIndex]==null?null:f[monitorIndex].reverse():(h.reverse(),g.unshift(h))}updateTotalPlot(f,i,j,m,n,tzMinutes),updateDownloadPlot(e,i,j,m,n,tzMinutes),updateUploadPlot(d,i,j,m,n,tzMinutes);if(expandedFunctions["Total"]!=null){var I=expandedFunctions.Total;I(f,i,j,m,n,tzMinutes)}if(expandedFunctions["Download"]!=null){var I=expandedFunctions.Download;I(e,i,j,m,n,tzMinutes)}if(expandedFunctions["Upload"]!=null){var I=expandedFunctions.Upload;I(d,i,j,m,n,tzMinutes)}updateBandwidthTable(g,l,o)}updateInProgress=!1}},d=function(){updateInProgress=!1};updateReq=runAjax("POST","utility/load_bandwidth.sh",b,c),updateTimeoutId=setTimeout(d,5e3)}}function twod(a){var b=""+a;return b=b.length==1?"0"+b:b,b}function updateBandwidthTable(a,b,c){var d=[],e=0,f=getSelectedValue("table_units"),g=c,h=new Date;h.setTime(g*1e3),h.setUTCMinutes(h.getUTCMinutes()+tzMinutes),parseInt(b)=="NaN"&&(b.match(/month/)||b.match(/day/))&&(h=new Date(h.getTime()+108e5));var i=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];for(e=0;e<a[0].length;e++){var j=0,k=[];for(j=0;j<3;j++){var l=a[j],m=l==null?0:l[l.length-(1+e)];m=m==null?0:m,k.push(parseBytes(m,f))}var n="";b.match(/minute/)?(n=""+twod(h.getUTCHours())+":"+twod(h.getUTCMinutes()),h.setUTCMinutes(h.getUTCMinutes()-1)):b.match(/hour/)?(n=""+twod(h.getUTCHours())+":"+twod(h.getUTCMinutes()),h.setUTCHours(h.getUTCHours()-1)):b.match(/day/)?(n=i[h.getUTCMonth()]+" "+h.getUTCDate(),h.setUTCDate(h.getUTCDate()-1)):b.match(/month/)?(n=i[h.getUTCMonth()]+" "+h.getUTCFullYear(),h.setUTCMonth(h.getUTCMonth()-1)):parseInt(b)!="NaN"&&(parseInt(b)>=2419200?n=i[h.getUTCMonth()]+" "+h.getUTCFullYear()+" "+twod(h.getUTCHours())+":"+twod(h.getUTCMinutes()):parseInt(b)>=86400?n=i[h.getUTCMonth()]+" "+twod(h.getUTCHours())+":"+twod(h.getUTCMinutes()):n=""+twod(h.getUTCHours())+":"+twod(h.getUTCMinutes()),h.setTime(h.getTime()-parseInt(b)*1e3)),k.unshift(n),d.push(k),g=h.getTime()/1e3}var o=["时间","总量","下载","上传"],p=createTable(o,d,"bandwidth_table",!1,!1);tableContainer=document.getElementById("bandwidth_table_container"),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild),tableContainer.appendChild(p)}function expand(a){var b=expandedWindows[a],c=0,d=0;if(typeof b!="undefined"){try{b.close()}catch(e){}b=null}try{c=window.screenX+225,d=window.screenY+225}catch(e){c=window.left+225,d=window.top+225}b=window.open("bandwidth_expand.sh",a+" Bandwidth Plot","width=850,height=650,left="+c+",top="+d),expandedWindows[a]=b;var f=function(a){var b=!1,c=expandedWindows[a];if(c.document!=null&&c.document.getElementById("bandwidth_plot")!=null){var d=c.document.getElementById("plot_title");d!=null&&(expandedFunctions[a]=getEmbeddedSvgPlotFunction("bandwidth_plot",c.document),expandedFunctions[a]!=null&&(d.appendChild(c.document.createTextNode(a+" Bandwidth Usage")),c.onbeforeunload=function(){expandedFunctions[a]=null,expandedWindows[a]=null},b=!0))}if(!b){var e=function(){f(a)};setTimeout(e,250)}};f(a)}function highResChanged(){setControlsEnabled(!1,!0,"Resetting Graphs...");var a=document.getElementById("use_high_res_15m").checked,b=[];b.push("uci set gargoyle.bandwidth_display=bandwidth_display"),b.push("uci set gargoyle.bandwidth_display.high_res_15m="+(a?"1":"0")),b.push("uci commit"),b.push("/etc/init.d/bwmon_gargoyle restart");var c=function(a){a.readyState==4&&(window.location=window.location,setControlsEnabled(!0))},d=getParameterDefinition("commands",b.join("\n"))+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,""));runAjax("POST","utility/run_commands.sh",d,c)}var ipMonitorIds,qosUploadMonitorIds,qosDownloadMonitorIds,uploadMonitors=null,downloadMonitors=null,tableUploadMonitor=null,tableDownloadMonitor=null,ipsWithData=[],qosDownloadClasses=[],qosDownloadNames=[],qosUploadClasses=[],qosUploadNames=[],definedUploadClasses=[],definedDownloadClasses=[],updateTotalPlot=null,updateUploadPlot=null,updateDownloadPlot=null,updateInProgress=!1,plotsInitializedToDefaults=!1,expandedWindows=[],expandedFunctions=[],updateInterval=null;window.onbeforeunload=stopInterval,bandwidthSettings=new BandwidthCookieContainer;var updateReq=null,updateTimeoutId=null;