function saveChanges(){setControlsEnabled(!1,!0);var a=!1,b=[],c=["restriction_rule","whitelist_rule"],d=["rule_","exception_"],e=0,f=[],g=[];for(e=0;e<c.length;e++){var h=document.getElementById(d[e]+"table_container"),i=h.firstChild,j=getTableDataArray(i);for(ruleIndex=0;ruleIndex<j.length;ruleIndex++){var k=j[ruleIndex][1];a=a||k.checked,uci.set(pkg,k.id,"enabled",k.checked?"1":"0")}var l=uciOriginal.getAllSectionsOfType(pkg,c[e]),m=0;for(m=0;m<l.length;m++){var n=uciOriginal.get(pkg,l[m],"is_ingress");n!="1"&&(uciOriginal.removeSection(pkg,l[m]),f.push("uci del "+pkg+"."+l[m]))}var o=uci.getAllSectionsOfType(pkg,c[e]);for(m=0;m<o.length;m++)g.push("uci set "+pkg+"."+o[m]+"='"+c[e]+"'")}f.push("uci commit"),g.push("uci commit");var p=f.join("\n")+"\n"+g.join("\n")+"\n"+uci.getScriptCommands(uciOriginal)+"\n"+b.join("\n")+"\n"+"sh /usr/lib/gargoyle/restart_firewall.sh",q=getParameterDefinition("commands",p)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),r=function(a){a.readyState==4&&(uciOriginal=uci.clone(),resetData(),setControlsEnabled(!0))};runAjax("POST","utility/run_commands.sh",q,r)}function resetData(){var a=["restriction_rule","whitelist_rule"],b=["rule_","exception_"],c=0;for(c=0;c<a.length;c++){var d=a[c],e=b[c],f=uciOriginal.getAllSectionsOfType(pkg,d),g=new Array,h=[],i=[];for(sectionIndex=0;sectionIndex<f.length;sectionIndex++){var j=uciOriginal.get(pkg,f[sectionIndex],"is_ingress");if(j!="1"){var k=uciOriginal.get(pkg,f[sectionIndex],"description");k=k==""?f[sectionIndex]:k;var l=uciOriginal.get(pkg,f[sectionIndex],"enabled"),m=l==""||l=="1"||l=="true",n=createEnabledCheckbox(m);n.id=f[sectionIndex],h.push(n),i.push(m),g.push([k,n,createEditButton(m)])}}var o=d=="restriction_rule"?"规则说明":"例外说明";columnNames=[o,"已启用",""],ruleTable=createTable(columnNames,g,e+"table",!0,!1,removeRuleCallback),tableContainer=document.getElementById(e+"table_container"),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild),tableContainer.appendChild(ruleTable);while(h.length>0){var p=h.shift(),q=i.shift();p.checked=q}setDocumentFromUci(document,new UCIContainer,"",d,e),setVisibility(document,e)}}function addNewRule(a,b){var c=validateRule(document,b);if(c.length>0)alert(c.join("\n")+"\nCould not add rule.");else{var d=document.getElementById(b+"table_container"),e=d.firstChild,f=getTableDataArray(e),g=f.length+1,h=b+""+g;while(uci.get(pkg,h,"")!="")g++,h=b+""+g;setUciFromDocument(document,h,a,b);var i=uci.get(pkg,h,"description");i=i==""?h:i;var j=createEnabledCheckbox(!0);j.id=h,addTableRow(e,[i,j,createEditButton(!0)],!0,!1,removeRuleCallback),setDocumentFromUci(document,new UCIContainer,"",a,b),j.checked=!0}}function setVisibility(a,b){a=a==null?document:a,setInvisibleIfAnyChecked([b+"all_access"],b+"resources","block",a),setInvisibleIfAnyChecked([b+"all_day"],b+"hours_active_container","block",a),setInvisibleIfAnyChecked([b+"every_day"],b+"days_active","block",a),setInvisibleIfAnyChecked([b+"all_day",b+"every_day"],b+"days_and_hours_active_container","block",a),setInvisibleIfAnyChecked([b+"all_day",b+"every_day"],b+"schedule_repeats","inline",a);var c=a.getElementById(b+"schedule_repeats");c.style.display!="none"&&(setInvisibleIfIdMatches(b+"schedule_repeats","daily",b+"days_and_hours_active_container","block",a),setInvisibleIfIdMatches(b+"schedule_repeats","weekly",b+"days_active","block",a),setInvisibleIfIdMatches(b+"schedule_repeats","weekly",b+"hours_active_container","block",a)),setInvisibleIfIdMatches(b+"applies_to","all",b+"applies_to_container","block",a),setInvisibleIfIdMatches(b+"remote_ip_type","all",b+"remote_ip_container","block",a),setInvisibleIfIdMatches(b+"remote_port_type","all",b+"remote_port","inline",a),setInvisibleIfIdMatches(b+"local_port_type","all",b+"local_port","inline",a),setInvisibleIfIdMatches(b+"app_protocol_type","all",b+"app_protocol","inline",a),setInvisibleIfIdMatches(b+"url_type","all",b+"url_match_list","block",a)}function setInvisibleIfAnyChecked(a,b,c,d){d=d==null?document:d,c=c==null?"block":c;var e=d.getElementById(b),f=!1;for(checkIndex=0;checkIndex<a.length;checkIndex++){var g=d.getElementById(a[checkIndex]);g!=null&&(f=f||g.checked)}f&&e!=null?e.style.display="none":e!=null&&(e.style.display=c)}function setInvisibleIfIdMatches(a,b,c,d,e){e=e==null?document:e,d=d==null?"restriction_rule":d;var f=e.getElementById(c);getSelectedValue(a,e)==b&&f!=null?f.style.display="none":f!=null&&(f.style.display=d)}function createEnabledCheckbox(a){return enabledCheckbox=createInput("checkbox"),enabledCheckbox.onclick=setRowEnabled,enabledCheckbox.checked=a,enabledCheckbox}function createEditButton(a,b,c){return editButton=createInput("button"),editButton.value="编辑",editButton.className="default_button",editButton.onclick=editRule,editButton.className=a?"default_button":"default_button_disabled",editButton.disabled=a?!1:!0,editButton}function setRowEnabled(){enabled=this.checked?"1":"0",enabledRow=this.parentNode.parentNode,enabledId=this.id,enabledRow.childNodes[2].firstChild.disabled=this.checked?!1:!0,enabledRow.childNodes[2].firstChild.className=this.checked?"default_button":"default_button_disabled",uci.set(pkg,enabledId,"enabled",enabled)}function removeRuleCallback(a,b){var c=b.childNodes[1].firstChild.id;uci.removeSection(pkg,c)}function editRule(){editRow=this.parentNode.parentNode,editTable=editRow.parentNode.parentNode,editTable.id.match("rule_")?(editRuleType="restriction_rule",editRulePrefix="rule_"):(editRuleType="whitelist_rule",editRulePrefix="exception_");if(typeof editRuleWindow!="undefined")try{editRuleWindow.close()}catch(a){}try{xCoor=window.screenX+225,yCoor=window.screenY+225}catch(a){xCoor=window.left+225,yCoor=window.top+225}editRuleWindow=window.open(editRuleType=="restriction_rule"?"restriction_edit_rule.sh":"whitelist_edit_rule.sh","edit","width=560,height=600,left="+xCoor+",top="+yCoor),saveButton=createInput("button",editRuleWindow.document),closeButton=createInput("button",editRuleWindow.document),saveButton.value="关闭且保存设置",saveButton.className="default_button",closeButton.value="关闭不保存设置",closeButton.className="default_button",editRuleSectionId=editRow.childNodes[1].firstChild.id,runOnEditorLoaded=function(){updateDone=!1,editRuleWindow.document!=null&&editRuleWindow.document.getElementById("bottom_button_container")!=null&&(editRuleWindow.document.getElementById("bottom_button_container").appendChild(saveButton),editRuleWindow.document.getElementById("bottom_button_container").appendChild(closeButton),setDocumentFromUci(editRuleWindow.document,uci,editRuleSectionId,editRuleType,editRulePrefix),setVisibility(editRuleWindow.document,editRulePrefix),closeButton.onclick=function(){editRuleWindow.close()},saveButton.onclick=function(){var a=validateRule(editRuleWindow.document,editRulePrefix);a.length>0?alert(a.join("\n")+"\nCould not add rule."):(setUciFromDocument(editRuleWindow.document,editRuleSectionId,editRuleType,editRulePrefix),uci.get(pkg,editRuleSectionId,"description")!=""&&(editRow.childNodes[0].firstChild.data=uci.get(pkg,editRuleSectionId,"description")),editRuleWindow.close())},editRuleWindow.moveTo(xCoor,yCoor),editRuleWindow.focus(),updateDone=!0),updateDone||setTimeout("runOnEditorLoaded()",250)},runOnEditorLoaded()}function addAddressesToTable(a,b,c,d,e){a=a==null?document:a;var f=a.getElementById(b).value,g=e?validateMultipleIpsOrMacs(f):validateMultipleIps(f);if(g==0){var h=a.getElementById(c),i=h.childNodes.length>0?h.firstChild:createTable([""],[],d,!0,!1);f=f.replace(/^[\t ]*/,""),f=f.replace(/[\t ]*$/,"");var j=f.split(/[\t ]*,[\t ]*/);while(j.length>0)addTableRow(i,[j.shift()],!0,!1);h.childNodes.length==0&&h.appendChild(i),a.getElementById(b).value=""}else alert("ERROR: Invalid Address\n")}function addUrlToTable(a,b,c,d,e){a=a==null?document:a;var f=a.getElementById(b).value,g=getSelectedValue(c,a),h=validateUrl(f,c,a);if(h==0){var i=createUrlSpan(f,a),j=a.getElementById(d),k=j.childNodes.length>0?j.firstChild:createTable(["URL结构","匹配类型","匹配文本/表达式"],[],e,!0,!1);addTableRow(k,[g.match("domain")?"domain":"full",g.substring(g.lastIndexOf("_")+1),i],!0,!1),j.childNodes.length==0&&j.appendChild(k),a.getElementById(b).value=""}else f.length==0?alert("ERROR: URL match length must be greater than zero"):alert("ERROR: URL match cannot contain quote or newline characters\n")}function validateRule(a,b){a=a==null?document:a;var c=[b+"hours_active",b+"days_and_hours_active",b+"remote_port",b+"local_port"],d=[b+"hours_active_label",b+"days_and_hours_active_label",b+"remote_port_label",b+"local_port_label"],e=[validateHours,validateWeeklyRange,validateMultiplePorts,validateMultiplePorts],f=[0,0,0,0],g=[b+"hours_active_container",b+"days_and_hours_active_container",b+"remote_port",b+"local_port"];return a.getElementById(b+"all_access").checked&&(g[2]=b+"resources",g[3]=b+"resources"),proofreadFields(c,d,e,f,g,a)}function validateMultipleIps(a){a=a.replace(/^[\t ]+/g,""),a=a.replace(/[\t ]+$/g,"");var b=a.split(/[\t ]*,[\t ]*/),c=b.length>0?0:1;while(c==0&&b.length>0){var d=b.pop();if(d.match(/-/)){var e=d.split(/[\t ]*-[\t ]*/);c=e.length==2&&validateIP(e[0])==0&&validateIP(e[1])==0?0:1}else c=validateIpRange(d)}return c}function proofreadMultipleIps(a){proofreadText(a,validateMultipleIps,0)}function proofreadMultipleIpsOrMacs(a){proofreadText(a,validateMultipleIpsOrMacs,0)}function validateMultipleIpsOrMacs(a){var b=a.replace(/^[\t ]+/g,"");b=b.replace(/[\t ]+$/g,"");var c=b.split(/[\t ]*,[\t ]*/),d=c.length>0?0:1;while(d==0&&c.length>0){var e=c.pop();if(e.match(/-/)){var f=e.split(/[\t ]*-[\t ]*/);d=f.length==2&&validateIP(f[0])==0&&validateIP(f[1])==0?0:1}else e.match(/:/)?d=validateMac(e):d=validateIpRange(e)}return d}function validateMultiplePorts(a){a=a.replace(/^[\t ]+/g,""),a=a.replace(/[\t ]+$/g,"");var b=a.match(/,/)?a.split(/[\t ]*,[\t ]*/):[a],c=!0;for(splitIndex=0;splitIndex<b.length;splitIndex++)b[splitIndex].replace(/^[\t ]+/g,""),b[splitIndex].replace(/[\t ]+$/g,""),c=c&&validatePortOrPortRange(b[splitIndex])==0;return c?0:1}function proofreadMultiplePorts(a){proofreadText(a,validateMultiplePorts,0)}function validateUrl(a,b,c){c=c==null?document:c;var d=getSelectedValue(b,c),e=a.match(/[\n\r\"\']/)||a.length==0?1:0;return e}function proofreadUrl(a){proofreadText(a,validateUrl,0)}function createUrlSpan(a,b){b=b==null?document:b;var c=[];while(a.length>0){var d=a.substr(0,30);a=a.substr(30),c.push(a.length>0?d+"-":d)}var e=b.createElement("span");while(c.length>0)e.appendChild(b.createTextNode(c.shift())),c.length>0&&e.appendChild(b.createElement("br"));return e}function parseUrlSpan(a){var b=a.childNodes,c="";for(childIndex=0;childIndex<b.length;childIndex++)if(childIndex%2==0){var d=b[childIndex].data;childIndex<b.length-1&&(d=d.substr(0,d.length-1)),c+=d}return c}function setDocumentFromUci(a,b,c,d,e){a=a==null?document:a;var f=b.get(pkg,c,"description");f=f==""?c:f,a.getElementById(e+"name").value=f,setIpTableAndSelectFromUci(a,b,pkg,c,"local_addr",e+"applies_to_table_container",e+"applies_to_table",e+"applies_to",e+"applies_to_addr");var g=b.get(pkg,c,"active_weekly_ranges"),h=b.get(pkg,c,"active_hours"),i=g==""&&h=="";a.getElementById(e+"hours_active").value=h,a.getElementById(e+"all_day").checked=i,a.getElementById(e+"days_and_hours_active").value=g,setSelectedValue(e+"schedule_repeats",g==""?"daily":"weekly",a);var j=["sun","mon","tue","wed","thu","fri","sat"],k=b.get(pkg,c,"active_weekdays"),l=[];k==""?l=j:l=k.split(/,/);var m=g=="",n=0;for(n=0;n<j.length;n++){var o=j[n],p=!1,q=0;for(q=0;q<l.length&&!p;q++)p=l[q]==o;m=m&&p,a.getElementById(e+j[n]).checked=p}a.getElementById(e+"every_day").checked=m,setIpTableAndSelectFromUci(a,b,pkg,c,"remote_addr",e+"remote_ip_table_container",e+"remote_ip_table",e+"remote_ip_type",e+"remote_ip"),setTextAndSelectFromUci(a,b,pkg,c,"remote_port",e+"remote_port",e+"remote_port_type"),setTextAndSelectFromUci(a,b,pkg,c,"local_port",e+"local_port",e+"local_port_type");var r=b.get(pkg,c,"proto");r=r!="tcp"&&r!="udp"?"both":r,setSelectedValue(e+"transport_protocol",r,a);var s=b.get(pkg,c,"app_proto"),t=s==""?"except":"only";s=s==""?b.get(pkg,c,"not_app_proto"):s,t=s==""?"all":t,setSelectedValue(e+"app_protocol_type",t,a),setSelectedValue(e+"app_protocol",s,a);var u=["url_contains","url_regex","url_exact","url_domain_contains","url_domain_regex","url_domain_exact"],v=["contains","regex","exact","contains","regex","exact"],w=["full","full","full","domain","domain","domain"],x="",y=[],z=!1,A=0,B="all";for(A=0;A<u.length;A++)y[A]=b.get(pkg,c,u[A]),z=y[A]!=""?!0:z,B=y[A]!=""?"only":B;if(!z){x="not_";for(A=0;A<u.length;A++)y[A]=b.get(pkg,c,x+u[A]),z=y[A]!=""?!0:z,B=y[A]!=""?"except":B}setSelectedValue(e+"url_type",B,a);var C=a.getElementById(e+"url_match_table_container");C.childNodes.length>0&&C.removeChild(C.firstChild);if(z){var D=createTable(["URL Part","Match Type","Match Text / Expression"],[],e+"url_match_table",!0,!1,null,null,a);for(A=0;A<u.length;A++){var E=y[A];if(E!=""){E=E.replace(/^[\t ]*\"/,""),E=E.replace(/\"[\t ]*$/,""),def=E.match(/\".*\"/)?E.split(/\"[\t, ]*\"/):[E];var F=0;for(F=0;F<def.length;F++)addTableRow(D,[w[A],v[A],createUrlSpan(def[F],a)],!0,!1,null,null,a)}}C.appendChild(D)}a.getElementById(e+"url_match").value="";var G=!0,H=["remote_ip_type","remote_port_type","local_port_type","transport_protocol","app_protocol_type","url_type"];for(typeIndex=0;typeIndex<H.length;typeIndex++){var I=getSelectedValue(e+H[typeIndex],a);G=G&&(I=="all"||I=="both")}a.getElementById(e+"all_access").checked=G,setVisibility(a,e)}function setIpTableAndSelectFromUci(a,b,c,d,e,f,g,h,i){a=a==null?document:a;var j=b.get(c,d,e),k="only";j==""&&(j=b.get(c,d,"not_"+e),k=j!=""?"except":"all"),setSelectedValue(h,k,a);var l=a.getElementById(f);l.childNodes.length>0&&l.removeChild(l.firstChild);if(j!=""){j=j.replace(/^[\t ]*/,""),j=j.replace(/[\t ]*$/,"");var m=j.split(/[\t ]*,[\t ]*/),n=createTable([""],[],g,!0,!1,null,null,a);while(m.length>0)addTableRow(n,[m.shift()],!0,!1,null,null,a);l.appendChild(n),a.getElementById(i).value=""}}function setTextAndSelectFromUci(a,b,c,d,e,f,g){a=a==null?document:a;var h=b.get(c,d,e),i="only";h==""&&(h=b.get(c,d,"not_"+e),i=h!=""?"except":"all"),setSelectedValue(g,i,a),a.getElementById(f).value=h}function setUciFromDocument(a,b,c,d){uci.removeSection(pkg,b),uci.set(pkg,b,"",c),uci.set(pkg,b,"is_ingress","0"),a=a==null?document:a,uci.set(pkg,b,"",c),uci.set(pkg,b,"description",a.getElementById(d+"name").value),setFromIpTable(a,pkg,b,"local_addr",d+"applies_to_table_container",d+"applies_to");var e=a.getElementById(d+"days_active");if(e.style.display!="none"){var e=[],f=["sun","mon","tue","wed","thu","fri","sat"];for(dayIndex=0;dayIndex<f.length;dayIndex++)a.getElementById(d+f[dayIndex]).checked&&e.push(f[dayIndex]);daysActiveStr=e.join(","),uci.set(pkg,b,"active_weekdays",daysActiveStr)}setIfVisible(a,pkg,b,"active_hours",d+"hours_active"),setIfVisible(a,pkg,b,"active_weekly_ranges",d+"days_and_hours_active");if(!a.getElementById(d+"all_access").checked){setFromIpTable(a,pkg,b,"remote_addr",d+"remote_ip_table_container",d+"remote_ip_type"),setIfVisible(a,pkg,b,"remote_port",d+"remote_port",d+"remote_port_type"),setIfVisible(a,pkg,b,"local_port",d+"local_port",d+"local_port_type"),uci.set(pkg,b,"proto",getSelectedValue(d+"transport_protocol",a));var g=getSelectedValue(d+"app_protocol_type",a);if(g!="all"){var h=g=="except"?"not_":"";uci.set(pkg,b,h+"app_proto",getSelectedValue(d+"app_protocol",a))}var i=getSelectedValue(d+"url_type",a),j=a.getElementById(d+"url_match_table_container").firstChild;if(i!="all"&&j!=null){var k=getTableDataArray(j,!0,!1),l=i=="except"?"not_":"",m=[],n;for(n=0;n<k.length;n++){var o=k[n][0];o=(o.match("domain")?"url_domain_":"url_")+k[n][1],urlStr=parseUrlSpan(k[n][2]),m[o]!=null?m[o]=m[o]+',"'+urlStr+'"':m[o]='"'+urlStr+'"'}var p=["url_","url_domain_"],q=["exact","contains","regex"],r=0,s=0;for(r=0;r<2;r++)for(s=0;s<3;s++){var t=p[r]+q[s];m[t]!=null&&uci.set(pkg,b,l+t,m[t])}}}}function setIfVisible(a,b,c,d,e,f){a=a==null?document:a;var g=a.getElementById(e);g.style.display!="none"&&(f!=null&&(prefixValue=getSelectedValue(f,a),d=prefixValue=="except"?"not_"+d:d),uci.set(b,c,d,g.value))}function setFromIpTable(a,b,c,d,e,f){a=a==null?document:a;var g=getSelectedValue(f,a),h=a.getElementById(e).firstChild;if(g!="all"&&h!=null){var i=getTableDataArray(h,!0,!1),j="";for(ipIndex=0;ipIndex<i.length;ipIndex++)j=j+i[ipIndex][0]+",";j=j.replace(/,$/,"");if(j.length>0){var k=g=="except"?"not_":"";uci.set(b,c,k+d,j)}}}var pkg="firewall";