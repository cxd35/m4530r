/*
 * This program is copyright ï¿½ 2008-2010 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){errorList=proofreadAll();if(errorList.length>0)errorString=errorList.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{setControlsEnabled(!1,!0);var a=uciOriginal.getAllSections("dropbear"),b=uciOriginal.get("dropbear",a[0],"Port"),c=uciOriginal.get("httpd_gargoyle","server","https_port"),d=uciOriginal.get("httpd_gargoyle","server","http_port"),e=[],f=uciOriginal.getAllSectionsOfType("firewall","remote_accept");while(f.length>0){var g=f.pop(),h=uciOriginal.get("firewall",g,"local_port");if(h==b||h==c||h==d)uciOriginal.removeSection("firewall",g),e.push("uci del firewall."+g)}var i=uciOriginal.clone(),j=function(a,b){var c="ra_"+a+"_"+b;i.set("firewall",c,"","remote_accept"),i.set("firewall",c,"local_port",a),i.set("firewall",c,"remote_port",b),i.set("firewall",c,"proto","tcp"),i.set("firewall",c,"zone","wan"),e.push("uci set firewall."+c+"=remote_accept")};document.getElementById("remote_https_port_container").style.display!="none"&&j(document.getElementById("local_https_port").value,document.getElementById("remote_https_port").value),document.getElementById("remote_http_port_container").style.display!="none"&&j(document.getElementById("local_http_port").value,document.getElementById("remote_http_port").value),document.getElementById("remote_ssh_port").disabled||j(document.getElementById("local_ssh_port").value,document.getElementById("remote_ssh_port").value);var k=document.getElementById("local_ssh_port").value,l=document.getElementById("remote_ssh_attempts").disabled?"":getSelectedValue("remote_ssh_attempts"),m=[];if(a[0]!="global"){for(s=0;s<a.length;s++)m.push("uci del dropbear.@dropbear[0]");m.push("uci set dropbear.global=dropbear"),m.push("uci set dropbear.global.PasswordAuth='on'"),m.push("uci set dropbear.global.Port="+k),l!=""&&m.push("uci set dropbear.global.max_remote_attempts='"+l+"'"),m.push("uci commit")}else i.set("dropbear","global","Port",k),l!=""&&i.set("dropbear","global","max_remote_attempts",l);dropbearRestart=b==document.getElementById("local_ssh_port").value?"":"/etc/init.d/dropbear restart\n",document.getElementById("disable_web_password").checked?i.set("gargoyle","global","require_web_password","0"):i.set("gargoyle","global","require_web_password","1"),i.set("gargoyle","global","session_timeout",getSelectedValue("session_length")),localWebProtocol=getSelectedValue("local_web_protocol"),i.set("httpd_gargoyle","server","web_protocol",localWebProtocol),(localWebProtocol=="https"||localWebProtocol=="both")&&i.set("httpd_gargoyle","server","https_port",document.getElementById("local_https_port").value),(localWebProtocol=="http"||localWebProtocol=="both")&&i.set("httpd_gargoyle","server","http_port",document.getElementById("local_http_port").value),passwordCommands="",newPassword=document.getElementById("password1").value;if(newPassword!=""){var n=newPassword.replace(/'/,"'\"'\"'");passwordCommands="(echo '"+n+"' ; sleep 1 ; echo '"+n+"') | passwd root \n",dropBearRestart="/etc/init.d/dropbear restart\n"}restartFirewallCommand="\nsh /usr/lib/gargoyle/restart_firewall.sh ;\n",commands=passwordCommands+"\n"+e.join("\n")+"\n"+m.join("\n")+"\n"+i.getScriptCommands(uciOriginal)+"\n"+restartFirewallCommand+"\n"+dropbearRestart+"\nkillall httpd_gargoyle\n/etc/init.d/httpd_gargoyle restart\n",stopRedirect=!1;var o=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),p=function(a){a.readyState==4&&(setControlsEnabled(!0),stopRedirect=!0)};runAjax("POST","utility/run_commands.sh",o,p),doRedirect=function(){stopRedirect||(currentProtocol=location.href.match(/^https:/)?"https":"http",otherProtocol=currentProtocol=="https"?"http":"https",destinationProtocol=localWebProtocol=="both"||localWebProtocol==currentProtocol?currentProtocol:otherProtocol,destinationPort=document.getElementById("local_"+destinationProtocol+"_port").value,accessPage=uciOriginal.get("gargoyle","global","bin_root")+"/"+uciOriginal.get("gargoyle","scripts","system_access"),window.location=destinationProtocol+"://"+currentLanIp+":"+destinationPort+"/"+accessPage)},setTimeout("doRedirect()",15e3)}}function proofreadAll(){controlIds=["local_https_port","local_http_port","local_ssh_port","remote_https_port","remote_http_port","remote_ssh_port"],validatePort=function(a){return validateNumericRange(a,1,65535)},labelIds=[],functions=[],returnCodes=[],visibilityIds=[];for(idIndex=0;idIndex<controlIds.length;idIndex++)id=controlIds[idIndex],labelIds.push(id+"_label"),functions.push(validatePort),returnCodes.push(0),visibilityIds.push(id.match(/ssh/)?id:id+"_container");errors=proofreadFields(controlIds,labelIds,functions,returnCodes,visibilityIds),localIds=["local_https_port","local_http_port","local_ssh_port"],remoteIds=["remote_https_port","remote_http_port","remote_ssh_port"];for(localIndex=0;localIndex<localIds.length;localIndex++){localValue=document.getElementById(localIds[localIndex]).value;for(remoteIndex=0;remoteIndex<remoteIds.length;remoteIndex++)remoteValue=document.getElementById(remoteIds[remoteIndex]).value,remoteIndex!=localIndex&&remoteValue==localValue&&remoteValue!=""&&document.getElementById(remoteIds[remoteIndex]).disabled==0&&(localName=document.getElementById(localIds[localIndex]+"_label").firstChild.data.replace(/:/,""),remoteName=document.getElementById(remoteIds[remoteIndex]+"_label").firstChild.data.replace(/:/,""),errors.push(remoteName+" cannot be "+localName));for(localIndex2=0;localIndex2<localIds.length;localIndex2++)localValue2=document.getElementById(localIds[localIndex2]).value,localIndex2!=localIndex&&localValue2==localValue&&localValue2!=""&&document.getElementById(localIds[localIndex2]).disabled==0&&(localName=document.getElementById(localIds[localIndex]+"_label").firstChild.data.replace(/:/,""),localName2=document.getElementById(localIds[localIndex2]+"_label").firstChild.data.replace(/:/,""),errors.push(localName+" cannot be "+localName2))}return pass1=document.getElementById("password1").value,pass2=document.getElementById("password2").value,(pass1!=""||pass2!="")&&pass1!=pass2&&errors.push("Administrator password cannot be confirmed. Specified passwords are not equal."),errors}function resetData(){document.getElementById("disable_web_password").checked=uciOriginal.get("gargoyle","global","require_web_password")=="0"?!0:!1,setSelectedValue("session_length",uciOriginal.get("gargoyle","global","session_timeout")),httpsPort=uciOriginal.get("httpd_gargoyle","server","https_port"),httpPort=uciOriginal.get("httpd_gargoyle","server","http_port"),localProtocol=uciOriginal.get("httpd_gargoyle","server","web_protocol"),setSelectedValue("local_web_protocol",localProtocol);if(localProtocol=="https"||localProtocol=="both")document.getElementById("local_https_port").value=httpsPort;if(localProtocol=="http"||localProtocol=="both")document.getElementById("local_http_port").value=httpPort;var a=uciOriginal.getAllSections("dropbear"),b=uciOriginal.get("dropbear",a[0],"Port"),c=uciOriginal.get("dropbear",a[0],"max_remote_attempts");c=c==""?10:c,setSelectedValue("remote_ssh_attempts",c),document.getElementById("local_ssh_port").value=b;var d="",e="",f="",g=uciOriginal.getAllSectionsOfType("firewall","remote_accept"),h=0;for(h=0;h<g.length;h++){var i=g[h],j=uciOriginal.get("firewall",i,"local_port"),k=uciOriginal.get("firewall",i,"remote_port"),l=uciOriginal.get("firewall",i,"proto").toLowerCase(),m=uciOriginal.get("firewall",i,"zone").toLowerCase();(m=="wan"||m=="")&&(l=="tcp"||l=="")&&(k=k==""?j:k,j==httpsPort?d=k:j==httpPort?e=k:j==b&&(f=k))}allOptionValueHash=getRemoteOptionValueHash(),setSelectElementOptions("remote_web_protocol",["both","https","http","disabled"],allOptionValueHash);if(!isBridge(uciOriginal))d!=""&&e!=""?setSelectedValue("remote_web_protocol","both"):d!=""?setSelectedValue("remote_web_protocol","https"):e!=""?setSelectedValue("remote_web_protocol","http"):setSelectedValue("remote_web_protocol","disabled"),document.getElementById("remote_https_port").value=d,document.getElementById("remote_http_port").value=e,document.getElementById("remote_ssh_port").value=f,f!=""?document.getElementById("remote_ssh_enabled").checked=!0:document.getElementById("remote_ssh_enabled").checked=!1;else{setSelectedValue("remote_web_protocol","disabled"),document.getElementById("remote_ssh_enabled").checked=!1;var n=["remote_web_protocol_container","remote_web_ports_container","remote_ssh_enabled_container","remote_ssh_port_container"],o;for(o=0;o<n.length;o++)document.getElementById(n[o]).style.display="none"}document.getElementById("password1").value="",document.getElementById("password2").value="",updateVisibility()}function updateVisibility(){localWebProtocol=getSelectedValue("local_web_protocol"),localHttpsElement=document.getElementById("local_https_port"),localHttpElement=document.getElementById("local_http_port"),allOptionValueHash=getRemoteOptionValueHash(),localWebProtocol=="both"?(localHttpsElement.value=localHttpsElement.value==""?443:localHttpsElement.value,localHttpElement.value=localHttpElement.value==""?80:localHttpElement.value,setSelectElementOptions("remote_web_protocol",["both","https","http","disabled"],allOptionValueHash)):localWebProtocol=="https"?(localHttpsElement.value=localHttpsElement.value==""?443:localHttpsElement.value,localHttpElement.value="",oldSelection=getSelectedValue("remote_web_protocol"),setSelectElementOptions("remote_web_protocol",["https","disabled"],allOptionValueHash),oldSelection=="http"&&setSelectedValue("remote_web_protocol","disabled")):(localHttpsElement.value="",localHttpElement.value=localHttpElement.value==""?80:localHttpElement.value,oldSelection=getSelectedValue("remote_web_protocol"),setSelectElementOptions("remote_web_protocol",["http","disabled"],allOptionValueHash),oldSelection=="https"&&setSelectedValue("remote_web_protocol","disabled")),remoteWebProtocol=getSelectedValue("remote_web_protocol"),remoteHttpsElement=document.getElementById("remote_https_port"),remoteHttpElement=document.getElementById("remote_http_port"),remoteWebProtocol=="both"?(remoteHttpsElement.value=remoteHttpsElement.value==""?localHttpsElement.value:remoteHttpsElement.value,remoteHttpElement.value=remoteHttpElement.value==""?localHttpElement.value:remoteHttpElement.value):remoteWebProtocol=="https"?(remoteHttpsElement.value=remoteHttpsElement.value==""?localHttpsElement.value:remoteHttpsElement.value,remoteHttpElement.value=""):remoteWebProtocol=="http"?(remoteHttpsElement.value="",remoteHttpElement.value=remoteHttpElement.value==""?localHttpElement.value:remoteHttpElement.value):(remoteHttpsElement.value="",remoteHttpElement.value=""),ids=["local_https_port","local_http_port","remote_https_port","remote_http_port"],visIds=[],vis=[];for(idIndex=0;idIndex<ids.length;idIndex++)visIds.push(ids[idIndex]+"_container"),vis.push(document.getElementById(ids[idIndex]).value!=""?!0:!1);setVisibility(visIds,vis);var a=uciOriginal.getAllSections("dropbear"),b=uciOriginal.get("dropbear",a[0],"max_remote_attempts");b=b==""?10:b,enableAssociatedField(document.getElementById("remote_ssh_enabled"),"remote_ssh_port",document.getElementById("local_ssh_port").value),enableAssociatedField(document.getElementById("remote_ssh_enabled"),"remote_ssh_attempts",b)}function setSelectElementOptions(a,b,c){originalSelection=getSelectedValue(a),removeAllOptionsFromSelectElement(document.getElementById(a));for(addIndex=0;addIndex<b.length;addIndex++)optionValue=b[addIndex],addOptionToSelectElement(a,c[optionValue],optionValue);setSelectedValue(a,originalSelection)}function getRemoteOptionValueHash(){return allOptionValueHash=new Array,allOptionValueHash.both="HTTPS & HTTP",allOptionValueHash.https="HTTPS",allOptionValueHash.http="HTTP",allOptionValueHash.disabled="Disabled",allOptionValueHash}var stopRedirect=!1;