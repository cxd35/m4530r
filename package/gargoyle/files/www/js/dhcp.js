/*
 * This program is copyright � 2008-2010 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){errorList=proofreadAll();if(errorList.length>0)errorString=errorList.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{setControlsEnabled(!1,!0),uci=uciOriginal.clone(),uci.remove("dhcp",dhcpSection,"ignore"),uci.set("dhcp",dhcpSection,"interface","lan"),dhcpIds=["dhcp_start",["dhcp_start","dhcp_end"],"dhcp_lease"],dhcpVisIds=["dhcp_start","dhcp_end","dhcp_lease"],dhcpPkgs=["dhcp","dhcp","dhcp"],dhcpSections=[dhcpSection,dhcpSection,dhcpSection],dhcpOptions=["start","limit","leasetime"],dhcpFunctions=[setVariableFromValue,setVariableFromCombined,setVariableFromModifiedValue],limitParams=[!1,function(a){return parseInt(a[1])-parseInt(a[0])}],leaseParams=[!1,function(a){return a+"h"}],dhcpParams=[!1,limitParams,leaseParams],setVariables(dhcpIds,dhcpVisIds,uci,dhcpPkgs,dhcpSections,dhcpOptions,dhcpFunctions,dhcpParams),dhcpWillBeEnabled=!0,document.getElementById("dhcp_enabled").checked?uci.remove("dhcp","lan","ignore"):(uci.set("dhcp","lan","ignore","1"),dhcpWillBeEnabled=!1),staticIpTable=document.getElementById("staticip_table_container").firstChild,tableData=getTableDataArray(staticIpTable,!0,!1),createEtherCommands=["touch /etc/ethers","rm /etc/ethers"],staticIpTableData=new Array;for(rowIndex in tableData)rowData=tableData[rowIndex],createEtherCommands.push('echo "'+rowData[1].toLowerCase()+"	"+rowData[2]+'" >> /etc/ethers'),staticIpTableData.push([rowData[0],rowData[1],rowData[2]]),rowData[0]!="-"&&(ipHostHash[rowData[2]]=rowData[0]);createHostCommands=["touch /etc/hosts","rm /etc/hosts"];for(ip in ipHostHash)host=ipHostHash[ip],createHostCommands.push('echo "'+ip+"	"+host+'" >> /etc/hosts');var a=[],b=uci.getAllSectionsOfType("firewall","defaults"),c=uciOriginal.get("firewall",b[0],"block_static_ip_mismatches")=="1"?!0:!1,d=document.getElementById("block_mismatches").checked;d!=c&&(d?(uci.set("firewall",b[0],"block_static_ip_mismatches","1"),a.push("uci set firewall.@defaults[0].block_static_ip_mismatches=1")):(uci.remove("firewall",b[0],"block_static_ip_mismatches"),a.push("uci del firewall.@defaults[0].block_statip_mismatches")),a.push("uci commit"));var e="\n/etc/init.d/dnsmasq restart ; \nsh /usr/lib/gargoyle/restart_firewall.sh\n";commands=uci.getScriptCommands(uciOriginal)+"\n"+createEtherCommands.join("\n")+"\n"+createHostCommands.join("\n")+"\n"+a.join("\n")+"\n"+e;var f=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),g=function(a){a.readyState==4&&(uciOriginal=uci.clone(),dhcpEnabled=dhcpWillBeEnabled,dhcpWillBeEnabled=null,resetData(),setControlsEnabled(!0))};runAjax("POST","utility/run_commands.sh",f,g)}}function createEditButton(){var a=createInput("button");return a.value="编辑",a.className="default_button",a.onclick=editStatic,a}function resetData(){dhcpEnabled=uciOriginal.get("dhcp","lan","ignore")=="1"?!1:!0;var a=0;for(a=0;a<staticIpTableData.length;a++){var b=staticIpTableData[a];b.push(createEditButton()),staticIpTableData[a]=b}columnNames=["主机名","MAC","IP",""],staticIpTable=createTable(columnNames,staticIpTableData,"static_ip_table",!0,!1,resetHostnameMacList),tableContainer=document.getElementById("staticip_table_container"),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild),tableContainer.appendChild(staticIpTable),dhcpIds=["dhcp_start","dhcp_end","dhcp_lease"],dhcpPkgs=["dhcp",["dhcp","dhcp"],"dhcp"],dhcpSections=[dhcpSection,[dhcpSection,dhcpSection],dhcpSection],dhcpOptions=["start",["start","limit"],"leasetime"],enabledTest=function(a){return a!=1},endCombineFunc=function(a){return parseInt(a[0])+parseInt(a[1])},leaseModFunc=function(a){var b;return a.match(/.*h/)?b=a.substr(0,a.length-1):a.match(/.*m/)?b=a.substr(0,a.length-1)/60:a.match(/.*s/)&&(b=a.substr(0,a.length-1)/3600),b},dhcpParams=[100,[endCombineFunc,150],[12,leaseModFunc]],dhcpFunctions=[loadValueFromVariable,loadValueFromMultipleVariables,loadValueFromModifiedVariable],loadVariables(uciOriginal,dhcpIds,dhcpPkgs,dhcpSections,dhcpOptions,dhcpParams,dhcpFunctions),document.getElementById("dhcp_enabled").checked=dhcpEnabled,setEnabled(document.getElementById("dhcp_enabled").checked);var c=uciOriginal.getAllSectionsOfType("firewall","defaults"),d=uciOriginal.get("firewall",c[0],"block_static_ip_mismatches")=="1"?!0:!1;document.getElementById("block_mismatches").checked=d,resetHostnameMacList()}function resetHostnameMacList(){var a=document.getElementById("staticip_table_container").firstChild,b=a==null?[]:getTableDataArray(a,!0,!1),c=[],d=0;for(d=0;d<b.length;d++){var e=b[d][1].toUpperCase();c[e]=1}var f=["none"],g=["选择当前已连接主机的 主机名/MAC "],h=0;for(h=0;h<leaseData.length;h++){var i=leaseData[h],e=i[0].toUpperCase();c[e]==null&&(f.push(i[2]+","+e),g.push((i[2]==""||i[2]=="*"?i[1]:i[2])+" ("+e+")"))}setAllowableSelections("static_from_connected",f,g);var j=g.length>1&&document.getElementById("dhcp_enabled").checked?!0:!1;setElementEnabled(document.getElementById("static_from_connected"),j,"none")}function staticFromConnected(){var a=getSelectedValue("static_from_connected");if(a!="none"){var b=a.split(/,/)[0],c=a.split(/,/)[1];document.getElementById("add_host").value=b,document.getElementById("add_mac").value=c,setSelectedValue("static_from_connected","none")}}function setEnabled(a){var b=["dhcp_start","dhcp_end","dhcp_lease","block_mismatches","add_host","add_mac","add_ip","add_button"],c;for(c in b){var d=document.getElementById(b[c]);setElementEnabled(d,a,"")}var e=document.getElementById("staticip_table_container").firstChild;setRowClasses(e,a),resetHostnameMacList()}function addStatic(){errors=proofreadStatic(document);if(errors.length>0)alert(errors.join("\n")+"\n\nCould not add row.");else{values=new Array,ids=["add_host","add_mac","add_ip"];for(idIndex in ids)v=document.getElementById(ids[idIndex]).value,v=v==""?"-":v,values.push(v),document.getElementById(ids[idIndex]).value="";values.push(createEditButton()),staticIpTable=document.getElementById("staticip_table_container").firstChild,addTableRow(staticIpTable,values,!0,!1,resetHostnameMacList),resetHostnameMacList()}}function proofreadStatic(a,b,c){a=a==null?document:a,b=b==null?document:b,addIds=["add_mac","add_ip"],labelIds=["add_mac_label","add_ip_label"],functions=[validateMac,validateIP],returnCodes=[0,0],visibilityIds=addIds,errors=proofreadFields(addIds,labelIds,functions,returnCodes,visibilityIds,a);if(errors.length==0){var d=b.getElementById("staticip_table_container").firstChild,e=getTableDataArray(d,!0,!1),f=0;for(f=0;f<e.length;f++)d.rows[f+1]!=c&&(rowData=e[f],rowData[0]!=""&&rowData[0]!="-"&&rowData[0]==a.getElementById("add_host").value&&errors.push("duplicate Hostname"),rowData[1]==a.getElementById("add_mac").value&&errors.push("duplicate MAC"),rowData[2]==a.getElementById("add_ip").value&&errors.push("duplicate IP address"))}if(errors.length==0){var g=getDhcpSection(uciOriginal),h=uciOriginal.get("network","lan","netmask"),i=uciOriginal.get("network","lan","ipaddr"),j=a.getElementById("add_ip").value,k=parseInt(j.split(".")[3]);rangeInSubnet(h,i,k,k)||errors.push("Specified static IP falls outside LAN subnet."),i==j&&errors.push("Specified static IP is current router IP.")}return errors}function proofreadAll(){dhcpIds=["dhcp_start","dhcp_end","dhcp_lease"],labelIds=["dhcp_start_label","dhcp_end_label","dhcp_lease_label"],functions=[validateNumeric,validateNumeric,validateNumeric],returnCodes=[0,0,0],visibilityIds=dhcpIds,errors=proofreadFields(dhcpIds,labelIds,functions,returnCodes,visibilityIds);if(errors.length==0&&document.getElementById("dhcp_enabled").checked){var a=getDhcpSection(uciOriginal),b=uciOriginal.get("network","lan","netmask"),c=uciOriginal.get("network","lan","ipaddr"),d=parseInt(document.getElementById("dhcp_start").value),e=parseInt(document.getElementById("dhcp_end").value);rangeInSubnet(b,c,d,e)||errors.push("Specified DHCP range falls outside LAN subnet.");var f=parseInt(c.split(".")[3]);f>=d&&f<=e&&errors.push("Specified DHCP range contains current LAN IP.")}return errors}function editStatic(){if(typeof editStaticWindow!="undefined")try{editStaticWindow.close()}catch(a){}try{xCoor=window.screenX+225,yCoor=window.screenY+225}catch(a){xCoor=window.left+225,yCoor=window.top+225}editStaticWindow=window.open("static_ip_edit.sh","edit","width=560,height=180,left="+xCoor+",top="+yCoor),saveButton=createInput("button",editStaticWindow.document),closeButton=createInput("button",editStaticWindow.document),saveButton.value="关闭且保存设置",saveButton.className="default_button",closeButton.value="关闭不保存设置",closeButton.className="default_button",editRow=this.parentNode.parentNode,runOnEditorLoaded=function(){updateDone=!1,editStaticWindow.document!=null&&editStaticWindow.document.getElementById("bottom_button_container")!=null&&(editStaticWindow.document.getElementById("bottom_button_container").appendChild(saveButton),editStaticWindow.document.getElementById("bottom_button_container").appendChild(closeButton),editStaticWindow.document.getElementById("add_host").value=editRow.childNodes[0].firstChild.data,editStaticWindow.document.getElementById("add_mac").value=editRow.childNodes[1].firstChild.data,editStaticWindow.document.getElementById("add_ip").value=editRow.childNodes[2].firstChild.data,editStaticWindow.document.getElementById("add_button").style.display="none",closeButton.onclick=function(){editStaticWindow.close()},saveButton.onclick=function(){var a=proofreadStatic(editStaticWindow.document,document,editRow);a.length>0?alert(a.join("\n")+"\nCould not update static ip."):(editRow.childNodes[0].firstChild.data=editStaticWindow.document.getElementById("add_host").value,editRow.childNodes[1].firstChild.data=editStaticWindow.document.getElementById("add_mac").value,editRow.childNodes[2].firstChild.data=editStaticWindow.document.getElementById("add_ip").value,editStaticWindow.close(),resetHostnameMacList())},editStaticWindow.moveTo(xCoor,yCoor),editStaticWindow.focus(),updateDone=!0),updateDone||setTimeout("runOnEditorLoaded()",250)},runOnEditorLoaded()};