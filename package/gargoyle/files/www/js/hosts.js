/*
 * This program is copyright � 2008-2011 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function resetData(){setSelectedValue("refresh_rate","10000"),resetVariables(),setInterval(checkForRefresh,500)}function checkForRefresh(){timeSinceUpdate+=500;var a=getSelectedValue("refresh_rate"),a=a=="never"?timeSinceUpdate+500:a;if(timeSinceUpdate<0||timeSinceUpdate>=a)timeSinceUpdate=0,reloadVariables()}function reloadVariables(){if(!updateInProgress){updateInProgress=!0;var param=getParameterDefinition("commands","sh /usr/lib/gargoyle/define_host_vars.sh")+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),stateChangeFunction=function(req){if(req.readyState==4){var jsHostVars=req.responseText.replace(/Success/,"");eval(jsHostVars),resetVariables(),updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",param,stateChangeFunction)}}function resetVariables(){if(uciOriginal.get("dhcp","lan","ignore")!="1"){document.getElementById("dhcp_data").style.display="block";var a=["主机名","主机 IP","主机 MAC","租约到期"],b=createTable(a,parseDhcp(dhcpLeaseLines),"lease_table",!1,!1),c=document.getElementById("lease_table_container");c.firstChild!=null&&c.removeChild(c.firstChild),c.appendChild(b)}else document.getElementById("dhcp_data").style.display="none";var d=parseArp(arpLines,dhcpLeaseLines),e=!1,f=uciOriginal.getAllSectionsOfType("wireless","wifi-iface"),g=0;for(g=0;g<f.length;g++)e=uciOriginal.get("wireless",f[g],"mode")=="ap"?!0:e;var h=uciOriginal.getAllSectionsOfType("wireless","wifi-device");e=e&&uciOriginal.get("wireless",h[0],"disabled")!="1";if(e){document.getElementById("wifi_data").style.display="block";var a=["主机名","主机 IP","主机 MAC","比特率","信号"],b=createTable(a,parseWifi(d,wirelessDriver,wifiLines),"wifi_table",!1,!1),c=document.getElementById("wifi_table_container");c.firstChild!=null&&c.removeChild(c.firstChild),c.appendChild(b)}else document.getElementById("wifi_data").style.display="none";var a=["主机名","主机 IP","主机 MAC","活动TCP连接","近期TCP连接","UDP连接"],b=createTable(a,parseConntrack(d,currentWanIp,conntrackLines),"active_table",!1,!1),c=document.getElementById("active_table_container");c.firstChild!=null&&c.removeChild(c.firstChild),c.appendChild(b)}function getHostname(a){var b=ipToHostname[a]==null?"(unknown)":ipToHostname[a];return b=b.length<25?b:b.substr(0,22)+"...",b}function parseDhcp(a){var b=[],c=0;for(c=0;c<a.length;c++){var d=a[c],e=d.split(/[\t ]+/),f=e[0],g=e[1].toUpperCase(),h=e[2],i=getHostname(h),j=f-currentTime,k=Math.floor(j/3600),l=Math.floor((j-k*60*60)/60);l<10&&(l="0"+l);var m=k+"h "+l+"m";b.push([i,h,g,m])}return sort2dStrArr(b,1),b}function parseArp(a,b){var c=[];a.shift();var d=0;for(d=0;d<a.length;d++){var e=a[d],f=e.split(/[\t ]+/),g=f[3].toUpperCase(),h=f[0];c[g]=h,c[h]=g}for(d=0;d<b.length;d++){var i=b[d],j=i.split(/[\t ]+/),g=j[1].toUpperCase(),h=j[2];c[g]=h,c[h]=g}return c}function sort2dStrArr(a,b){var c=function(a,c){return a[b]==c[b]?0:a[b]<c[b]?-1:1};a.sort(c)}function parseWifi(a,b,c){if(b==""||c.length==0)return[];var d=[],e=0;b=="atheros"&&c.shift();for(e=0;e<c.length;e++){var f=c[e],g=f.split(/[\t ]+/),h=[[g[1],"0","0"],[g[0],g[3],g[5]],[g[0],g[2],g[1]]],i=b=="broadcom"?h[0]:b=="atheros"?h[1]:h[2];i[0]=i[0].toUpperCase();var j=function(a){var b=parseInt(a).toString(16).toUpperCase();return b=b.length<2?"0"+b:b.substr(0,2),b},k=parseInt(i[2]),l=k<-80?"#AA0000":"";l=k>=-80&&k<-70?"#AA"+j(170*((k+80)/10))+"00":l,l=k>=-70&&k<-60?"#"+j(170-170*(k+70)/10)+"AA00":l,l=k>=-60?"#00AA00":l;var m=document.createElement("span");m.appendChild(document.createTextNode(""+i[2])),m.style.color=l,i[2]=m;var n=a[i[0]]==null?"unknown":a[i[0]],o=getHostname(n);d.push([o,n,i[0],i[1],i[2]])}return sort2dStrArr(d,1),d}function parseConntrack(a,b,c){var d=[],e=[],f=[],g=[],h=0;for(h=0;h<c.length;h++){var i=c[h],j=i.split(/src=/),k=j[1],l=k.split(/[\t ]+/),m=l[0];j=i.split(/dst=/);var n=j[1],o=n.split(/[\t ]+/),p=o[0];j=i.split(/[\t ]+/);var q=j[0].toLowerCase();if(q=="tcp"){var r=j[3].toUpperCase(),s=r=="TIME_WAIT"||r=="CLOSE"?"closed":"open";q=q+"-"+s}f[m+"-"+q]=f[m+"-"+q]==null?1:f[m+"-"+q]+1;if(q=="udp")var t=f[m+"-"+q];e[m]==null&&m!=b&&m!=currentLanIp&&p!=b&&m!="0.0.0.0"&&(g.push(m),e[m]=1)}var u=0;for(u=0;u<g.length;u++){var v=g[u],w=a[v]==null?"unknown":a[v],x=f[v+"-tcp-open"]==null?0:f[v+"-tcp-open"],y=f[v+"-tcp-closed"]==null?0:f[v+"-tcp-closed"],z=f[v+"-udp"]==null?0:f[v+"-udp"],A=getHostname(v);d.push([A,v,w,""+x,""+y,""+z])}return sort2dStrArr(d,1),d}var updateInProgress=!1,timeSinceUpdate=-5e3;