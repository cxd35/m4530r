/*
 * This program is copyright © 2008,2009 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){setControlsEnabled(!1,!0);var a=[],b=uciOriginal.getAllSectionsOfType(pkg,"quota");while(b.length>0){var c=b.shift();uciOriginal.removeSection(pkg,c),a.push("uci del "+pkg+"."+c)}a.push("uci commit");var d=uci.getAllSectionsOfType(pkg,"quota"),e="\nuci del gargoyle.status.quotause ; uci commit ;\n",f=[];while(d.length>0){var c=d.shift(),g=uci.get(pkg,c,"id");f[g]=c,changedIds[g]==1&&uci.set(pkg,c,"ignore_backup_at_next_restore","1")}var h=document.getElementById("quota_table_container").firstChild,i=getTableDataArray(h,!0,!1),j=0;for(j=0;j<i.length;j++){var k=i[j][rowCheckIndex],l=f[k.id];l!=null&&(uci.set(pkg,l,"enabled",k.checked?"1":"0"),k.checked&&(e='\nuci set gargoyle.status.quotause="225" ; uci commit ;\n'))}var m=[];m.push("sh /usr/lib/gargoyle/restart_firewall.sh"),m.push('if [ -d "/usr/data/quotas/" ] ; then rm -rf /usr/data/quotas/* ; fi ;'),m.push("backup_quotas");var n=a.join("\n")+"\n"+uci.getScriptCommands(uciOriginal)+"\n"+e+"\n"+m.join("\n"),o=getParameterDefinition("commands",n)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),p=function(a){a.readyState==4&&(setControlsEnabled(!0),window.location.href=window.location.href)};runAjax("POST","utility/run_commands.sh",o,p)}function resetData(){var a=0;upQosClasses=[],upQosMarks=[],downQosClasses=[],downQosMarks=[];for(a=0;a<qosMarkList.length;a++){var b=qosMarkList[a][1],c=uciOriginal.get("qos_gargoyle",b,"name");b=c==""?b:c,qosMarkList[a][0]=="upload"?(upQosClasses.push(b),upQosMarks.push(qosMarkList[a][2])):(downQosClasses.push(b),downQosMarks.push(qosMarkList[a][2]))}var d=uciOriginal.getAllSectionsOfType(pkg,"quota"),e=[],f=[],g=[];changedIds=[];for(sectionIndex=0;sectionIndex<d.length;sectionIndex++){var h=uciOriginal.get(pkg,d[sectionIndex],"ip").toUpperCase(),i=uciOriginal.get(pkg,d[sectionIndex],"id");i==""&&(i=getIdFromIp(h),uci.set(pkg,d[sectionIndex],"id",i));var j=getTimeParametersFromUci(uci,d[sectionIndex]),k=getLimitStrFromUci(uci,d[sectionIndex]),l=uciOriginal.get(pkg,d[sectionIndex],"enabled");l=l!="0"?!0:!1;var m=createEnabledCheckbox(l);m.id=i,f.push(m),g.push(l),e.push([ipToTableSpan(h),timeParamsToTableSpan(j),k,m,createEditButton(l)])}columnNames=["IP(范围)","启用时间",textListToSpanElement(["限制","(总量/下载/上传)"],!1),"已启用",""],quotaTable=createTable(columnNames,e,"quota_table",!0,!1,removeQuotaCallback),tableContainer=document.getElementById("quota_table_container"),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild),tableContainer.appendChild(quotaTable);while(f.length>0){var n=f.shift(),o=g.shift();n.checked=o}setDocumentFromUci(document,new UCIContainer,""),setVisibility(document)}function ipToTableSpan(a){var b=a;if(b=="ALL_OTHERS_INDIVIDUAL")b="其他 (单独)";else if(b=="ALL_OTHERS_COMBINED")b="其他 (合并)";else if(b=="ALL"||b=="")b="整个网络";return textListToSpanElement(b.split(/[\t ]*,[\t ]*/),!0,document)}function timeParamsToTableSpan(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=[];return e=="always"?f.unshift("一直启用"):(d!=""?f=d.match(",")?d.split(/[\t ]*,[\t ]*/):[d]:(b!=""&&(f=b.match(",")?b.split(/[\t ]*,[\t ]*/):[b]),c!=""&&f.unshift(c)),f.unshift(e=="only"?"仅限:":"排除:")),textListToSpanElement(f,!1,document)}function getLimitStrFromUci(a,b){var c=uci.get(pkg,b,"combined_limit"),d=uci.get(pkg,b,"ingress_limit"),e=uci.get(pkg,b,"egress_limit"),f=function(a){return a==""?"NA":parseBytes(parsePaddedInt(a)).replace(/ytes/,"").replace(/\.[\d]+/,"").replace(/[\t ]+/,"")};return f(c)+"/"+f(d)+"/"+f(e)}function getIdFromIp(a){id=a==""?"ALL":a.replace(/[\t, ]+.*$/,""),id=id.replace(/\//,"_");var b=id,c=!0,d=0,e=uci.getAllSectionsOfType(pkg,"quota");while(c){c=!1;var f;for(f=0;f<e.length&&!c;f++)c=c||uci.get(pkg,e[f],"id")==id;if(c){var g="ABCDEFGHIJKLMNOPQRSTUVWXYZ",h=d<26?"_"+g.substr(d,1):"_Z"+(d-25);id=b+h}d++}return id}function getIpFromDocument(a){a=a==null?document:a;var b="ALL";if(getSelectedValue("applies_to_type",a)=="all")b="ALL";else if(getSelectedValue("applies_to_type",a)=="others_combined")b="ALL_OTHERS_COMBINED";else if(getSelectedValue("applies_to_type",a)=="others_individual")b="ALL_OTHERS_INDIVIDUAL";else if(getSelectedValue("applies_to_type",a)=="only"){var c=a.getElementById("quota_ip_table_container").firstChild,d=c!=null?getTableDataArray(c,!0,!1):[],e=[],f;for(f=0;f<d.length;f++)e.push(d[f][0]);b=e.join(",")}return b}function setDocumentIp(a,b){a=a==""?"ALL":a,b=b==null?document:b,b.getElementById("add_ip").value="";var c=b.getElementById("quota_ip_table_container");while(c.firstChild!=null)c.removeChild(c.firstChild);if(a=="ALL")setSelectedValue("applies_to_type","all",b);else if(a=="ALL_OTHERS_COMBINED")setSelectedValue("applies_to_type","others_combined",b);else if(a=="ALL_OTHERS_INDIVIDUAL")setSelectedValue("applies_to_type","others_individual",b);else{setSelectedValue("applies_to_type","only",b),b.getElementById("add_ip").value=a;var d=addAddressesToTable(b,"add_ip","quota_ip_table_container","quota_ip_table",!1,3,!1,250);d||(b.getElementById("add_ip").value="")}}function addNewQuota(){var a=validateQuota(document,"","none");if(a.length>0)alert(a.join("\n")+"\nCould not add quota.");else{var b=1;while(uci.get(pkg,"quota_"+b,"")!="")b++;setUciFromDocument(document,"");var c=createEnabledCheckbox(!0);c.id=uci.get(pkg,"quota_"+b,"id");var d=document.getElementById("quota_table_container"),e=d.firstChild,f=getIpFromDocument(document),g=getTimeParametersFromUci(uci,"quota_"+b),h=getLimitStrFromUci(pkg,"quota_"+b);addTableRow(e,[ipToTableSpan(f),timeParamsToTableSpan(g),h,c,createEditButton(!0)],!0,!1,removeQuotaCallback),setDocumentFromUci(document,new UCIContainer,""),c.checked=!0}}function setVisibility(a){a=a==null?document:a,setInvisibleIfIdMatches("applies_to_type",["all","others_combined","others_individual"],"quota_ip_container","inline",a),setInvisibleIfIdMatches("quota_reset",["hour","day"],"quota_day_container","block",a),setInvisibleIfIdMatches("quota_reset",["hour"],"quota_hour_container","block",a),setInvisibleIfIdMatches("max_up_type",["unlimited"],"max_up_container","inline",a),setInvisibleIfIdMatches("max_down_type",["unlimited"],"max_down_container","inline",a),setInvisibleIfIdMatches("max_combined_type",["unlimited"],"max_combined_container","inline",a),setInvisibleIfIdMatches("quota_active",["always"],"quota_active_type","inline",a),setInvisibleIfIdMatches("quota_active",["always"],"quota_active_controls_container","block",a),getSelectedValue("quota_active",a)!="always"?(setInvisibleIfIdMatches("quota_active_type",["days","weekly_range"],"active_hours_container","block",a),setInvisibleIfIdMatches("quota_active_type",["hours","weekly_range"],"active_days_container","block",a),setInvisibleIfIdMatches("quota_active_type",["hours","days","days_and_hours"],"active_weekly_container","block",a)):(setInvisibleIfIdMatches("quota_active",["always"],"active_hours_container","block",a),setInvisibleIfIdMatches("quota_active",["always"],"active_days_container","block",a),setInvisibleIfIdMatches("quota_active",["always"],"active_weekly_container","block",a)),setInvisibleIfIdMatches("quota_exceeded",["hard_cutoff"],"quota_only_qos_container","block",a),setInvisibleIfIdMatches("quota_exceeded",["hard_cutoff"],"quota_full_qos_container","block",a),fullQosEnabled?a.getElementById("quota_only_qos_container").style.display="none":a.getElementById("quota_full_qos_container").style.display="none";var b=getSelectedValue("quota_reset",a);if(b=="month"){var c=[],d=[],e=1;for(e=1;e<=28;e++){var f=""+e,g=f.substr(f.length-1,1),h="th";e%100!=11&&g=="1"&&(h="st"),e%100!=12&&g=="2"&&(h="nd"),e%100!=13&&g=="3"&&(h="rd"),d.push(f+h),c.push((e-1)*60*60*24+"")}setAllowableSelections("quota_day",c,d,a)}if(b=="week"){var d=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],c=[],i;for(i=0;i<7;i++)c.push(i*60*60*24+"");setAllowableSelections("quota_day",c,d,a)}}function getDaySeconds(a){return Math.floor(a/86400)*86400}function getHourSeconds(a){return Math.floor(a%86400/3600)*3600}function timeVariablesToWeeklyRanges(a,b,c,d){var a=a==null?"":a,b=b==null?"":b,c=c==null?"":c,e=[];e.SUN=0,e.MON=1,e.TUE=2,e.WED=3,e.THU=4,e.FRI=5,e.SAT=6;var f=function(a,b){var c=[],d;for(d=0;d<a.length;d+=2){if(a[d+1]<a[d]){var e=a[d+1];a[d+1]=b,a.push(0),a.push(e)}var f=a[d],g=a[d+1];c.push([f,g])}var h=function(a,b){return a[0]-b[0]},i=c.sort(h),j=[];for(d=0;d<i.length;d++)j.push(i[d][0]),j.push(i[d][1]);return j},g=[];if(a==""&&b==""&&c=="")g=[0,604800],d=!1;else if(c!=""){var h=function(a){var b=a.split(/[:\t ]+/),c=b[0].substr(0,3).toUpperCase();return b[0]=e[c]!=null?e[c]*24*60*60:0,b[1]=parsePaddedInt(b[1])+""!="NaN"?parsePaddedInt(b[1])*60*60:0,b[2]=parsePaddedInt(b[2])+""!="NaN"?parsePaddedInt(b[2])*60:0,b[3]=b[3]!=null?parsePaddedInt(b[3])+""!="NaN"?parsePaddedInt(b[3]):0:0,b[0]+b[1]+b[2]+b[3]},i=c.split(/[\t ]*,[\t ]*/),j;for(j=0;j<i.length;j++){var k=i[j].split(/[\t ]*\-[\t ]*/);g.push(h(k[0])),g.push(h(k[1]))}g=f(g,604800)}else{var l=[1,1,1,1,1,1,1],m=[];if(b!=""){l=[0,0,0,0,0,0,0];var n=b.split(/[\t ]*,[\t ]*/),o;for(o=0;o<n.length;o++){var p=n[o].substr(0,3).toUpperCase();e[p]!=null&&(l[e[p]]=1)}}if(a!=""){var h=function(a){var b=a.split(/[:\t ]+/);return b[0]=parsePaddedInt(b[0])+""!="NaN"?parsePaddedInt(b[0])*60*60:0,b[1]=parsePaddedInt(b[1])+""!="NaN"?parsePaddedInt(b[1])*60:0,b[2]=b[2]!=null?parsePaddedInt(b[2])+""!="NaN"?parsePaddedInt(b[2]):0:0,b[0]+b[1]+b[2]},i=a.split(/[\t ]*,[\t ]*/),j;for(j=0;j<i.length;j++){var q=i[j].replace(/^[\t ]*/,"").replace(/[\t ]*$/,""),k=q.split(/[\t ]*\-[\t ]*/);m.push(h(k[0])),m.push(h(k[1]))}m=f(m,86400)}m=m.length==0?[0,86400]:m;var o;for(o=0;o<l.length;o++)if(l[o]!=0){var r;for(r=0;r<m.length;r++)g.push(o*24*60*60+m[r])}}return d&&(g[0]==0?g.shift():g.unshift(0),g[g.length-1]==7*24*60*60?g.pop():g.push(604800)),g}function rangesOverlap(a,b){var c=timeVariablesToWeeklyRanges(a[0],a[1],a[2],a[3]),d=timeVariablesToWeeklyRanges(b[0],b[1],b[2],b[3]),e=0,f=0,g=!1;for(e=0;e<c.length&&!g;e+=2){var h=c[e],i=c[e+1],j=d[f],k=d[f+1];g=g||i>j&&h<k;while(!g&&j<h&&f<d.length){f+=2;if(f<d.length){var j=d[f],k=d[f+1];g=g||i>j&&h<k}}}return g}function validateQuota(a,b,c){b=b==null?"":b,c=c==null?"none":c,a=a==null?document:a;var d=["max_up","max_down","max_combined","active_hours","active_weekly"],e=["max_up_label","max_down_label","max_combined_label","quota_active_label","quota_active_label"],f=[validateDecimal,validateDecimal,validateDecimal,validateHours,validateWeeklyRange],g=[0,0,0,0,0],h=["max_up_container","max_down_container","max_combined_container","active_hours_container","active_weekly_container"],i=proofreadFields(d,e,f,g,h,a);if(i.length==0&&getSelectedValue("applies_to_type",a)=="only"&&a.getElementById("add_ip").value!=""){var j=addAddressesToTable(a,"add_ip","quota_ip_table_container","quota_ip_table",!1,3,!1,250);j||i.push('"'+a.getElementById("add_ip").value+'" is not a valid IP or IP range')}var k="";i.length==0&&(k=getIpFromDocument(a),k==""&&i.push("You must specify at least one valid IP or IP range")),i.length==0&&getSelectedValue("max_up_type",a)=="unlimited"&&getSelectedValue("max_down_type",a)=="unlimited"&&getSelectedValue("max_combined_type",a)=="unlimited"&&i.push("Upload, download and combined bandwidth limits cannot all be unlimited");if(i.length==0&&k!=c){var l=uci.getAllSectionsOfType(pkg,"quota"),m,n=!1;for(m=0;m<l.length&&!n;m++){var o=uci.get(pkg,l[m],"id");if(o!=b){var p=uci.get(pkg,l[m],"ip"),q=testAddrOverlap(p,k);if(q){var r=getTimeParametersFromDocument(a),s=getTimeParametersFromUci(uci,l[m]);r[3]=r[3]=="except"?!0:!1,s[3]=s[3]=="except"?!0:!1,n=rangesOverlap(r,s)}}}n&&(k.match(/ALL/)?k.match(/OTHER/)?i.push("You may have only one quota at a given time for hosts without explicit quotas"):i.push("You may have only one quota at a given time that applies to entire network"):i.push("Duplicate IP/Time Range -- only one quota per IP at a given time is allowed"))}return i}function setDocumentFromUci(a,b,c){a=a==null?document:a;var d="",e=b.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<e.length&&d=="";sectionIndex++)b.get(pkg,e[sectionIndex],"id")==c&&(d=e[sectionIndex]);var f=b.get(pkg,d,"ip");f=f==""?"ALL":f;var g=b.get(pkg,d,"reset_interval"),h=b.get(pkg,d,"egress_limit"),i=b.get(pkg,d,"ingress_limit"),j=b.get(pkg,d,"combined_limit");g=g==""||g=="minute"?"day":g;var k=b.get(pkg,d,"reset_time");k=k==""?0:parseInt(k);var l=getDaySeconds(k),m=getHourSeconds(k),n=b.get(pkg,d,"exceeded_up_speed"),o=b.get(pkg,d,"exceeded_down_speed"),p=b.get(pkg,d,"exceeded_up_class_mark"),q=b.get(pkg,d,"exceeded_down_class_mark");setDocumentIp(f,a),setSelectedValue("quota_reset",g,a);var r=getTimeParametersFromUci(b,d),s=r[1],t=["sun","mon","tue","wed","thu","fri","sat"],u=[];s==""?u=t:u=s.split(/,/);var v=0;for(v=0;v<t.length;v++){var w=t[v],x=!1,y=0;for(y=0;y<u.length&&!x;y++)x=u[y]==w;a.getElementById("quota_"+t[v]).checked=x}a.getElementById("active_hours").value=r[0],a.getElementById("active_weekly").value=r[2];var z=r[3];setSelectedValue("quota_active",z,a);if(z!="always"){var A=[];A["000"]="hours",A[100]="hours",A["010"]="days",A[110]="days_and_hours";var B=(r[0]!=""?"1":"0")+(r[1]!=""?"1":"0")+(r[2]==""?"0":"1"),C=A[B]!=null?A[B]:"weekly_range";setSelectedValue("quota_active_type",C,a)}setSelectedValue("max_up_type",h==""?"unlimited":"limited",a),setSelectedValue("max_down_type",i==""?"unlimited":"limited",a),setSelectedValue("max_combined_type",j==""?"unlimited":"limited",a),setDocumentLimit(h,"max_up","max_up_unit",a),setDocumentLimit(i,"max_down","max_down_unit",a),setDocumentLimit(j,"max_combined","max_combined_unit",a);var D=n!=""&&o!=""&&!fullQosEnabled||p!=""&&q!=""&&fullQosEnabled?"throttle":"hard_cutoff";setSelectedValue("quota_exceeded",D,a),setDocumentSpeed(n,"quota_qos_up","quota_qos_up_unit",a),setDocumentSpeed(o,"quota_qos_down","quota_qos_down_unit",a),setVisibility(a),setSelectedValue("quota_day",l+"",a),setSelectedValue("quota_hour",m+"",a),fullQosEnabled&&(setAllowableSelections("quota_full_qos_up_class",upQosMarks,upQosClasses,a),setAllowableSelections("quota_full_qos_down_class",downQosMarks,downQosClasses,a),p!=""&&q!=""&&(setSelectedValue("quota_full_qos_up_class",p,a),setSelectedValue("quota_full_qos_down_class",q,a)))}function setDocumentLimit(a,b,c,d){a=a==""?0:parseInt(a);var e=d.getElementById(b),f="MB",g=1048576;if(a<=0)setSelectedValue(c,f,d),e.value="0";else{var h=parseBytes(a),i=f,j=g;h.match(/GBytes/)&&(i="GB",j=1073741824),h.match(/TBytes/)&&(i="TB",j=1099511627776),setSelectedValue(c,i,d);var k=truncateDecimal(a/j);e.value=k}}function setDocumentSpeed(a,b,c,d){var e="KBytes/s",f=d.getElementById(b);setSelectedValue(c,e,d),a=a==""?0:parseInt(a);if(a<=0)f.value="0";else{var g=parseKbytesPerSecond(a),h=g.split(/[\t ]+/);f.value=h[0],setSelectedValue(c,h[1],d)}}function setUciFromDocument(a,b){a=a==null?document:a;var c=getIpFromDocument(a);b=b==null?"":b,b=b==""?getIdFromIp(c):b;var d="",e=uci.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<e.length;sectionIndex++)uci.get(pkg,e[sectionIndex],"id")==b&&(d=e[sectionIndex]);if(d==""){var f=1;while(uci.get(pkg,"quota_"+f,"")!="")f++;d="quota_"+f,uci.set(pkg,d,"","quota")}var g=uci.get(pkg,d,"ip");g!=c&&(testAddrOverlap(g,c)||(changedIds[b]=1)),uci.set(pkg,d,"ingress_limit",getDocumentLimit("max_down","max_down_type","max_down_unit",a)),uci.set(pkg,d,"egress_limit",getDocumentLimit("max_up","max_up_type","max_up_unit",a)),uci.set(pkg,d,"combined_limit",getDocumentLimit("max_combined","max_combined_type","max_combined_unit",a)),uci.set(pkg,d,"exceeded_up_speed",getDocumentSpeed("quota_only_qos_container","quota_qos_up","quota_qos_up_unit",a)),uci.set(pkg,d,"exceeded_down_speed",getDocumentSpeed("quota_only_qos_container","quota_qos_down","quota_qos_down_unit",a)),uci.set(pkg,d,"exceeded_up_class_mark",getDocumentMark("quota_full_qos_container","quota_full_qos_up_class",a)),uci.set(pkg,d,"exceeded_down_class_mark",getDocumentMark("quota_full_qos_container","quota_full_qos_down_class",a)),uci.set(pkg,d,"reset_interval",getSelectedValue("quota_reset",a)),uci.set(pkg,d,"ip",c),uci.set(pkg,d,"id",b);var h=getSelectedValue("quota_day",a),i=getSelectedValue("quota_hour",a);h=h==""?"0":h,i=i==""?"0":i;var j=parseInt(h)+parseInt(i);if(j>0){var k=j+"";uci.set(pkg,d,"reset_time",k)}else uci.remove(pkg,d,"reset_time");var l=getTimeParametersFromDocument(a),m=l[3],n=["offpeak","onpeak"],o=0;for(o=0;o<n.length;o++){var p=n[o],q=function(a,b,c){a?uci.set(pkg,d,b,c):uci.remove(pkg,d,b)},r=p=="offpeak"&&m=="except"||p=="onpeak"&&m=="only";q(r,p+"_hours",l[0]),q(r,p+"_weekdays",l[1]),q(r,p+"_weekly_ranges",l[2])}}function getTimeParametersFromDocument(a){var b=a.getElementById("active_hours_container").style.display!="none"?a.getElementById("active_hours").value:"",c=a.getElementById("active_weekly_container").style.display!="none"?a.getElementById("active_weekly").value:"",d=[];if(a.getElementById("active_days_container").style.display!="none"){var e=["sun","mon","tue","wed","thu","fri","sat"],f;for(f=0;f<e.length;f++)a.getElementById("quota_"+e[f]).checked&&d.push(e[f])}var g=""+d.join(","),h=getSelectedValue("quota_active",a);return[b,g,c,h]}function getTimeParametersFromUci(a,b){var c=a.get(pkg,b,"offpeak_hours"),d=a.get(pkg,b,"offpeak_weekdays"),e=a.get(pkg,b,"offpeak_weekly_ranges"),f=c!=""||d!=""||e!=""?"except":"always";return f=="always"&&(c=a.get(pkg,b,"onpeak_hours"),d=a.get(pkg,b,"onpeak_weekdays"),e=a.get(pkg,b,"onpeak_weekly_ranges"),f=c!=""||d!=""||e!=""?"only":"always"),[c,d,e,f]}function getDocumentLimit(a,b,c,d){var e="";if(getSelectedValue(b,d)!="unlimited"){var f=getSelectedValue(c,d),g=1048576;f=="MB"&&(g=1048576),f=="GB"&&(g=1073741824),f=="TB"&&(g=1099511627776);var h=Math.round(g*parseFloat(d.getElementById(a).value));e=""+h}return e}function getDocumentSpeed(a,b,c,d){var e="";if(d.getElementById(a).style.display!="none"){var f=getSelectedValue(c,d);f=="MBytes/s"&&(multiple=1024),f=="KBytes/s"&&(multiple=1);var g=Math.round(multiple*parseFloat(d.getElementById(b).value));e=""+g}return e}function getDocumentMark(a,b,c){var d="";return c.getElementById(a).style.display!="none"&&(d=getSelectedValue(b,c)),d}function createEnabledCheckbox(a){return enabledCheckbox=createInput("checkbox"),enabledCheckbox.onclick=setRowEnabled,enabledCheckbox.checked=a,enabledCheckbox}function createEditButton(a){return editButton=createInput("button"),editButton.value="编辑",editButton.className="default_button",editButton.onclick=editQuota,editButton.className=a?"default_button":"default_button_disabled",editButton.disabled=a?!1:!0,editButton}function setRowEnabled(){enabled=this.checked?"1":"0",enabledRow=this.parentNode.parentNode,enabledRow.childNodes[rowCheckIndex+1].firstChild.disabled=this.checked?!1:!0,enabledRow.childNodes[rowCheckIndex+1].firstChild.className=this.checked?"default_button":"default_button_disabled";var a=this.id,b=a.split(/\./);uci.get(pkg,b[0])!=""&&uci.set(pkg,b[0],"enabled",enabled),uci.get(pkg,b[1])!=""&&uci.set(pkg,b[1],"enabled",enabled)}function removeQuotaCallback(a,b){var c=b.childNodes[rowCheckIndex].firstChild.id,d=uci.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<d.length;sectionIndex++)uci.get(pkg,d[sectionIndex],"id")==c&&uci.removeSection(pkg,d[sectionIndex]);changedIds[c]=1}function editQuota(){if(typeof editQuotaWindow!="undefined")try{editQuotaWindow.close()}catch(a){}try{xCoor=window.screenX+225,yCoor=window.screenY+225}catch(a){xCoor=window.left+225,yCoor=window.top+225}editQuotaWindow=window.open("quotas_edit.sh","edit","width=560,height=600,left="+xCoor+",top="+yCoor);var b=createInput("button",editQuotaWindow.document),c=createInput("button",editQuotaWindow.document);b.value="Close and Apply Changes",b.className="default_button",c.value="Close and Discard Changes",c.className="default_button";var d=this.parentNode.parentNode,e=d.childNodes[rowCheckIndex].firstChild.id,f,g="",h=uci.getAllSectionsOfType(pkg,"quota");for(sectionIndex=0;sectionIndex<h.length&&g=="";sectionIndex++)uci.get(pkg,h[sectionIndex],"id")==e&&(g=h[sectionIndex],f=uci.get(pkg,g,"ip"));var i=uci.get(pkg,g,"egress_limit"),j=uci.get(pkg,g,"ingress_limit"),k=uci.get(pkg,g,"combined_limit"),l=function(){var a=!1;editQuotaWindow.document!=null&&editQuotaWindow.document.getElementById("bottom_button_container")!=null&&(editQuotaWindow.document.getElementById("bottom_button_container").appendChild(b),editQuotaWindow.document.getElementById("bottom_button_container").appendChild(c),setDocumentFromUci(editQuotaWindow.document,uci,e),c.onclick=function(){editQuotaWindow.close()},b.onclick=function(){var a=validateQuota(editQuotaWindow.document,e,f);if(a.length>0)alert(a.join("\n")+"\nCould not add quota.");else{var b=getIpFromDocument(editQuotaWindow.document);setUciFromDocument(editQuotaWindow.document,e);var c=function(a,b){var c=d.childNodes[b];while(c.firstChild!=null)c.removeChild(c.firstChild);c.appendChild(a)};if(b!=f){var h=getIdFromIp(b);uci.set(pkg,g,"id",h),testAddrOverlap(b,f)||(changedIds[h]=1),c(ipToTableSpan(b),0),d.childNodes[rowCheckIndex].firstChild.id=h}c(timeParamsToTableSpan(getTimeParametersFromUci(uci,g)),1),d.childNodes[2].firstChild.data=getLimitStrFromUci(uci,g),editQuotaWindow.close()}},editQuotaWindow.moveTo(xCoor,yCoor),editQuotaWindow.focus(),a=!0),a||setTimeout(l,250)};l()}var pkg="firewall",changedIds=[],rowCheckIndex=3,downQosClasses=[],downQosMarks=[],upQosClasses=[],upQosMarks=[];