/*
 * This program is copyright � 2008-2011 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){errorList=proofreadAll();if(errorList.length>0)errorString=errorList.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{var a=uciOriginal.clone(),b=uciOriginal.clone(),c=!isBridge(uciOriginal)&&document.getElementById("global_bridge").checked;c?setControlsEnabled(!1,!0,"Please Wait While Settings Are Applied And Device Is Restarted"):setControlsEnabled(!1,!0,"Please Wait While Settings Are Applied");var d="";wifiDevG==""&&wirelessDriver!=""&&(wifiDevG=wirelessDriver=="broadcom"?"wl0":wirelessDriver=="atheros"?"wifi0":"radio0",d=d+"uci set wireless."+wifiDevG+"=wifi-device\n",d=d+"uci set wireless."+wifiDevG+".type="+wirelessDriver+"\n",d+="uci commit\n",a.set("wireless",wifiDevG,"","wifi-device"),a.set("wireless",wifiDevG,"type",wirelessDriver),wirelessDriver=="mac80211"&&a.set("wireless",wifiDevG,"hwmode","11g"));var e=0,f=a.getAllSectionsOfType("wireless","wifi-iface");for(e=0;e<f.length;e++){var g=f[e];a.get("wireless",g,"")=="wifi-iface"&&(a.removeSection("wireless",g),b.removeSection("wireless",g),d=d+"uci del wireless."+g+"\n")}d+="uci commit \n",wifiDevG!=""&&a.remove("wireless",wifiDevG,"disabled"),wifiDevA!=""&&a.remove("wireless",wifiDevA,"disabled");var h=function(b,c,d){getSelectedValue(b)=="max"?a.remove("wireless",d,"txpower"):a.set("wireless",d,"txpower",document.getElementById(c).value)},i=getSelectedWifiChannels();i["G"]!=""&&(a.set("wireless",wifiDevG,"channel",i.G),(document.getElementById("wifi_channel_width_container").style.display=="block"||document.getElementById("bridge_channel_width_container").style.display=="block")&&a.set("wireless",wifiDevG,"htmode",getSelectedValue("wifi_channel_width")),h("wifi_max_txpower","wifi_txpower",wifiDevG)),i["A"]!=""&&(a.set("wireless",wifiDevA,"channel",i.A),a.set("wireless",wifiDevA,"htmode",getSelectedValue("wifi_channel_width_5ghz")),h("wifi_max_txpower_5ghz","wifi_txpower_5ghz",wifiDevA)),currentLanIp="";var j="",k="";if(document.getElementById("global_gateway").checked){var l=!0,m=!1,n=!1;if(document.getElementById("wifi_hwmode_container").style.display=="block"){var o=getSelectedValue("wifi_hwmode"),p=o=="dual"||o=="11na"?"11ng":o;a.set("wireless",wifiDevG,"hwmode",p),m=o=="dual"||o=="11na",l=o!="11na",n=o=="dual"}currentLanIp=document.getElementById("lan_ip").value,getSelectedValue("wan_protocol")=="none"?(d+="\nuci del network.wan\nuci commit\n",a.removeSection("network","wan"),b.removeSection("network","wan")):(d+="\nuci set network.wan=interface\n",a.remove("network","wan","type"),getSelectedValue("wan_protocol").match(/wireless/)?(a.remove("network","wan","ifname"),a.set("network","wan","type","bridge")):singleEthernetIsWan()?a.set("network","wan","ifname",defaultLanIf):getSelectedValue("wan_protocol").match(/3g/)?(a.remove("network","wan","ifname"),a.set("network","wan","auto","1")):a.set("network","wan","ifname",defaultWanIf)),document.getElementById("wan_port_to_lan_container").style.display!="none"&&getSelectedValue("wan_port_to_lan")=="bridge"?a.set("network","lan","ifname",defaultLanIf+" "+defaultWanIf):singleEthernetIsWan()?(a.remove("network","lan","ifname"),a.set("network","lan","ifname",wirelessIfs.length>0?wirelessIfs[0]:"")):a.set("network","lan","ifname",defaultLanIf),currentModes=getSelectedValue("wifi_mode");var q="",r="",s="";if(currentModes.match(/ap/)){l&&(q="ap_g",a.set("wireless",q,"","wifi-iface"),a.set("wireless",q,"device",wifiDevG),a.set("wireless",q,"mode","ap"),a.set("wireless",q,"network","lan"),d=d+"uci set wireless."+q+"='wifi-iface' \n"),m&&(apacfg="ap_a",a.set("wireless",apacfg,"","wifi-iface"),a.set("wireless",apacfg,"device",wifiDevA),a.set("wireless",apacfg,"mode","ap"),a.set("wireless",apacfg,"network","lan"),d=d+"uci set wireless."+apacfg+"='wifi-iface' \n",n?r=apacfg:q=apacfg);if(currentModes=="ap+wds"){var t=getTableDataArray(document.getElementById("wifi_wds_mac_table_container").firstChild,1,0),u=[],v=0;for(v=0;v<t.length;v++)u.push(t[v][0]);if(wirelessDriver=="broadcom"){var w=getSelectedValue("wifi_encryption1"),x=w=="none"?"":w=="wep"?document.getElementById("wifi_wep1").value:document.getElementById("wifi_pass1").value,y=document.getElementById("wifi_ssid1").value,v=0;for(v=0;v<u.length;v++){var z=v+3,A="cfg"+z;a.set("wireless",A,"","wifi-iface"),a.set("wireless",A,"device",wifiDevG),a.set("wireless",A,"network","lan"),a.set("wireless",A,"mode","wds"),a.set("wireless",A,"ssid",y),a.set("wireless",A,"bssid",u[v].toLowerCase()),a.set("wireless",A,"encryption",w),w!="none"&&a.set("wireless",A,"key",x),d=d+"\nuci set wireless."+A+"=wifi-iface\n"}}else{var B=[q],C;for(C=0;C<B.length;C++)wcfg=B[C],wirelessDriver=="atheros"&&a.set("wireless",wcfg,"bssid",u.join(" ").toLowerCase()),a.set("wireless",wcfg,"wds","1")}}}if((currentModes.match(/\+/)||!currentModes.match(/ap/))&&currentModes!="disabled"&&currentModes!="ap+wds"){var D=wifiDevG,E=getSelectedValue("wifi_mode"),F=scannedSsids[0].length>0&&E.match(/sta/);if(F){var G=getSelectedValue("wifi_list_ssid2");F=G!="custom",F&&(D=scannedSsids[4][parseInt(G)]=="A"?wifiDevA:wifiDevG)}F||(n?D=getSelectedValue("wifi_client_band")=="5"?wifiDevA:wifiDevG:D=m?wifiDevA:wifiDevG),otherMode=currentModes.replace(/\+?ap\+?/,""),s=otherMode+"cfg",a.set("wireless",s,"","wifi-iface"),a.set("wireless",s,"device",D),a.set("wireless",s,"mode",otherMode),a.set("wireless",s,"network",getSelectedValue("wan_protocol").match(/wireless/)?"wan":"lan"),d=d+"uci set wireless."+s+"='wifi-iface' \n"}d+="uci commit \n",macFilterEnabled=getSelectedValue("mac_filter_enabled")=="enabled";var H=document.getElementById("mac_table_container").firstChild,I=getTableDataArray(H,!0,!1),J=getSelectedValue("mac_filter_policy"),K=I.join(" ");if(wirelessDriver=="broadcom")!macFilterEnabled||K==""?(a.remove("wireless",wifiDevG,policyOption),a.remove("wireless",wifiDevG,"maclist")):(a.set("wireless",wifiDevG,policyOption,J),a.set("wireless",wifiDevG,"maclist",K));else for(wsecIndex=0;wsecIndex<f.length;wsecIndex++){var L=a.get("wireless",f[wsecIndex],"");!macFilterEnabled||K==""||L!="wifi-iface"?(a.remove("wireless",f[wsecIndex],policyOption),a.remove("wireless",f[wsecIndex],"maclist")):(a.set("wireless",f[wsecIndex],policyOption,J),a.set("wireless",f[wsecIndex],"maclist",K))}var M=document.getElementById("lan_dns_altroot").checked;a.remove("dhcp",uciOriginal.getAllSectionsOfType("dhcp","dnsmasq").shift(),"server");if(M){var N=uciOriginal.getAllSectionsOfType("dhcp","dnsmasq").shift();a.createListOption("dhcp",N,"server",!0),a.set("dhcp",N,"server",getAltServerDefs())}var O=uciOriginal.getAllSectionsOfType("firewall","defaults"),P=document.getElementById("lan_dns_force").checked?"1":"";uciOriginal.set("firewall",O[0],"force_router_dns",P),a.set("firewall",O[0],"force_router_dns",P);var Q=P=="1"?"\nuci set firewall.@defaults[0].force_router_dns=1 \n":"\nuci del firewall.@defaults[0].force_router_dns \n";d+=Q;var R=getDhcpSection(uciOriginal),S=document.getElementById("lan_mask").value,T=document.getElementById("lan_ip").value,U=parseInt(T.split(".")[3]),V=parseInt(uciOriginal.get("dhcp",R,"start")),W=V+parseInt(uciOriginal.get("dhcp",R,"limit"))-1;if(!rangeInSubnet(S,T,V,W)||U>=V&&U<=W){var X=getSubnetRange(S,T),Y,Z;U-X[0]>X[1]-U?(Y=X[0],Z=U-1):(Y=U+1,Z=X[1]),a.set("dhcp",R,"start",Y),a.set("dhcp",R,"limit",Z+1-Y)}ppoeReconnectIds=["wan_pppoe_reconnect_pings","wan_pppoe_interval"],wifiSsidId=l?"wifi_ssid1":"wifi_ssid1a",inputIds=["wan_protocol","wan_pppoe_user","wan_pppoe_pass","wan_pppoe_max_idle",ppoeReconnectIds,"wan_static_ip","wan_static_mask","wan_static_gateway","wan_mac","wan_mtu","lan_ip","lan_mask","lan_gateway",wifiSsidId,"wifi_hidden","wifi_isolate","wifi_encryption1","wifi_pass1","wifi_wep1","wifi_server1","wifi_port1","wifi_pass2","wifi_wep2","wan_3g_device","wan_3g_user","wan_3g_pass","wan_3g_apn","wan_3g_pincode","wan_3g_service","wan_3g_isp"],options=["proto","username","password","demand","keepalive","ipaddr","netmask","gateway","macaddr","mtu","ipaddr","netmask","gateway","ssid","hidden","isolate","encryption","key","key","server","port","key","key","device","username","password","apn","pincode","service","mobile_isp"];var $=setVariableFromValue,_=setVariableFromModifiedValue,ab=setVariableFromConcatenation,bb=setVariableConditionally;setFunctions=[$,$,$,_,ab,$,$,$,bb,bb,$,$,$,$,bb,bb,$,$,$,$,$,$,$,$,$,$,$,$,$,$];var cb=!1,db=!0,eb=function(a){return a*60},fb=function(a){return a.toLowerCase()},gb=function(a){return document.getElementById("wan_use_mac").checked==1},hb=function(a){return document.getElementById("wan_use_mtu").checked==1&&document.getElementById("wan_mtu").value!=1500},ib=function(a){return getSelectedValue("wifi_hidden")=="disabled"?1:0},jb=function(a){return getSelectedValue("wifi_isolate")=="enabled"?1:0},kb=[cb,eb],lb=[gb,cb,document.getElementById("wan_mac").value.toLowerCase()],mb=[hb,db,""],nb=[ib,cb,"1"],ob=[jb,cb,"1"];additionalParams=[cb,cb,cb,kb,cb,cb,cb,cb,lb,mb,cb,cb,cb,cb,nb,ob,cb,cb,cb,cb,cb,cb,cb,cb,cb,cb,cb,cb,cb,cb],pppoeReconnectVisibilityIds=["wan_pppoe_reconnect_pings_container","wan_pppoe_interval_container"],multipleVisibilityIds=[pppoeReconnectVisibilityIds],wirelessSections=[q,q,q,q,q,q,q,q,s,s],visibilityIds=[],pkgs=[],sections=[];var pb;for(pb=0;pb<inputIds.length;pb++)isArray(inputIds[pb])?visibilityIds.push(multipleVisibilityIds.shift()):visibilityIds.push(inputIds[pb]+"_container"),pb<10||pb>22?(pkgs.push("network"),sections.push("wan"),a.remove("network","wan",options[pb])):pb<13?(pkgs.push("network"),sections.push("lan"),a.remove("network","lan",options[pb])):(pkgs.push("wireless"),sections.push(wirelessSections.shift()));setVariables(inputIds,visibilityIds,a,pkgs,sections,options,setFunctions,additionalParams);if(getSelectedValue("wifi_mode")!="disabled"){var qb="",rb="";document.getElementById("wifi_ssid2_container").style.display!="none"?(qb=document.getElementById("wifi_ssid2").value,rb=getSelectedValue("wifi_encryption2")):document.getElementById("wifi_custom_ssid2_container").style.display!="none"?(qb=document.getElementById("wifi_custom_ssid2").value,rb=getSelectedValue("wifi_encryption2")):document.getElementById("wifi_list_ssid2_container").style.display!="none"&&(qb=scannedSsids[0][parseInt(getSelectedValue("wifi_list_ssid2"))],rb=scannedSsids[1][parseInt(getSelectedValue("wifi_list_ssid2"))]),qb!=""&&(a.set("wireless",s,"ssid",qb),a.set("wireless",s,"encryption",rb));if(r!=""){var sb=function(b,c,d,e){var f;for(f=0;f<e.length;f++)a.set(b,d,e[f],a.get("wireless",c,e[f]))};a.set("wireless",r,"ssid",document.getElementById("wifi_ssid1a").value),sb("wireless",q,r,["hidden","isolate","encryption","key","server","port"])}}getSelectedValue("wan_protocol")=="none"?a.removeSection("network","wan"):a.set("network","wan","proto",getSelectedValue("wan_protocol").replace(/_.*$/g,"")),a.get("network","lan","proto")===""&&a.set("network","lan","proto","static"),isBcm94704&&a.get("network","wan","type")!="bridge"&&a.get("network","wan","macaddr")==""&&a.set("network","wan","macaddr",defaultWanMac),getSelectedValue("wan_protocol",document)=="pppoe"?a.set("network","wan","defaultroute","1"):a.remove("network","wan","defaultroute");var tb=[];tb.push("/etc/init.d/dnsmasq enable"),tb.push("uci set gargoyle.connection.dhcp=200"),tb.push("uci set gargoyle.firewall.portforwarding=100"),tb.push("uci set gargoyle.firewall.restriction=125"),tb.push("uci set gargoyle.firewall.quotas=175"),tb.push("uci set qos_gargoyle.global.network=wan"),tb.push("uci commit"),k="\n"+tb.join("\n")+"\n"}else{var ub=wifiDevG;if(document.getElementById("bridge_hwmode_container").style.display!="none"){var o=getSelectedValue("bridge_hwmode");ub=o=="11na"?wifiDevA:wifiDevG,wifiDevG==ub&&a.set("wireless",wifiDevG,"hwmode",o)}document.getElementById("bridge_wan_port_to_lan_container").style.display!="none"&&getSelectedValue("bridge_wan_port_to_lan")=="bridge"?a.set("network","lan","ifname",defaultLanIf+" "+defaultWanIf):a.set("network","lan","ifname",defaultLanIf),currentLanIp=document.getElementById("bridge_ip").value,d+="\nuci del network.wan\nuci commit\n",a.removeSection("network","wan"),b.removeSection("network","wan"),a.set("network","lan","ipaddr",document.getElementById("bridge_ip").value),a.set("network","lan","netmask",document.getElementById("bridge_mask").value),a.set("network","lan","gateway",document.getElementById("bridge_gateway").value),a.set("network","lan","dns",document.getElementById("bridge_gateway").value);var y="",w="";document.getElementById("bridge_ssid_container").style.display!="none"?(y=document.getElementById("bridge_ssid").value,w=getSelectedValue("bridge_encryption")):document.getElementById("bridge_custom_ssid_container").style.display!="none"?(y=document.getElementById("bridge_custom_ssid").value,w=getSelectedValue("bridge_encryption")):document.getElementById("bridge_list_ssid_container").style.display!="none"&&(y=scannedSsids[0][parseInt(getSelectedValue("bridge_list_ssid"))],w=scannedSsids[1][parseInt(getSelectedValue("bridge_list_ssid"))]);var x=w=="none"?"":w=="wep"?document.getElementById("bridge_wep").value:document.getElementById("bridge_pass").value;if(getSelectedValue("bridge_mode")=="client_bridge"){a.set("wireless","cfg2","","wifi-iface"),a.set("wireless","cfg2","device",ub),a.set("wireless","cfg2","network","lan"),a.set("wireless","cfg2","mode","sta"),a.set("wireless","cfg2","client_bridge","1"),a.set("wireless","cfg2","ssid",y),a.set("wireless","cfg2","encryption",w),w!="none"&&a.set("wireless","cfg2","key",x),d+="\nuci set wireless.cfg2=wifi-iface\n";if(getSelectedValue("bridge_repeater")=="enabled"&&document.getElementById("bridge_repeater_container").style.display!="none"){var vb=document.getElementById("bridge_broadcast_ssid").value;a.set("wireless","cfg3","","wifi-iface"),a.set("wireless","cfg3","device",ub),a.set("wireless","cfg3","network","lan"),a.set("wireless","cfg3","mode","ap"),a.set("wireless","cfg3","ssid",vb),a.set("wireless","cfg3","encryption",w),w!="none"&&a.set("wireless","cfg3","key",x),d+="\nuci set wireless.cfg3=wifi-iface\n"}}else{var t=getTableDataArray(document.getElementById("bridge_wds_mac_table_container").firstChild),u=[],v=0;for(v=0;v<t.length;v++)u.push(t[v][0].toLowerCase());if(wirelessDriver=="broadcom"){a.set("wireless","cfg2","","wifi-iface"),a.set("wireless","cfg2","device",ub),a.set("wireless","cfg2","network","lan"),a.set("wireless","cfg2","mode","ap"),a.set("wireless","cfg2","ssid",y),a.set("wireless","cfg2","encryption",w),w!="none"&&a.set("wireless","cfg2","key",x),d+="\nuci set wireless.cfg2=wifi-iface\n";for(v=0;v<u.length;v++){var z=v+3,A="cfg"+z;a.set("wireless",A,"","wifi-iface"),a.set("wireless",A,"device",ub),a.set("wireless",A,"network","lan"),a.set("wireless",A,"mode","wds"),a.set("wireless",A,"ssid",y),a.set("wireless",A,"bssid",u[v].toLowerCase()),a.set("wireless",A,"encryption",w),w!="none"&&a.set("wireless",A,"key",x),d=d+"\nuci set wireless."+A+"=wifi-iface\n"}}else{var wb="cfg2";if(wirelessDriver=="atheros"||wirelessDriver=="mac80211"&&getSelectedValue("bridge_repeater")=="enabled")a.set("wireless",wb,"","wifi-iface"),a.set("wireless",wb,"device",ub),a.set("wireless",wb,"network","lan"),a.set("wireless",wb,"mode","ap"),a.set("wireless",wb,"wds","1"),a.set("wireless",wb,"encryption",w),w!="none"&&a.set("wireless",wb,"key",x),wirelessDriver=="atheros"?(a.set("wireless",wb,"ssid",y),a.set("wireless",wb,"bssid",u.join(" ").toLowerCase())):a.set("wireless",wb,"ssid",document.getElementById("bridge_broadcast_ssid").value),d=d+"\nuci set wireless."+wb+"=wifi-iface\n",wb="cfg3";a.set("wireless",wb,"","wifi-iface"),a.set("wireless",wb,"device",ub),a.set("wireless",wb,"network","lan"),a.set("wireless",wb,"mode","sta"),a.set("wireless",wb,"wds","1"),a.set("wireless",wb,"ssid",y),a.set("wireless",wb,"encryption",w),wirelessDriver=="atheros"&&a.set("wireless",wb,"bssid",u.join(" ").toLowerCase()),w!="none"&&a.set("wireless",wb,"key",x),d=d+"\nuci set wireless."+wb+"=wifi-iface\n"}}d+="\nuci commit\n";var tb=[];tb.push("/etc/init.d/dnsmasq disable"),tb.push("/etc/init.d/miniupnpd disable"),tb.push("uci del gargoyle.connection.dhcp"),tb.push("uci del gargoyle.firewall.portforwarding"),tb.push("uci del gargoyle.firewall.restriction"),tb.push("uci del gargoyle.firewall.quotas"),tb.push("uci del gargoyle.firewall.portforwarding"),tb.push("uci set qos_gargoyle.global.network=lan"),tb.push("uci commit"),k="\n"+tb.join("\n")+"\n"}a.remove("network","wan","dns");var xb=a.get("network","lan","gateway");xb=xb==""?a.get("network","lan","ipaddr"):xb;var yb=xb,zb=getSelectedValue("lan_dns_source"),Ab=document.getElementById("global_gateway").checked;if(zb!="isp"){var Bb=[];if(zb=="google"&&Ab)Bb=googleDns;else if(zb=="opendns"&&Ab)Bb=openDns;else{var Cb=getTableDataArray(document.getElementById("lan_dns_table_container").firstChild),Db=0;for(Db=0;Db<Cb.length;Db++)Bb.push(Cb[Db][0])}yb=Bb.length>0?Bb.join(" "):yb,Ab&&a.get("network","wan","")!=""&&yb!=xb&&(a.set("network","wan","dns",yb),a.set("network","wan","peerdns","0"))}else Ab&&a.get("network","wan","")!=""&&a.remove("network","wan","peerdns");a.set("network","lan","dns",yb);var Eb=uciOriginal.get("network","lan","ipaddr");Eb!=currentLanIp&&Eb!=""&&currentLanIp!=""&&(j="\nsh /usr/lib/gargoyle/update_router_ip.sh "+Eb+"  "+currentLanIp);var Fb=a.getScriptCommands(b),Gb=(wirelessDriver=="broadcom"?"\niwconfig wl0 txpower 31\n":"")+"sh /usr/lib/gargoyle/restart_network.sh ;\n";c&&(Gb="\nsh /usr/lib/gargoyle/reboot.sh ;\n");var Hb="\nrm -rf /tmp/cached_basic_vars ;\n/usr/lib/gargoyle/cache_basic_vars.sh >/dev/null 2>/dev/null\n";Fb=d+Fb+j+k+Gb+Hb;var Ib=getParameterDefinition("commands",Fb)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),Jb=function(b){b.readyState==4&&Eb==currentLanIp&&!c&&(uciOriginal=a.clone(),resetData(),setControlsEnabled(!0))};runAjax("POST","utility/run_commands.sh",Ib,Jb);if(Eb!=currentLanIp||c)currentProtocol=location.href.match(/^https:/)?"https":"http",testLocation=currentProtocol+"://"+currentLanIp+":"+window.location.port+"/utility/reboot_test.sh",testReboot=function(){toggleReload=!0,setTimeout("testReboot()",5e3),document.getElementById("reboot_test").src=testLocation},setTimeout("testReboot()",25e3),setTimeout("reloadPage()",24e4)}}function reloadPage(){if(toggleReload){var a=document.getElementById("reboot_test").readyState;if(typeof a=="undefined"||a==null||a=="complete")toggleReload=!1,document.getElementById("reboot_test").src="",currentProtocol=location.href.match(/^https:/)?"https":"http",window.location=currentProtocol+"://"+currentLanIp+":"+window.location.port+window.location.pathname}}function generateWepKey(a){var b=0,c="",d=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];while(b<a)next=d[Math.floor(Math.random()*16)],c+=next,b++;return c}function setToWepKey(a,b){document.getElementById(a).value=generateWepKey(b),proofreadWep(document.getElementById(a))}function proofreadAll(){var a=function(a){return validateLengthRange(a,1,999)},b=function(a){return validateLengthRange(a,8,999)},c=validateIP,d=validateNetMask,e=validateMac,f=validateNumeric,g=validateWep,h=function(a){return validateNumericRange(a,0,getMaxTxPower("G"))},i=function(a){return validateNumericRange(a,0,getMaxTxPower("A"))},j=function(a,b,c){var d=null;if(getSelectedValue(b)==c&&wirelessDriver!="mac80211"){var e=getTableDataArray(document.getElementById(a).firstChild);d=e.length>0?null:"You must specify at least one MAC address in order to enable WDS"}return d},k=[];if(document.getElementById("global_gateway").checked){var l=["wan_pppoe_user","wan_pppoe_pass","wan_pppoe_max_idle","wan_pppoe_reconnect_pings","wan_pppoe_interval","wan_static_ip","wan_static_mask","wan_static_gateway","wan_mac","wan_mtu","lan_ip","lan_mask","lan_gateway","wifi_txpower","wifi_txpower_5ghz","wifi_ssid1","wifi_pass1","wifi_wep1","wifi_server1","wifi_port1","wifi_ssid2","wifi_pass2","wifi_wep2","wan_3g_device","wan_3g_apn"],m=[a,a,f,f,f,c,d,c,e,f,c,d,c,h,i,a,b,g,c,f,a,b,g,a,a],n=new Array,o=new Array,p;for(p=0;p<l.length;p++){n.push(0);var q=l[p],r=q+"_container";o.push(r)}var s=new Array;for(p=0;p<l.length;p++)s.push(l[p]+"_label");k=proofreadFields(l,s,m,n,o);var t=j("wifi_wds_mac_table_container","wifi_mode","ap+wds");t!=null&&k.push(t)}else{var l=["bridge_ip","bridge_mask","bridge_gateway","bridge_txpower","bridge_ssid","bridge_pass","bridge_wep","bridge_broadcast_ssid"],m=[c,d,c,h,a,b,g,a],n=[],o=[],s=[],p=0;for(p=0;p<l.length;p++)n.push(0),o.push(l[p]+"_container"),s.push(l[p]+"_label");k=proofreadFields(l,s,m,n,o);var t=j("bridge_wds_mac_table_container","bridge_mode","wds");t!=null&&k.push(t)}return k}function setGlobalVisibility(){getSelectedValue("wan_protocol").match(/wireless/)?(currentMode=getSelectedValue("wifi_mode"),isb43?(setAllowableSelections("wifi_mode",["sta"],["Client"]),setSelectedValue("wifi_mode","sta")):(setAllowableSelections("wifi_mode",["sta","ap+sta"],["Client","Client+AP"]),setSelectedValue("wifi_mode",currentMode.match(/ap/)?"ap+sta":"sta"))):(currentMode=getSelectedValue("wifi_mode"),setAllowableSelections("wifi_mode",["ap","ap+wds","adhoc","disabled"],["Access Point (AP)","AP+WDS","Ad Hoc","Disabled"]),currentMode=="ap+sta"||currentMode=="sta"?setSelectedValue("wifi_mode","ap"):setSelectedValue("wifi_mode",currentMode)),hasUSB==0?setAllowableSelections("wan_protocol",["dhcp_wired","pppoe_wired","static_wired","dhcp_wireless","static_wireless","none"],["DHCP (有线)","PPPoE (有线)","静态IP (有线)","DHCP (无线)","静态IP (无线)","已禁用"]):setAllowableSelections("wan_protocol",["dhcp_wired","pppoe_wired","static_wired","dhcp_wireless","static_wireless","3g","none"],["DHCP (Wired)","PPPoE (Wired)","Static IP (Wired)","DHCP (Wireless)","Static IP (Wireless)","3G (GSM)","Disabled"]),setVisibility(["wan_port_to_lan_container"],(getSelectedValue("wan_protocol").match(/wireless/)||getSelectedValue("wan_protocol").match(/3g/))&&!singleEthernetPort()?[1]:[0]),setWanVisibility(),setWifiVisibility()}function setWanVisibility(){var a=["wan_dhcp_ip_container","wan_dhcp_expires_container","wan_pppoe_user_container","wan_pppoe_pass_container","wan_pppoe_reconnect_mode_container","wan_pppoe_max_idle_container","wan_pppoe_reconnect_pings_container","wan_pppoe_interval_container","wan_static_ip_container","wan_static_mask_container","wan_static_gateway_container","wan_mac_container","wan_mtu_container","lan_gateway_container","wan_3g_device_container","wan_3g_user_container","wan_3g_pass_container","wan_3g_apn_container","wan_3g_pincode_container","wan_3g_service_container","wan_3g_isp_container"],b=5,c=getSelectedValue("wan_protocol").match(/wireless/)?0:1,d=[1,1,0,0,0,0,0,0,0,0,0,c,c,0,0,0,0,0,0,0,0],e=[0,0,1,1,1,1,1,1,0,0,0,c,c,0,0,0,0,0,0,0,0],f=[0,0,0,0,0,0,0,0,1,1,1,c,c,0,0,0,0,0,0,0,0],g=[0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],h=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1],i=new Array;i.dhcp=d,i.pppoe=e,i["static"]=f,i.none=g,i["3g"]=h;var j=i[getSelectedValue("wan_protocol").replace(/_.*$/g,"")];j[b]=j[b]==1&&document.getElementById("wan_pppoe_reconnect_mode").value=="demand"?1:0,j[b+1]=j[b+1]==1&&document.getElementById("wan_pppoe_reconnect_mode").value=="keepalive"?1:0,j[b+2]=j[b+2]==1&&document.getElementById("wan_pppoe_reconnect_mode").value=="keepalive"?1:0,setVisibility(a,j)}function setWifiVisibility(){var a=getSelectedValue("wifi_mode");a=="ap+wds"?setAllowableSelections("wifi_encryption1",["none","psk2","psk","wep"],["None","WPA2 PSK","WPA PSK","WEP"]):setAllowableSelections("wifi_encryption1",["none","psk2","psk","wep","wpa","wpa2"],["None","WPA2 PSK","WPA PSK","WEP","WPA RADIUS","WPA2 RADIUS"]),a=="adhoc"?(setAllowableSelections("wifi_encryption2",["none","wep"],["None","WEP"]),document.getElementById("wifi_ssid2_label").firstChild.data="SSID:"):(document.getElementById("wifi_ssid2_label").firstChild.data="SSID to Join:",setAllowableSelections("wifi_encryption2",["none","psk2","psk","wep"],["None","WPA2 PSK","WPA PSK","WEP"]));var b=["11ng","11g","11b"],c=["N+G+B","G+B","B"];if(wifiN&&dualBandWireless){b.splice(1,0,"11na"),c.splice(1,0,"N+A");if(a.match(/ap/)||a.match(/disabled/))b.unshift("dual"),c.unshift("Dual Band")}setAllowableSelections("wifi_hwmode",b,c);var d=["internal_divider1","wifi_hwmode_container","wifi_channel_width_container","wifi_txpower_container","wifi_channel_width_5ghz_container","wifi_txpower_5ghz_container","mac_enabled_container","mac_filter_container","wifi_ssid1_container","wifi_ssid1a_container","wifi_channel1_container","wifi_fixed_channel1_container","wifi_channel1_5ghz_container","wifi_hidden_container","wifi_isolate_container","wifi_encryption1_container","wifi_pass1_container","wifi_wep1_container","wifi_server1_container","wifi_port1_container","wifi_mac_container","wifi_wds_container","internal_divider2","wifi_list_ssid2_container","wifi_custom_ssid2_container","wifi_ssid2_container","wifi_scan_button","wifi_channel2_container","wifi_fixed_channel2_container","wifi_channel2_5ghz_container","wifi_client_band_container","wifi_encryption2_container","wifi_fixed_encryption2_container","wifi_pass2_container","wifi_wep2_container"],e=wifiN?1:0,f=!e||getSelectedValue("wifi_hwmode")!="11na"&&getSelectedValue("wifi_hwmode")!="dual"?0:1,g=e&&getSelectedValue("wifi_hwmode")=="11na"?1:0,h=g==1?0:1,i=e&&g==0,j=getSelectedValue("mac_filter_enabled")=="enabled"?1:0,k=document.getElementById("wifi_encryption1").value,l=k!="none"&&k!="wep"?1:0,m=k=="wep"?1:0,n=k=="wpa"||k=="wpa2"?1:0,o=document.getElementById("wifi_fixed_encryption2").style.display!="none"?document.getElementById("wifi_fixed_encryption2").firstChild.data:getSelectedValue("wifi_encryption2"),p=wifiN?0:1,q=o.match(/psk/)||o.match(/WPA/)?1:0,r=o.match(/wep/)||o.match(/WEP/)?1:0,s=new Array;s.ap=[1,e,i,h,f,f,1,j,1,f,1,0,f,1,1,1,l,m,n,n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],s["ap+wds"]=[1,e,i,h,f,f,1,j,1,0,1,0,0,1,1,1,l,m,n,n,p,p,0,0,0,0,0,0,0,0,0,0,0,0,0],s.sta=[1,e,i,h,f,f,1,j,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,h,0,g,0,1,0,q,r],s["ap+sta"]=[1,e,i,h,f,f,1,j,1,f,1,0,f,1,1,1,l,m,n,n,0,0,1,0,0,1,1,h,0,g,f,1,0,q,r],s.adhoc=[1,e,i,h,f,f,1,j,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,h,0,g,0,1,0,q,r],s.disabled=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];var t=s[a];setVisibility(d,t),a.match(/sta/)&&setSsidVisibility("wifi_list_ssid2"),a!="disabled"&&setHwMode(document.getElementById("wifi_hwmode"))}function setBridgeVisibility(){showIds=document.getElementById("global_gateway").checked?["wan_fieldset","lan_fieldset","wifi_fieldset"]:["bridge_fieldset"],hideIds=document.getElementById("global_gateway").checked?["bridge_fieldset"]:["wan_fieldset","lan_fieldset","wifi_fieldset"];var a=[hideIds,showIds],b;for(b=0;b<2;b++){var c=a[b],d;for(d=0;d<c.length;d++)document.getElementById(c[d]).style.display=b==0?"none":"block"}singleEthernetPort()?document.getElementById("bridge_wan_port_to_lan_container").style.display="none":document.getElementById("bridge_wan_port_to_lan_container").style.display="block";if(document.getElementById("global_bridge").checked){var e=document.getElementById("bridge_fixed_encryption_container").style.display=="none"?getSelectedValue("bridge_encryption"):document.getElementById("bridge_fixed_encryption").firstChild.data;document.getElementById("bridge_pass_container").style.display=e.match(/psk/)||e.match(/WPA/)?"block":"none",document.getElementById("bridge_wep_container").style.display=e.match(/wep/)||e.match(/WEP/)?"block":"none";var f=getSelectedValue("bridge_mode"),g=f=="client_bridge"&&!isb43||f=="wds"&&wirelessDriver=="mac80211";document.getElementById("bridge_repeater_container").style.display=g?"block":"none",document.getElementById("bridge_wifi_mac_container").style.display=f=="wds"&&wirelessDriver!="mac80211"?"block":"none",document.getElementById("bridge_wds_container").style.display=f=="wds"&&wirelessDriver!="mac80211"?"block":"none",document.getElementById("bridge_fixed_encryption_container").style.display="none",document.getElementById("bridge_fixed_channel_container").style.display="none",document.getElementById("bridge_broadcast_ssid_container").style.display=g&&getSelectedValue("bridge_repeater")=="enabled"?"block":"none";if(document.getElementById("bridge_broadcast_ssid").value==""){var h="";document.getElementById("bridge_ssid_container").style.display!="none"?h=document.getElementById("bridge_ssid").value:document.getElementById("bridge_custom_ssid_container").style.display!="none"?h=document.getElementById("bridge_custom_ssid").value:document.getElementById("bridge_list_ssid_container").style.display!="none"&&(h=scannedSsids[0][parseInt(getSelectedValue("bridge_list_ssid"))]),document.getElementById("bridge_broadcast_ssid").value=h}setSsidVisibility("bridge_list_ssid")}setHwMode(document.getElementById("bridge_hwmode")),setGlobalVisibility()}function localdate(a){var b=function(a){var b=""+a;return b=b.length==1?"0"+b:b,b},c="",d=uciOriginal.get("gargoyle","global","dateformat"),e=b(a.getUTCFullYear()%100),f=a.getUTCFullYear(),g=b(a.getUTCMonth()+1),h=b(a.getUTCDate()),i=" "+b(a.getUTCHours())+":"+b(a.getUTCMinutes())+" "+timezoneName;return d=="iso"?c=f+"/"+g+"/"+h+i:d=="iso8601"?c=f+"-"+g+"-"+h+i:d=="australia"?c=h+"/"+g+"/"+e+i:d=="russia"?c=h+"."+g+"."+f+i:c=g+"/"+h+"/"+e+i,c}function resetData(){var a=[];wirelessDriver=="broadcom"?a.push("auto"):wirelessDriver=="atheros"?(a.push("12"),a.push("13"),a.push("14")):wirelessDriver=="mac80211"&&(setAllowableSelections("bridge_channel",mac80211Channels.G,mac80211Channels.G,document),setAllowableSelections("wifi_channel1",mac80211Channels.G,mac80211Channels.G,document),setAllowableSelections("wifi_channel2",mac80211Channels.G,mac80211Channels.G,document),mac80211Channels["A"]!=null&&(setAllowableSelections("wifi_channel1_5ghz",mac80211Channels.A,mac80211Channels.A,document),setAllowableSelections("bridge_channel_5ghz",mac80211Channels.A,mac80211Channels.A,document)));while(a.length>0){var b=a.shift();removeOptionFromSelectElement("bridge_channel",b,document),removeOptionFromSelectElement("wifi_channel1",b,document),removeOptionFromSelectElement("wifi_channel2",b,document)}if(leaseStart!=""){setElementEnabled(document.getElementById("dhcp_renew_button"),!0);var c=new Date,d=parseInt(currentDateSeconds)-parseInt(uptime)+parseInt(leaseStart);c.setTime(d*1e3+parseInt(leaseLifetime)*1e3+timezoneOffset*1e3),setChildText("dhcp_expires",localdate(c)),setChildText("dhcp_ip",currentWanIp)}else setElementEnabled(document.getElementById("dhcp_renew_button"),!1);setChildText("bridge_wifi_mac",currentWirelessMacs[0],null,null,null),setChildText("wifi_mac",currentWirelessMacs[0],null,null,null);var e=isBridge(uciOriginal),f=!e;document.getElementById("global_gateway").checked=f,document.getElementById("global_bridge").checked=e,document.getElementById("bridge_ip").value=uciOriginal.get("network","lan","ipaddr"),document.getElementById("bridge_mask").value=uciOriginal.get("network","lan","netmask"),document.getElementById("bridge_gateway").value=uciOriginal.get("network","lan","gateway");var g=[];if(e){var h=getBridgeSection(uciOriginal),i=uciOriginal.get("wireless",h,"client_bridge")=="1"?"client_bridge":"wds";setSelectedValue("bridge_mode",i),document.getElementById("bridge_ssid").value=uciOriginal.get("wireless",h,"ssid");var j="",k=uciOriginal.getAllSectionsOfType("wireless","wifi-iface"),l=0;for(l=0;l<k.length&&(i!="wds"||wirelessDriver=="mac80211")&&j=="";l++){var m=k[l];j=uciOriginal.get("wireless",m,"mode")=="ap"?m:""}setSelectedValue("bridge_repeater",j==""?"disabled":"enabled");var n=uciOriginal.get("wireless",h,"encryption");n=n==""?"none":n,setSelectedValue("bridge_encryption",n),document.getElementById("bridge_wep").value=n=="wep"?uciOriginal.get("wireless",h,"key"):"",document.getElementById("bridge_pass").value=n!="wep"&&n!="none"?uciOriginal.get("wireless",h,"key"):"",document.getElementById("bridge_broadcast_ssid").value=j==""?uciOriginal.get("wireless",h,"ssid"):uciOriginal.get("wireless",j,"ssid");if(i=="wds")if(wirelessDriver=="broadcom"){var o=uciOriginal.getAllSectionsOfType("wireless","wifi-iface"),p;for(p=0;p<o.length;p++)if(uciOriginal.get("wireless",o[p],"mode")=="wds"){var q=uciOriginal.get("wireless",o[p],"bssid");g.push([q.toUpperCase()])}}else if(wirelessDriver=="atheros"){var r=uciOriginal.get("wireless",h,"bssid").split(/[\t ]+/
),s;for(s=0;s<r.length;s++)g.push([r[s].toUpperCase()])}}else setSelectedValue("bridge_mode","client_bridge"),setSelectedValue("bridge_repeater","enabled"),document.getElementById("bridge_ssid").value="Gargoyle",setSelectedValue("bridge_channel",wirelessDriver=="atheros"?"auto":"5"),setSelectedValue("bridge_encryption","none");var t=createTable([""],g,"bridge_wds_mac_table",!0,!1),u=document.getElementById("bridge_wds_mac_table_container");u.firstChild!=null&&u.removeChild(u.firstChild),u.appendChild(t);var v=!1,w=0;for(w=0;w<wirelessIfs.length;w++)v=uciOriginal.get("network","wan","ifname")==wirelessIfs[w];if(isBcm94704&&!v&&uciOriginal.get("network","wan","macaddr")!=""){var x=uciOriginal.get("network","wan","macaddr").toUpperCase(),y=x.substr(0,15),z=x.substr(15,2),A=0;for(A=0;A<allLanMacs.length;A++){var B=allLanMacs[A].toUpperCase(),C=B.substr(0,15),D=B.substr(15,2);C==y&&Math.abs(parseInt(D,16)-parseInt(z,16))==1&&(defaultWanMac=x)}}var E=uciOriginal.get("network","wan","proto"),F=uciOriginal.get("network","wan","ifname"),G=uciOriginal.get("network","wan","type"),H=uciOriginal.get("network","lan","ifname"),I=F==""&&G=="bridge"&&(getWirelessMode(uciOriginal)=="sta"||getWirelessMode(uciOriginal)=="ap+sta");E=E==""?"none":E,E!="none"&&E!="3g"&&(E=I?E+"_wireless":E+"_wired"),setSelectedValue("wan_protocol",E);var J=H.indexOf(defaultWanIf)<0?"disable":"bridge";setSelectedValue("bridge_wan_port_to_lan",J),setSelectedValue("wan_port_to_lan",J),networkIds=["wan_pppoe_user","wan_pppoe_pass","wan_pppoe_max_idle","wan_pppoe_reconnect_pings","wan_pppoe_interval","wan_static_ip","wan_static_mask","wan_static_gateway","wan_use_mac","wan_mac","wan_use_mtu","wan_mtu","lan_ip","lan_mask","lan_gateway","wan_3g_device","wan_3g_user","wan_3g_pass","wan_3g_apn","wan_3g_pincode","wan_3g_service","wan_3g_isp"],networkPkgs=new Array;for(idIndex in networkIds)networkPkgs.push("network");networkSections=["wan","wan","wan","wan","wan","wan","wan","wan","wan","wan","wan","wan","lan","lan","lan","wan","wan","wan","wan","wan","wan","wan"],networkOptions=["username","password","demand","keepalive","keepalive","ipaddr","netmask","gateway","macaddr","macaddr","mtu","mtu","ipaddr","netmask","gateway","device","username","password","apn","pincode","service","mobile_isp"],pppoeDemandParams=[300,1/60],pppoeReconnectParams=[3,0],pppoeIntervalParams=[5,1],useMtuTest=function(a){return a==""||a==null||a==1500?!1:!0},useMacTest=function(a){return a=a==null?"":a,a==""||a.toLowerCase()==defaultWanMac.toLowerCase()?!1:!0},networkParams=["","",pppoeDemandParams,pppoeReconnectParams,pppoeIntervalParams,"10.1.1.10","255.255.255.0","127.0.0.1",useMacTest,defaultWanMac,useMtuTest,1500,"192.168.1.1","255.255.255.0","192.168.1.1","/dev/ttyUSB0","","","internet","","umts","custom"];var K=uciOriginal.getAllSectionsOfType("firewall","defaults");lv=loadValueFromVariable,lsv=loadSelectedValueFromVariable,lvm=loadValueFromVariableMultiple,lvi=loadValueFromVariableAtIndex,lc=loadChecked,networkFunctions=[lv,lv,lvm,lvi,lvi,lv,lv,lv,lc,lv,lc,lv,lv,lv,lv,lv,lv,lv,lv,lv,lv,lv],loadVariables(uciOriginal,networkIds,networkPkgs,networkSections,networkOptions,networkParams,networkFunctions),uciOriginal.get("network","wan","proto")==""&&(document.getElementById("wan_protocol").value="none"),enableAssociatedField(document.getElementById("wan_use_mac"),"wan_mac",defaultWanMac),enableAssociatedField(document.getElementById("wan_use_mtu"),"wan_mtu",1500),keepalive=uciOriginal.get("network","wan","keepalive"),demand=uciOriginal.get("network","wan","demand"),reconnect_mode=keepalive!=""||demand==""?"keepalive":"demand",document.getElementById("wan_pppoe_reconnect_mode").value=reconnect_mode,document.getElementById("lan_dns_force").checked=uciOriginal.get("firewall",K[0],"force_router_dns")=="1",document.getElementById("lan_dns_altroot").checked=uciOriginal.get("dhcp",uciOriginal.getAllSectionsOfType("dhcp","dnsmasq").shift(),"server")instanceof Array;var L=uciOriginal.get("network","lan","dns").split(/[\t ]+/),M=uciOriginal.get("network","lan","ipaddr"),N=uciOriginal.get("network","lan","gateway"),O=0,P=[];for(O=0;O<L.length;O++){var Q=L[O],R=!e&&Q==M,S=e&&Q==N;!R&&!S&&validateIP(Q)==0&&P.push([Q])}var T="custom";if(P.length==0)T="isp";else if(P.join(",")==openDns.join(",")||P.join(",")==openDns.reverse().join(","))T="opendns";else if(P.join(",")==googleDns.join(",")||P.join(",")==googleDns.reverse().join(","))T="google";setSelectedValue("lan_dns_source",T),setDnsSource(document.getElementById("lan_dns_source"));var U=createTable([""],T=="custom"?P:[],"lan_dns_table",!0,!1),V=document.getElementById("lan_dns_table_container");V.firstChild!=null&&V.removeChild(V.firstChild),V.appendChild(U);var W=createTable([""],T=="custom"?P:[],"bridge_dns_table",!0,!1),X=document.getElementById("bridge_dns_table_container");X.firstChild!=null&&X.removeChild(X.firstChild),X.appendChild(W);var Y=uciOriginal.getAllSectionsOfType("wireless","wifi-iface"),Z="",$="",_="",ab="",bb=0;for(bb=0;bb<Y.length;bb++){var cb=Y[bb],db=uciOriginal.get("wireless",cb,"mode"),eb=uciOriginal.get("wireless",cb,"device");Z=db=="ap"&&eb!=wifiDevA?cb:Z,$=db=="ap"&&eb==wifiDevA?cb:$,_=db!="ap"&&db!="wds"?cb:_,ab=db!="ap"&&db!="wds"?eb:ab}var fb=Z,gb=$,hb=Z!=""||$!=""?"G":"";fb==""&&gb!=""&&(Z=$,$="",hb="A");if(wifiN){var ib=uciOriginal.get("wireless",wifiDevG,"htmode"),jb=uciOriginal.get("wireless",wifiDevA,"htmode");setSelectedValue("wifi_channel_width",ib),setSelectedValue("wifi_channel_width_5ghz",jb),setSelectedValue("bridge_channel_width",ib),setSelectedValue("bridge_channel_width_5ghz",jb),setChannelWidth(document.getElementById("wifi_channel_width"),"G"),setChannelWidth(document.getElementById("wifi_channel_width_5ghz"),"A"),document.getElementById("bridge_channel_width_container").style.display="block"}else document.getElementById("bridge_channel_width_container").style.display="none";if(wifiN){var kb=uciOriginal.get("wireless",wifiDevG,"hwmode");kb=kb==""?"11g":kb,dualBandWireless&&(setAllowableSelections("wifi_hwmode",["dual","11ng","11na","11g","11b"],["Dual Band","N+G+B","N+A","G+B","B"]),setAllowableSelections("bridge_hwmode",["11ng","11na","11g","11b"],["N+G+B","N+A","G+B","B"]),kb=$!=""&&Z!=""||Z==""&&$==""||hb=="A"&&ab==wifiDevG||hb=="G"&&ab==wifiDevA?"dual":kb,kb=fb!=""||gb==""&&ab!=wifiDevA?kb:"11na"),setSelectedValue("wifi_hwmode",kb),setSelectedValue("bridge_hwmode",kb=="dual"?"11ng":kb),kb=="dual"&&ab!=""&&setSelectedValue("wifi_client_band",ab==wifiDevA?"5":"2.4")}else document.getElementById("bridge_hwmode_container").style.display="none";var lb=["wifi_channel1","wifi_channel2","wifi_channel1_5ghz","wifi_channel2_5ghz","wifi_ssid1","wifi_ssid1a","wifi_encryption1","wifi_pass1","wifi_wep1","wifi_server1","wifi_port1","wifi_ssid2","wifi_encryption2","wifi_pass2","wifi_wep2"],mb=new Array,nb;for(nb=0;nb<lb.length;nb++)mb.push("wireless");var ob=[wifiDevG,wifiDevG,wifiDevA,wifiDevA,fb,gb,Z,Z,Z,Z,Z,_,_,_,_],pb=["channel","channel","channel","channel","ssid","ssid","encryption","key","key","server","port","ssid","encryption","key","key"],qb=[wirelessDriver=="atheros"?"auto":"5",wirelessDriver=="atheros"?"auto":"5","36","36","Gargoyle","Gargoyle_5GHz","none","","","","","ExistingWireless","none","",""],rb=[lsv,lsv,lsv,lsv,lv,lv,lsv,lv,lv,lv,lv,lv,lsv,lv,lv];loadVariables(uciOriginal,lb,mb,ob,pb,qb,rb),setSelectedValue("wifi_hidden",uciOriginal.get("wireless",Z,"hidden")==1?"disabled":"enabled"),setSelectedValue("wifi_isolate",uciOriginal.get("wireless",Z,"isolate")==1?"enabled":"disabled");var sb=function(a,b,c,d){var e=uciOriginal.get("wireless",c,"txpower"),f=e==""?"max":"custom";setSelectedValue(a,f),f=="custom"&&(document.getElementById(b).value=e),updateTxPower(a,b,d)};sb("wifi_max_txpower","wifi_txpower",wifiDevG,"G"),wifiDevA!=""&&sb("wifi_max_txpower_5ghz","wifi_txpower_5ghz",wifiDevA,"A"),setSelectedValue("bridge_channel",uciOriginal.get("wireless",wifiDevG,"channel")),setSelectedValue("mac_filter_enabled","disabled");var tb="",ub="";if(wirelessDriver=="broadcom")ub=uciOriginal.get("wireless",wifiDevG,policyOption),tb=uciOriginal.get("wireless",wifiDevG,"maclist"),setSelectedValue("mac_filter_enabled",ub!="allow"&&ub!="deny"&&ub!="1"&&ub!="2"||tb==""?"disabled":"enabled");else for(wsecIndex=0;wsecIndex<Y.length&&getSelectedValue("mac_filter_enabled")=="disabled";wsecIndex++)tb=uciOriginal.get("wireless",Y[wsecIndex],"maclist"),tb!=""&&(ub=uciOriginal.get("wireless",Y[wsecIndex],policyOption),setSelectedValue("mac_filter_enabled","enabled"));ub=="1"||ub=="deny"?setSelectedValue("mac_filter_policy","deny"):setSelectedValue("mac_filter_policy","allow"),macList=tb.split(/[;,\t ]+/),macTableData=[];if(tb.match(/:/))for(macIndex=0;macIndex<macList.length;macIndex++)macTableData.push([macList[macIndex]]);macTable=createTable([""],macTableData,"mac_table",!0,!1),tableContainer=document.getElementById("mac_table_container"),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild),tableContainer.appendChild(macTable),encryptNum=1;while(encryptNum<=2)encMode=document.getElementById("wifi_encryption"+encryptNum).value,encMode=="wep"?document.getElementById("wifi_pass"+encryptNum).value="":encMode!="none"?document.getElementById("wifi_wep"+encryptNum).value="":(document.getElementById("wifi_pass"+encryptNum).value="",document.getElementById("wifi_wep"+encryptNum).value=""),encryptNum++;var vb=[];if(Z!=""){var wb=0,xb=!1;for(wb=0;wb<Y.length&&!xb;wb++)if(wirelessDriver=="broadcom")uciOriginal.get("wireless",Y[wb],"mode")=="wds"&&(vb.push([uciOriginal.get("wireless",Y[wb],"bssid").toUpperCase()]),setSelectedValue("wifi_mode","ap+wds"));else if(wirelessDriver=="atheros"&&uciOriginal.get("wireless",Y[wb],"wds")=="1"){xb=!0;var yb=uciOriginal.get("wireless",Y[wb],"bssid").split(/[\t ]+/),s=0;for(s=0;s<yb.length;s++)vb.push([yb[s].toUpperCase()]),setSelectedValue("wifi_mode","ap+wds")}}var zb=createTable([""],vb,"wifi_wds_mac_table",!0,!1),Ab=document.getElementById("wifi_wds_mac_table_container");Ab.firstChild!=null&&Ab.removeChild(Ab.firstChild),Ab.appendChild(zb),resetWirelessMode(),proofreadAll(),setBridgeVisibility(),showApn(),updateApnDetails()}function updateApnDetails(){mobile_isp=getSelectedValue("wan_3g_isp");if(mobile_isp=="custom")setElementEnabled(document.getElementById("wan_3g_apn"),!0,document.getElementById("wan_3g_apn").value),setElementEnabled(document.getElementById("wan_3g_user"),!0,document.getElementById("wan_3g_user").value),setElementEnabled(document.getElementById("wan_3g_pass"),!0,document.getElementById("wan_3g_pass").value);else for(apnIndex=0;apnIndex<apns.length;apnIndex++)if(mobile_isp==apns[apnIndex][0]){setElementEnabled(document.getElementById("wan_3g_apn"),!1,apns[apnIndex][1]),setElementEnabled(document.getElementById("wan_3g_user"),!1,apns[apnIndex][2]),setElementEnabled(document.getElementById("wan_3g_pass"),!1,apns[apnIndex][3]),document.getElementById("wan_3g_pass").value=apns[apnIndex][3];break}}function setChannel(a){var b=getSelectedValue(a.id);a.id.match("5ghz")?(setSelectedValue("wifi_channel1_5ghz",b),setSelectedValue("wifi_channel2_5ghz",b),setSelectedValue("bridge_channel_5ghz",b),updateTxPower("wifi_max_txpower_5ghz","wifi_txpower_5ghz","A")):(setSelectedValue("wifi_channel1",b),setSelectedValue("wifi_channel2",b),setSelectedValue("bridge_channel",b),updateTxPower("wifi_max_txpower","wifi_txpower","G"))}function resetWirelessMode(){setSelectedValue("wifi_mode",getWirelessMode(uciOriginal))}function validateWep(a){return validateHex(a)!=0||a.length!=10&&a.length!=26?1:0}function proofreadWep(a){proofreadText(a,validateWep,0)}function addTextToSingleColumnTable(a,b,c,d,e,f,g){var h=document.getElementById(a).value;if(c(h)!=e)alert("ERROR: Specified "+g+" is not valid.");else{h=d(h);var i=document.getElementById(b).firstChild,j=getTableDataArray(i,!0,!1),k=!1,l=0;for(l=0;l<j.length;l++){var m=j[l];k=k||h==m[0]}k&&!f?alert("ERROR: Duplicate "+g):(addTableRow(i,[h],!0,!1,null,null),document.getElementById(a).value="")}}function setDnsSource(a){var b=getSelectedValue(a.id),c=b=="custom"?"custom":"gateway",d=b=="gateway"?"isp":b;setSelectedValue("lan_dns_source",d),setSelectedValue("bridge_dns_source",c),document.getElementById("lan_dns_custom_container").style.display=b=="custom"?"block":"none",document.getElementById("bridge_dns_custom_container").style.display=b=="custom"?"block":"none"}function addDns(a){var b="add_"+a+"_dns";addIp=document.getElementById(b).value,addTextToSingleColumnTable(b,"lan_dns_table_container",validateIP,function(a){return a},0,!1,"IP"),addIp!=""&&document.getElementById(b).value==""&&(document.getElementById(b).value=addIp,addTextToSingleColumnTable("add_"+a+"_dns","bridge_dns_table_container",validateIP,function(a){return a},0,!1,"IP"))}function addMacToWds(a){var b="add_"+a+"_wds_mac",c=a+"_wds_mac_table_container";addTextToSingleColumnTable(b,c,validateMac,function(a){return a.toUpperCase()},0,!1,"MAC")}function addMacToFilter(){addTextToSingleColumnTable("add_mac","mac_table_container",validateMac,function(a){return a.toUpperCase()},0,!1,"MAC")}function scanWifi(a){setControlsEnabled(!1,!0,"Scanning For Wifi Networks");var b=getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),c=function(b){if(b.readyState==4){scannedSsids=parseWifiScan(b.responseText);if(scannedSsids[0].length>0){var c=document.getElementById(a).value;document.getElementById("wifi_custom_ssid2").value=c,document.getElementById("bridge_custom_ssid").value=c;var d=[],e=[],f=0;for(f=0;f<scannedSsids[0].length;f++){var g=scannedSsids[0][f],h=scannedSsids[1][f],i=scannedSsids[3][f];h=h=="none"?"Open":h.replace(/psk/g,"wpa").toUpperCase();if(wifiN&&dualBandWireless){var j=scannedSsids[4][f]=="A"?"5GHz":"2.4GHz";d.push(g+" ("+h+", "+i+"% Signal, "+j+")")}else d.push(g+" ("+h+", "+i+"% Signal)");e.push(f+"")}d.push("Other"),e.push("custom"),setAllowableSelections("wifi_list_ssid2",e,d),setAllowableSelections("bridge_list_ssid",e,d);var k=-1,l,m=document.getElementById(a).value;for(l=0;l<scannedSsids[0].length&&k<0;l++)k=scannedSsids[0][l]==m?l:k;k<0&&(k=m=="Gargoyle"||m=="OpenWrt"||m==""?"0":"custom"),setSelectedValue("wifi_list_ssid2",k+""),setSelectedValue("bridge_list_ssid",k+"")}else alert("No Wireless Networks found!");setSsidVisibility("wifi_list_ssid2"),setControlsEnabled(!0)}};runAjax("POST","utility/scan_wifi.sh",b,c)}function setSsidVisibility(a){var b=["bridge_list_ssid_container","bridge_custom_ssid_container","bridge_ssid_container","bridge_channel_container","bridge_fixed_channel_container","bridge_encryption_container","bridge_fixed_encryption_container","wifi_list_ssid2_container","wifi_custom_ssid2_container","wifi_ssid2_container","wifi_channel2_container","wifi_fixed_channel2_container","wifi_encryption2_container","wifi_fixed_encryption2_container","wifi_channel1_container","wifi_fixed_channel1_container","wifi_pass2_container","wifi_wep2_container","bridge_pass_container","bridge_wep_container"],c=getSelectedValue("wifi_mode").match(/ap/)&&document.getElementById("global_gateway").checked?1:0;if(scannedSsids[0].length>0){var d=getSelectedValue(a);setSelectedValue("bridge_list_ssid",d),setSelectedValue("wifi_list_ssid2",d);var e=d=="custom"?1:0,f=e==0?1:0;if(f){d=parseInt(d);var g=scannedSsids[1][d],h=scannedSsids[2][d],i=scannedSsids[4][d],j=["11ng","11g","11b"],k=["N+G+B","G+B","B"];i=="A"&&(j=["11na"],k=["N+A"]),wifiN&&dualBandWireless&&c&&(j.unshift("dual"),k.unshift("Dual Band"));var l=getSelectedValue("wifi_hwmode");setAllowableSelections("wifi_hwmode",j,k),setAllowableSelections("bridge_hwmode",j,k),i=="A"&&l!="dual"&&l!="11na"&&setSelectedValue("wifi_hwmode","dual"),setSelectedValue("wifi_encryption2",g),setSelectedValue("bridge_encryption",g);var g=getSelectedText("wifi_encryption2");setChildText("wifi_fixed_encryption2",g),setChildText("bridge_fixed_encryption",g);var m="wifi_channel1"+(i=="A"?"_5ghz":""),n="wifi_channel2"+(i=="A"?"_5ghz":""),o="bridge_channel"+(i=="A"?"_5ghz":"");setSelectedValue(m,h),setSelectedValue(n,h),setSelectedValue(o,h),setChildText("wifi_fixed_channel1",h),setChildText("wifi_fixed_channel2",h),setChildText("bridge_fixed_channel",h)}var p=getSelectedValue("bridge_encryption"),q=getSelectedValue("wifi_encryption2"),r=p.match(/psk/)||p.match(/WPA/)?1:0,s=p.match(/wep/)||p.match(/WEP/)?1:0,t=q.match(/psk/)||q.match(/WPA/)?1:0,u=q.match(/wep/)||q.match(/WEP/)?1:0;setVisibility(b,[1,e,0,e,f,e,f,1,e,0,e,f,e,f,e*c,f*c,t,u,r,s])}else{var p=getSelectedValue("bridge_encryption"),q=getSelectedValue("wifi_encryption2"),r=p.match(/psk/)||p.match(/WPA/)?1:0,s=p.match(/wep/)||p.match(/WEP/)?1:0,t=q.match(/psk/)||q.match(/WPA/)?1:0,u=q.match(/wep/)||q.match(/WEP/)?1:0;setVisibility(b,[0,0,1,1,0,1,0,0,0,1,1,0,1,0,c,0,t,u,r,s])}setHwMode(document.getElementById("wifi_hwmode"))}function parseWifiScan(a){var b=[[],[],[],[],[]],c=a.split(/Cell/);c.shift();var d=function(a,b){var c=[],d;for(d=0;d<b.length;d++){var e=b[d],f=e.indexOf(a),g=e.indexOf(":"),h=e.indexOf("="),i=g;if(i<0||h>=0&&h<i)i=h;if(f>=0&&i>f){var j=e.substr(i+1);j=j.replace(/^[^\"]*\"/g,""),j=j.replace(/\".*$/g,""),c.push(j)}}return c};while(c.length>0){var f=c.shift(),g=f.split(/[\r\n]+/),h=d("ESSID",g).shift(),i=d("Channel",g).shift(),j=d("Frequency",g).shift(),k=d("Encryption key",g).shift(),l=d("IE",g),m=d("Quality",g).shift();if(h!=null&&h!=""&&k!=null&&m!=null){var n="wep";while(l.length>0)e=l.shift(),n=e.match(/WPA2/)?"psk2":n,n=n=="wep"&&e.match(/WPA/)?"psk":n;var o=k=="on"?n:"none",p=m.replace(/[\t ]+Sig.*$/g,"").split(/\//),q=Math.round(parseInt(p[0])*100/parseInt(p[1]));q=q>100?100:q,i==null&&(i=j.split(/\(Channel /)[1],i=i.split(/\)/)[0]),b[0].push(h),b[1].push(o),b[2].push(i),b[3].push(q),b[4].push(i>30?"A":"G")}}var r=[],s;for(s=0;s<b[3].length;s++)r.push([s,b[3][s]]);var t=function(a,b){return b[1]-a[1]};r=r.sort(t);var u=[[],[],[],[],[]];while(r.length>0){var v=r.shift()[0],w;for(w=0;w<5;w++)u[w].push(b[w][v])}return u}function setChannelWidth(a,b){var c=getSelectedValue(a.id),d=c=="HT40+",e=c=="HT40+"||c=="HT40-";if(b=="G"){setSelectedValue("wifi_channel_width",getSelectedValue(a.id)),setSelectedValue("bridge_channel_width",getSelectedValue(a.id)),setAllowableSelections("bridge_channel",mac80211Channels.G,mac80211Channels.G,document),setAllowableSelections("wifi_channel1",mac80211Channels.G,mac80211Channels.G,document),setAllowableSelections("wifi_channel2",mac80211Channels.G,mac80211Channels.G,document);var f=[],g=1;for(g=1;g<=4&&e;g++)f.push(d?mac80211Channels.G[mac80211Channels.G.length-g]:g);while(f.length>0){var h=f.shift();removeOptionFromSelectElement("bridge_channel",h,document),removeOptionFromSelectElement("wifi_channel1",h,document),removeOptionFromSelectElement("wifi_channel2",h,document)}updateTxPower("wifi_max_txpower","wifi_txpower","G")}else if(b=="A"&&mac80211Channels["A"]!=null){var i=mac80211Channels.A,j=i;if(e){j=[];var k=[36,44,52,60,149,157],l=[40,48,56,64,153,161],m=d?arrToHash(k):arrToHash(l);for(var n=0;n<i.length;n++){var o=i[n];m[o]==1&&j.push(o)}}setAllowableSelections("wifi_channel1_5ghz",j,j,document),setAllowableSelections("wifi_channel2_5ghz",j,j,document),setAllowableSelections("bridge_channel_5ghz",j,j,document),updateTxPower("wifi_max_txpower_5ghz","wifi_txpower_5ghz","A")}}function getSelectedWifiChannels(){var a=[];a.A="",a.G="";if(document.getElementById("global_gateway").checked){var b=getSelectedValue("wifi_mode"),c="bg",d=!0,e=!1,f=!1;document.getElementById("wifi_hwmode_container").style.display=="block"&&(hwMode=getSelectedValue("wifi_hwmode"),e=hwMode=="dual"||hwMode=="11na",d=hwMode!="11na",f=hwMode=="dual");var g=scannedSsids[0].length>0&&b.match(/sta/),h=getSelectedValue("wifi_list_ssid2");g=g&&h!="custom";if(g){var i=scannedSsids[2][parseInt(h)],j=scannedSsids[4][parseInt(h)];a[j]=i;if(f){var k=j=="G"?"A":"G",l=k=="G"?"wifi_channel1":"wifi_channel1_5ghz";a[k]=getSelectedValue(l)}}g||(d&&(a.G=getSelectedValue("wifi_channel1")),e&&(a.A=getSelectedValue("wifi_channel1_5ghz")))}else if(document.getElementById("bridge_hwmode_container").style.display=="block"){var c=getSelectedValue("bridge_hwmode");c=="11na"?a.A=document.getElementById("bridge_fixed_channel_container").style.display!="none"?document.getElementById("bridge_fixed_channel").firstChild.data:getSelectedValue("bridge_channel_5ghz"):a.G=document.getElementById("bridge_fixed_channel_container").style.display!="none"?document.getElementById("bridge_fixed_channel").firstChild.data:getSelectedValue("bridge_channel")}else a.G=document.getElementById("bridge_fixed_channel_container").style.display!="none"?document.getElementById("bridge_fixed_channel").firstChild.data:getSelectedValue("bridge_channel");return a}function setHwMode(a){if(document.getElementById("wifi_hwmode_container").style.display=="none"&&document.getElementById("bridge_hwmode_container").style.display=="none")return;var b=getSelectedValue(a.id);b=b=="dual"&&document.getElementById("global_bridge").checked?"11ng":b,a.id=="bridge_hwmode"&&getSelectedValue("wifi_hwmode")!="dual"&&setSelectedValue("wifi_hwmode",b),setSelectedValue("bridge_hwmode",b=="dual"?"11ng":b),document.getElementById("wifi_channel_width_container").style.marginTop=b=="dual"?"20px":"5px",document.getElementById("wifi_channel_width_5ghz_container").style.marginTop=b=="11na"?"5px":"20px",document.getElementById("wifi_txpower_5ghz_container").style.marginBottom=b=="11na"?"5px":"20px",setChildText("wifi_ssid1a_label",b=="11na"?"Access Point SSID:":"AP 5GHz SSID:"),setChildText("wifi_channel1_5ghz_label",b=="11na"?"Wireless Channel:":"Wireless Channel (5GHz):"),setChildText("wifi_txpower_5ghz_label",b=="11na"?"Transmit Power:":"5GHz Transmit Power:"),setChildText("wifi_channel_width_5ghz_label",b=="11na"?"Channel Width:":"5GHz Channel Width:"),setChildText("wifi_ssid1_label",b=="dual"?"AP 2.4GHz SSID:":"接入点 SSID:"),setChildText("wifi_channel1_label",b=="dual"?"Wireless Channel (2.4GHz):":"无线频道:"),setChildText("wifi_txpower_label",b=="dual"?"2.4GHz Transmit Power:":"发射功率:"),setChildText("wifi_channel_width_label",b=="dual"?"2.4GHz Channel Width:":"频宽:"),document.getElementById("wifi_ssid1a").value=document.getElementById("wifi_ssid1a").value==""?document.getElementById("wifi_ssid1").value+"_5GHz":document.getElementById("wifi_ssid1a").value,wirelessDriver=="mac80211"&&(setChannel(document.getElementById("wifi_channel1"),"G"),(b=="dual"||b=="11na")&&setChannel(document.getElementById("wifi_channel1_5ghz"),"A"));var c=b=="11ng"||b=="11na"||b=="dual";c||(setSelectedValue("wifi_channel_width","HT20"),setChannelWidth(document.getElementById("wifi_channel_width"),"G"));var d=["wifi_channel_width_container","wifi_txpower_container","wifi_channel_width_5ghz_container","wifi_txpower_5ghz_container","wifi_ssid1a_container","wifi_ssid1_container","wifi_channel1_container","wifi_channel2_container","wifi_channel1_5ghz_container","wifi_channel2_5ghz_container","bridge_channel_width_container","bridge_channel_width_5ghz_container","bridge_txpower_container","bridge_txpower_5ghz_container","bridge_channel_container","bridge_channel_5ghz_container"],e,f=getSelectedValue("wifi_mode"),g=scannedSsids[0].length>0&&(f.match(/sta/)||document.getElementById("global_bridge").checked),h="";if(g){var i=getSelectedValue("wifi_list_ssid2");g=i!="custom",g&&(h=scannedSsids[4][parseInt(i)])}for(e=0;e<d.length;e++){var j=document.getElementById(d[e]),k=j.id,l=k.match("5ghz")||k.match(/a_/),m=!l,n=l?"A":"G",o=k.match(/1_/)||k.match(/1a_/),p=k.match(/2_/)||k.match(/2a_/),q=o&&!f.match(/ap/)||p&&!f.match(/sta/),r=g&&k.match(/channel/)&&!k.match(/channel_width/)&&(!f.match(/ap/)||h==n),s=k=="wifi_ssid1_container"||k=="wifi_txpower_container"||k=="wifi_channel1_container"||k=="wifi_channel2_container"||k=="bridge_txpower_container"||k=="bridge_channel_container",t=(c||s)&&!q&&!r&&(l&&(b=="dual"||b=="11na")||m&&b!="11na");j.style.display=t?"block":"none"}document.getElementById("wifi_client_band_container").style.display=f=="ap+sta"&&b=="dual"?"block":"none";if(f=="ap+sta"&&b=="dual"){var u=getSelectedValue("wifi_client_band");document.getElementById("wifi_client_band_container").style.display=g?"none":"block",document.getElementById("wifi_channel2_container").style.display=u=="2.4"&&!g?"block":"none",document.getElementById("wifi_channel2_5ghz_container").style.display=u=="5"&&!g?"block":"none"}}function getMaxTxPower(a){var b=txPowerMax;if(wirelessDriver=="mac80211"){var c=getSelectedValue(a=="A"?"wifi_channel1_5ghz":"wifi_channel1"),d=mac80211ChPwrs[a],e=d==null?null:d[c];b=e==null?b:e}return b}function updateTxPower(a,b,c){var d=getMaxTxPower(c),e=getSelectedValue(a),f=e=="max",g=document.getElementById(b).value,h=[];h.G=[["wifi_max_txpower","wifi_txpower","wifi_dbm"],["bridge_max_txpower","bridge_txpower","bridge_dbm"]],h.A=[["wifi_max_txpower_5ghz","wifi_txpower_5ghz","wifi_dbm_5ghz"],["bridge_max_txpower_5ghz","bridge_txpower_5ghz","bridge_dbm_5ghz"]];var i=h[c],j=0;for(j=0;j<i.length;j++)sel=document.getElementById(i[j][0]),txt=document.getElementById(i[j][1]),lab=document.getElementById(i[j][2]),setSelectedValue(sel.id,e),setElementEnabled(txt,!f,""+d),txt.value=f||g>d?""+d:""+g,lab.firstChild.data="(0 - "+d+"dBm)",lab.style.color=f?"gray":"black"}function renewDhcpLease(){var commands=[];commands.push("ls=$(uci -P /var/state get network.wan.lease_acquired)"),commands.push("killall -SIGUSR1 udhcpc"),commands.push("wait_sec=20"),commands.push("while [ $ls -eq $(uci -P /var/state get network.wan.lease_acquired 2>/dev/null) ] && [ $wait_sec -gt 0 ] ; do"),commands.push("sleep 1"),commands.push("wait_sec=$(($wait_sec - 1))"),commands.push("done"),commands.push('echo "var cd = \\""$(date +%s)"\\";"'),commands.push('echo "var up  = \\""$(cat /proc/uptime | sed \'s/\\..*$//g\' | sed \'s/ .*$//g\')"\\";"'),commands.push('echo "var wi  = \\""$(uci -P /var/state get network.wan.ipaddr )"\\";"'),commands.push('echo "var ls  = \\""$(uci -P /var/state get network.wan.lease_acquired )"\\";"'),commands.push('echo "var ll  = \\""$(uci -P /var/state get network.wan.lease_lifetime )"\\";"');var param=getParameterDefinition("commands",commands.join("\n"))+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,""));setControlsEnabled(!1,!0,"Renewing DHCP Lease");var stateChangeFunction=function(req){if(req.readyState==4){var reqLines=req.responseText.split(/[\r\n]+/);leaseLifetime=-1;while(reqLines.length>0){var cd="",up="",wi="",ls="",ll="",line=reqLines.shift();line.match(/^var/)&&(eval(line),cd!=""&&(currentDateSeconds=parseInt(cd)),up!=""&&(uptime=parseInt(up)),ll!=""&&(leaseLifetime=parseInt(ll)),ls!=""&&(leaseStart=parseInt(ls)),wi!=""&&setChildText("dhcp_ip",wi))}if(leaseLifetime>0){var releaseDate=new Date,leaseStartSeconds=currentDateSeconds-uptime+leaseStart;releaseDate.setTime(leaseStartSeconds*1e3+leaseLifetime*1e3+timezoneOffset*1e3),setChildText("dhcp_expires",localdate(releaseDate))}setControlsEnabled(!0)}};runAjax("POST","utility/run_commands.sh",param,stateChangeFunction)}function singleEthernetIsWan(){return singleEthernetPort()&&document.getElementById("global_gateway").checked&&getSelectedValue("wan_protocol").match(/wired/)}function singleEthernetPort(){return defaultWanIf==""||defaultWanIf==defaultLanIf}function getAltServerDefs(){function b(b,c){var d;for(d=0;d<b.length;d++){var e=b[d],f;for(f=0;f<c.length;f++)a.push("/"+e+"/"+c[f])}}var a=[];return b(ncTlds,ncDns),b(onTlds,onDns),a}function set3GDevice(a){document.getElementById("wan_3g_device").value=a}function scan3GDevice(a){setControlsEnabled(!1,!0,"Scanning For Mobile Devices");var b=getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),c=function(b){if(b.readyState==4){var c=[];c=b.responseText.split(/\n/),c.pop(),c.length>0?(setAllowableSelections(a,c,c),set3GDevice(getSelectedValue("wan_3g_list_device")),document.getElementById("wan_3g_device").style.display="none",document.getElementById("wan_3g_list_device").style.display="block"):alert("No devices found"),setControlsEnabled(!0)}};runAjax("POST","utility/scan_3gdevices.sh",b,c)}function updateService(){setSelectedValue("wan_3g_isp","custom"),updateApnDetails(),document.getElementById("wan_3g_user").value="",document.getElementById("wan_3g_pass").value="",showApn()}function showApn(){document.getElementById("wan_3g_apn_container").style.display=getSelectedValue("wan_3g_service")!="cdma"&&getSelectedValue("wan_protocol")=="3g"?"block":"none"}var scannedSsids=[[],[],[],[],[]],toggleReload=!1,currentLanIp,googleDns=["8.8.8.8","8.8.4.4"],openDns=["208.67.222.222","208.67.220.220"],ncDns=["178.32.31.41","106.187.47.17","176.58.118.172"],onDns=["66.244.95.20","95.211.32.162","95.142.171.235"],ncTlds=[".bit"],onTlds=[".glue",".parody",".dyn",".bbs",".free",".fur",".geek",".gopher",".indy",".ing",".null",".oss",".micro"];