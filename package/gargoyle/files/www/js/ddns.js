/*
 * This program is copyright � 2008 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){setControlsEnabled(!1,!0),deleteCommands=[],sections=uciOriginal.getAllSections("ddns_gargoyle");for(sectionIndex=0;sectionIndex<sections.length;sectionIndex++)deleteCommands.push("uci del ddns_gargoyle."+sections[sectionIndex]);deleteCommands.push("uci commit"),createCommands=uci.getScriptCommands(new UCIContainer),testCommands=["/etc/init.d/ddns_gargoyle stop","/etc/init.d/ddns_gargoyle test_config"],commands=deleteCommands.join("\n")+"\n"+createCommands+"\n"+testCommands.join("\n");var a=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),b=function(a){a.readyState==4&&saveChangesPart2(a.responseText)};runAjax("POST","utility/run_commands.sh",a,b)}function saveChangesPart2(a){resettingAfterFailedUpdate=!1,responseLines=a.split(/[\r\n]+/),names=responseLines[0].split(/[\t ]+/),success=responseLines[1].split(/[\t ]+/),newFailedDomains=[],deleteCommands=[];for(nameIndex=0;nameIndex<names.length&&names.length==success.length;nameIndex++)if(success[nameIndex]=="0"){found=!1,failedName=names[nameIndex];for(newIndex=0;newIndex<newSections.length&&!found;newIndex++)failedName==newSections[newIndex]&&(resettingAfterFailedUpdate=!0,setDocumentFromUci(uci,"ddns_gargoyle",failedName,document),found=!0,failedDomain=uci.get("ddns_gargoyle",failedName,"domain"),failedDomain=failedDomain==""?uci.get("ddns_gargoyle",failedName,"service_provider"):failedDomain,newFailedDomains.push(failedDomain),deleteCommands.push("uci del ddns_gargoyle."+failedName),uci.removeSection("ddns_gargoyle",failedName))}deleteCommands.push("uci commit"),newFailedDomains.length>0&&alert("Update of new dynamic DNS service configuration(s) failed:\n"+newFailedDomains.join("\n")+"\n\nService(s) could not be updated properly and have therefore been removed."),getUpdateTimeCommands=[],sections=uci.getAllSections("ddns_gargoyle");for(sectionIndex=0;sectionIndex<sections.length;sectionIndex++)getUpdateTimeCommands.push("echo "+sections[sectionIndex]+" $(cat /var/last_ddns_updates/"+sections[sectionIndex]+")");commands=deleteCommands.join("\n")+"\n"+"/etc/init.d/ddns_gargoyle enable\n"+"/etc/init.d/ddns_gargoyle restart\n"+getUpdateTimeCommands.join("\n");var b=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),c=function(a){if(a.readyState==4){responseLines=a.responseText.split(/[\r\n]+/);for(responseIndex=0;responseIndex<responseLines.length-1;responseIndex++)lineParts=responseLines[responseIndex].split(/[\t ]+/),updateTimes[lineParts[0]]=lineParts[1];uciOriginal=uci.clone(),resetData(),setControlsEnabled(!0)}};runAjax("POST","utility/run_commands.sh",b,c)}function resetData(){initializeDescriptionVisibility(uciOriginal,"ddns_1"),uciOriginal.removeSection("gargoyle","help"),uci=uciOriginal.clone(),newSections=[],updatedSections=[],serviceProviders=parseProviderData();var a=[],b;for(b=0;b<serviceProviders.length;b++)a.push(serviceProviders[b].name);setAllowableSelections("ddns_provider",a,a,document),resettingAfterFailedUpdate||setDocumentFromUci(new UCIContainer,"","",document),resettingAfterFailedUpdate=!1;var c=uci.getAllSections("ddns_gargoyle"),d=["域名","最后更新","已启用","",""],e=new Array,f=new Array;for(sectionIndex=0;sectionIndex<c.length;sectionIndex++){var g=c[sectionIndex],h=uciOriginal.get("ddns_gargoyle",g,"domain");h=h==""?uciOriginal.get("ddns_gargoyle",g,"service_provider"):h,h=h.length>20?h.substr(0,17)+"...":h;var i=new Date;updateTimes[g]!=null&&i.setTime(1e3*updateTimes[g]);var j=uciOriginal.get("gargoyle","global","dateformat"),k=function(a){var b=""+a;return b=b.length==1?"0"+b:b,b},l=k(i.getMonth()+1),m=k(i.getDate()),n=" "+i.getHours()+":"+k(i.getMinutes())+":"+k(i.getSeconds()),o=j==""||j=="usa"?l+"/"+m+n:m+"/"+l+n;o=j=="russia"?m+"."+l+n:o,o=j=="iso8601"?l+"-"+m+n:o,o=updateTimes[g]==null?"Never":o;var p=createEnabledCheckbox();p.checked=uciOriginal.get("ddns_gargoyle",g,"enabled")=="1"?!0:!1,p.id=g,e.push([h,o,p,createEditButton(),createForceUpdateButton()]),e[e.length-1][4].disabled=p.checked?!1:!0,e[e.length-1][4].className=p.checked?"default_button":"default_button_disabled",f.push(p.checked)}var q=createTable(d,e,"ddns_table",!0,!1,removeServiceProviderCallback),r=document.getElementById("ddns_table_container");r.firstChild!=null&&r.removeChild(r.firstChild),r.appendChild(q);for(deIndex=0;deIndex<f.length;deIndex++)e[deIndex][2].checked=f[deIndex]}function addDdnsService(){var a=proofreadServiceProvider(document);if(a.length>0)errorString=a.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{var b=uci.getAllSections("ddns_gargoyle"),c=1+b.length;while(uci.get("ddns_gargoyle","ddns_"+c)!="")c++;var d="ddns_"+c,e=getSelectedValue("ddns_provider");setUciFromDocument(uci,"ddns_gargoyle",d,document);var f=uci.get("ddns_gargoyle",d,"domain");f=f==""?e:f,f=f.length>20?f.substr(0,17)+"...":f;var g=createEnabledCheckbox();g.checked=!0,g.id=d;var h=[f,"Never",g,createEditButton(),createForceUpdateButton()],i=document.getElementById("ddns_table_container").firstChild;addTableRow(i,h,!0,!1,removeServiceProviderCallback),setDocumentFromUci(new UCIContainer,"","",document),newSections.push(d),updatedSections.push(d)}}function removeServiceProviderCallback(a,b){var c=b.childNodes[2].firstChild.id;uci.removeSection("ddns_gargoyle",c)}function proofreadServiceProvider(a){var b=["ddns_check","ddns_force"],c=["ddns_check_label","ddns_force_label"],d=[validateNumeric,validateNumeric],e=[0,0],f=function(a){return validateLengthRange(a,1,999)},g;a.getElementById("ddns_provider_text")!=null?g=a.getElementById("ddns_provider_text").firstChild.data:g=getSelectedValue("ddns_provider",a);var h=null;for(providerIndex=0;providerIndex<serviceProviders.length&&h==null;providerIndex++)h=serviceProviders[providerIndex]["name"]==g?serviceProviders[providerIndex]:null;if(h==null){alert("ERROR: specified provider is invalid");return}var i=h.variables,j=h.optional_variables,k=[],l=0;for(l=0;l<h.boolean_variables.length;l++)k[h.boolean_variables[l]]=1;for(l=0;l<i.length;l++)k[i[l]]!=1&&(b.push(i[l]),c.push(i[l]+"_label"),d.push(f),e.push(0));for(l=0;l<j.length;l++)k[j[l]]!=1&&a.getElementById(j[l]+"_enabled").checked&&(b.push(j[l]),c.push(j[l]+"_label"),d.push(f),e.push(0));var m=proofreadFields(b,c,d,e,b,a);for(l=0;l<i.length;l++)k[i[l]]!=1&&(a.getElementById(i[l]).className="");for(l=0;l<j.length;l++)k[j[l]]!=1&&a.getElementById(j[l]+"_enabled").checked&&(a.getElementById(j[l]).className="");if(m.length==0){var n;a.getElementById("domain")!=null?n=a.getElementById("domain").value:n=g;var o=uci.getAllSectionsOfType("ddns_gargoyle","service"),p=!1;for(serviceIndex=0;serviceIndex<o.length&&p==0;serviceIndex++){var q=uci.get("ddns_gargoyle",o[serviceIndex],"domain");q=q==""?uci.get("ddns_gargoyle",o[serviceIndex],"service_provider"):q,p=q==n?!0:!1}p&&m.push("Duplicate update specified.")}return m}function setUciFromDocument(a,b,c,d){d==null&&(d=document);var e;d.getElementById("ddns_provider_text")!=null?e=d.getElementById("ddns_provider_text").firstChild.data:e=getSelectedValue("ddns_provider",d),a.removeSection("ddns_gargoyle",c),a.set("ddns_gargoyle",c,"","service"),a.set("ddns_gargoyle",c,"enabled","1"),a.set("ddns_gargoyle",c,"service_provider",e),a.set("ddns_gargoyle",c,"ip_source","internet"),a.set("ddns_gargoyle",c,"force_interval",d.getElementById("ddns_force").value),a.set("ddns_gargoyle",c,"force_unit","days"),a.set("ddns_gargoyle",c,"check_interval",d.getElementById("ddns_check").value),a.set("ddns_gargoyle",c,"check_unit","minutes");var f=null;for(providerIndex=0;providerIndex<serviceProviders.length&&f==null;providerIndex++)f=serviceProviders[providerIndex]["name"]==e?serviceProviders[providerIndex]:null;if(f==null){alert("ERROR: specified provider is invalid");return}var g=f.variables,h=f.optional_variables,i=[],j=0;for(j=0;j<f.boolean_variables.length;j++)i[f.boolean_variables[j]]=1;for(j=0;j<g.length;j++){var k=d.getElementById(g[j]),l=i[k.id]!=1?k.value:k.checked?"1":"0";l!=""&&a.set("ddns_gargoyle",c,k.id,l)}for(j=0;j<h.length;j++){var k=d.getElementById(h[j]);i[k.id]!=1?d.getElementById(k.id+"_enabled").checked&&a.set("ddns_gargoyle",c,k.id,k.value):a.set("ddns_gargoyle",c,k.id,k.checked?"1":"0")}}function setDocumentFromUci(a,b,c,d){d==null&&(d=document);var e=a.get(b,c,"service_provider");d.getElementById("ddns_provider_text")!=null?d.getElementById("ddns_provider_text").appendChild(d.createTextNode(e)):setSelectedValue("ddns_provider",e,d);var f=setProvider(d),g=f.variables,h=f.optional_variables,i=[],j=0;for(j=0;j<f.boolean_variables.length;j++)i[f.boolean_variables[j]]=1;for(j=0;j<g.length;j++){var k=d.getElementById(g[j]);i[k.id]!=1?k.value=a.get(b,c,k.id):k.checked=a.get(b,c,k.id)=="1"?!0:!1}for(j=0;j<h.length;j++){var k=d.getElementById(h[j]);if(i[k.id]!=1){var l=d.getElementById(h[j]+"_enabled");l.checked=a.get(b,c,k.id)!="",l.checked&&(k.value=a.get(b,c,k.id)),setElementEnabled(k,l.checked,"")}else k.checked=a.get(b,c,k.id)=="1"?!0:!1}var m=getMultipleFromUnit(a.get("ddns_gargoyle",c,"check_unit"))*a.get("ddns_gargoyle",c,"check_interval")/60;m=m>0?m:15,d.getElementById("ddns_check").value=m;var n=getMultipleFromUnit(a.get("ddns_gargoyle",c,"force_unit"))*a.get("ddns_gargoyle",c,"force_interval")/86400;n=n>0?n:3,d.getElementById("ddns_force").value=n}function setProvider(a){a==null&&(a=document);var b;a.getElementById("ddns_provider_text")!=null?b=a.getElementById("ddns_provider_text").firstChild.data:b=getSelectedValue("ddns_provider",a);var c=null;for(providerIndex=0;providerIndex<serviceProviders.length&&c==null;providerIndex++)c=serviceProviders[providerIndex]["name"]==b?serviceProviders[providerIndex]:null;if(c!=null){var d=c.variables,e=c.variable_names,f=new Array,g=[],h=0;for(h=0;h<c.boolean_variables.length;h++)g[c.boolean_variables[h]]=1;for(h=0;h<d.length;h++){var i=a.createElement("div"),j=a.createElement("label");j.className="leftcolumn",j.id=d[h]+"_label",j.appendChild(a.createTextNode(e[h]+":")),i.appendChild(j);var k;g[d[h]]!=1?k=createInput("text",a):k=createInput("checkbox",a),k.className="rightcolumn",k.id=d[h],i.appendChild(k),f.push(i)}var l=c.optional_variables,m=c.optional_variable_names;for(h=0;h<l.length;h++){var i=a.createElement("div"),j=a.createElement("label");j.className="leftcolumn",j.id=l[h]+"_label",j.appendChild(a.createTextNode(m[h]+":")),i.appendChild(j);if(g[l[h]]!=1){var n=a.createElement("span");n.className="rightcolumn";var o=createInput("checkbox",a);o.style.position="relative",o.style.top="3px";var p=createInput("text",a);o.id=l[h]+"_enabled",p.id=l[h],o.onclick=function(){var b=this.id.replace("_enabled","");setElementEnabled(a.getElementById(b),this.checked,"")},n.appendChild(o),n.appendChild(p),i.appendChild(n)}else{var k=createInput("checkbox",a);k.className="rightcolumn",k.id=l[h],i.appendChild(k)}f.push(i)}container=a.getElementById("ddns_variable_container");while(container.childNodes.length>0)container.removeChild(container.firstChild);for(newElementIndex=0;newElementIndex<f.length;newElementIndex++)container.appendChild(f[newElementIndex]);for(h=0;h<l.length;h++)g[l[h]]!=1&&setElementEnabled(a.getElementById(l[h]),a.getElementById(l[h]+"_enabled").checked,"")}return c}function createEnabledCheckbox(){return enabledCheckbox=createInput("checkbox"),enabledCheckbox.onclick=setRowEnabled,enabledCheckbox}function createEditButton(){return editButton=createInput("button"),editButton.value="编辑",editButton.className="default_button",editButton.onclick=editServiceTableRow,editButton}function createForceUpdateButton(){return updateButton=createInput("button"),updateButton.value="强制更新",updateButton.className="default_button",updateButton.onclick=forceUpdateForRow,updateButton}function setRowEnabled(){var a=this.checked?"1":"0",b=this.parentNode.parentNode,c=b.firstChild.firstChild.data;b.childNodes[4].firstChild.disabled=this.checked?!1:!0,b.childNodes[4].firstChild.className=this.checked?"default_button":"default_button_disabled";var d=b.childNodes[2].firstChild.id;uci.set("ddns_gargoyle",d,"enabled",a),updatedSections.push(d)}function parseProviderData(){providers=new Array;for(providerLineIndex=0;providerLineIndex<providerData.length;providerLineIndex++){line=providerData[providerLineIndex];if(line.match(/^[\t ]*service[\t ]+/)){var a=new Array,b=line.split(/ervice[\t ]+/);a.name=b[1],a.optional_variables=[],a.optional_variable_names=[],a.boolean_variables=[],line="",providerLineIndex++;while(providerLineIndex<providerData.length&&line.match(/^[\t ]*service[\t ]+/)==null)line=providerData[providerLineIndex],line.match(/^[\t ]*required_variables[\t ]+/)?(variablePart=line.match(/ariables[\t ]+(.*)$/)[1],a.variables=variablePart.split(/[\t ]+/)):line.match(/^[\t ]*optional_variables[\t ]+/)?(variablePart=line.match(/ariables[\t ]+(.*)$/)[1],a.optional_variables=variablePart.split(/[\t ]+/)):line.match(/^[\t ]*required_variable_names[\t ]+/)?(variablePart=line.match(/ariable_names[\t ]+(.*)$/)[1],a.variable_names=variablePart.split(/,/)):line.match(/^[\t ]*optional_variable_names[\t ]+/)?(variablePart=line.match(/ariable_names[\t ]+(.*)$/)[1],a.optional_variable_names=variablePart.split(/,/)):line.match(/^[\t ]*boolean_variables[\t ]+/)&&(variablePart=line.match(/ariables[\t ]+(.*)$/)[1],a.boolean_variables=variablePart.split(/[\t ]+/)),providerLineIndex++;a["name"]!=null&&a["variables"]!=null&&a["variable_names"]!=null&&providers.push(a),line.match(/^[\t ]*service[\t ]+/)&&(providerLineIndex-=2)}}return providers}function forceUpdateForRow(){var a=this.parentNode.parentNode,b=uci.getAllSections("ddns_gargoyle"),c=a.firstChild.firstChild.data,d=a.childNodes[2].firstChild.id,e=!1;for(updatedIndex=0;updatedIndex<updatedSections.length&&!e;updatedIndex++)e=d==updatedSections[updatedIndex];if(e)alert('This service has been added/modified and therefore you must save your changes before an update can be performed.  Click "Save Changes" and try again.');else{setControlsEnabled(!1,!0);var f="/usr/bin/ddns_gargoyle -P /etc/ddns_providers.conf -C /etc/ddns_gargoyle.conf -m -f "+d;f=f+"\n"+"echo $(cat /var/last_ddns_updates/"+d+") ";var g=getParameterDefinition("commands",f)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),h=function(a){if(a.readyState==4){var b=a.responseText.split(/[\r\n]+/);setControlsEnabled(!0),b[0]=="0"?alert("Update failed.  Ensure your configuration is valid and that you are connected to the internet."):(alert("Update successful."),updateTimes[d]=b[1],resetData())}};runAjax("POST","utility/run_commands.sh",g,h)}}function editServiceTableRow(){if(typeof editServiceWindow!="undefined")try{editServiceWindow.close()}catch(a){}var b,c;try{b=window.screenX+225,c=window.screenY+225}catch(a){b=window.left+225,c=window.top+225}editServiceWindow=window.open("ddns_edit_service.sh","edit","width=560,height=500,left="+b+",top="+c);var d=createInput("button",editServiceWindow.document),e=createInput("button",editServiceWindow.document);d.value="关闭且保存设置",d.className="default_button",e.value="关闭不保存设置",e.className="default_button";var f=this.parentNode.parentNode,g=f.childNodes[2].firstChild.id,h=uci.get("ddns_gargoyle",g,"service_provider"),i=uci.get("ddns_gargoyle",g,"domain");i=i==""?h:i;var j=null;for(providerIndex=0;providerIndex<serviceProviders.length&&j==null;providerIndex++)j=h==serviceProviders[providerIndex]["name"]?serviceProviders[providerIndex]:null;var k=j.variables,l=j.variable_names;runOnServiceEditorLoaded=function(){update_done=!1,editServiceWindow.document!=null&&editServiceWindow.document.getElementById("bottom_button_container")!=null&&(editServiceWindow.document.getElementById("bottom_button_container").appendChild(d),editServiceWindow.document.getElementById("bottom_button_container").appendChild(e),setDocumentFromUci(uci,"ddns_gargoyle",g,editServiceWindow.document),e.onclick=function(){editServiceWindow.close()},d.onclick=function(){var a=editServiceWindow.document.getElementById("domain")!=null?editServiceWindow.document.getElementById("domain").value:h,b=proofreadServiceProvider(editServiceWindow.document);b.length==1&&b[0].match(/Duplicate/)&&a==i&&(b=[]);if(b.length>0)alert(b.join("\n")+"\n\nCould not update service class."),editServiceWindow.focus();else{var c=a.length>20?a.substr(0,17)+"...":a;f.firstChild.firstChild.data=c,setUciFromDocument(uci,"ddns_gargoyle",g,editServiceWindow.document),updatedSections.push(g),editServiceWindow.close()}},editServiceWindow.moveTo(b,c),editServiceWindow.focus(),update_done=!0),update_done==0&&setTimeout("runOnServiceEditorLoaded()",250)},runOnServiceEditorLoaded()}function getMultipleFromUnit(a){return multiple=1,a=="minutes"?multiple=60:a=="hours"?multiple=3600:a=="days"?multiple=86400:a=="weeks"?multiple=604800:multiple=1,multiple}var serviceProviders,uci,newSections,updatedSections,resettingAfterFailedUpdate=!1;