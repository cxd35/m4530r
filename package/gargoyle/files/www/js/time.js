/*
 * This program is copyright ï¿½ 2008 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){errorList=proofreadAll();if(errorList.length>0)errorString=errorList.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{setControlsEnabled(!1,!0),uci=uciOriginal.clone();var a=[];for(sectionIndex=0;sectionIndex<3;sectionIndex++){var b=document.getElementById("server"+(sectionIndex+1)).value;b!=""&&a.push(b)}uci.createListOption("system","ntp","server",!0),uci.set("system","ntp","server",a,!1);var c=uciOriginal.getAllSectionsOfType("system","system"),d=uciOriginal.getAllOptionsInSection("system",c[0]),e=getSelectedValue("date_format");uci.set("gargoyle","global","dateformat",getSelectedValue("date_format"));var f=[];f.iso='"+%Y/%m/%d %H:%M %Z"',f.iso8601='"+%Y-%m-%d %H:%M %Z"',f.australia='"+%d/%m/%y %H:%M %Z"',f.usa='"+%m/%d/%y %H:%M %Z"',f.russia='"+%d.%m.%Y %H:%M %Z"';var g="";getSelectedValue("timezone").match(/UTC/)?g="date "+f[e]+" | sed 's/UTC/UTC-"+getSelectedValue("timezone").replace(/UTC/,"")+"/g' | sed 's/\\-\\-/+/g'":g="date "+f[e];var h=[];uci.set("system",c[0],"timezone",getSelectedValue("timezone")),c[0]!="system"&&(h.push("uci del system."+c[0]),h.push("uci commit"),h.push("uci set system.system=system"),h.push("uci commit")),uci.set("system","system","","system");var i=0;for(i=0;i<d.length;i++)uci.set("system","system",d[i],uci.get("system",c[0],d[i]));c[0]!="system"&&(uciOriginal.removeSection("system",c[0]),uci.removeSection("system",c[0]));var j="uci show system | grep timezone | sed 's/^.*=//g' >/etc/TZ\n";commands=h.join("\n")+"\n"+uci.getScriptCommands(uciOriginal)+"\n"+j+"\n"+"/etc/init.d/sysntpd restart\n/usr/bin/set_kernel_timezone\n"+g;var k=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),l=function(a){if(a.readyState==4){var b=a.responseText.split(/[\r\n]+/);if(b!=null){while(b.length>0&&!b[b.length-1].match(/:/))b.pop();b.length>0&&(currentTime=b[b.length-1])}uciOriginal=uci.clone(),resetData(),setControlsEnabled(!0)}};runAjax("POST","utility/run_commands.sh",k,l)}}function proofreadAll(){return""}function resetData(){setChildText("current_time",currentTime),timezoneList=timezoneData[0],timezoneDefinitions=timezoneData[2],removeAllOptionsFromSelectElement(document.getElementById("timezone"));for(tzIndex=0;tzIndex<timezoneList.length;tzIndex++)timezone=timezoneList[tzIndex],addOptionToSelectElement("timezone",timezone,timezoneDefinitions[timezone]);var a=uciOriginal.getAllSectionsOfType("system","system"),b=uciOriginal.get("system",a[0],"timezone");b=b=="UTC"?"UTC0":b,setSelectedValue("timezone",previousTimezoneDefinition),setSelectedValue("timezone",b),previousTimezoneDefinition=b;var c=uciOriginal.get("gargoyle","global","dateformat");setSelectedValue("date_format","usa"),setSelectedValue("date_format",c);var d=uciOriginal.get("system","ntp","server"),d=d==null||d==""?[]:d;while(d.length>3)d.pop();var e;for(e=0;e<d.length;e++)document.getElementById("server"+(1+e)).value=d[e];currentRegion="custom";if(d.length>=3){testRegion="",validRegion=!0;for(serverIndex=0;serverIndex<3&&validRegion;serverIndex++)validRegion=!1,nextRegion=d[serverIndex].match(/[0-9]+\.([^\.]+)\.pool\.ntp\.org/),nextRegion==null&&d[serverIndex].match(/[0-9]+\.pool\.ntp\.org/)&&(nextRegion=["","global"]),nextRegion!=null&&(nextRegion[1]==testRegion||testRegion=="")&&(testRegion=nextRegion[1],validRegion=!0);currentRegion=validRegion?testRegion:currentRegion}else for(serverIndex=d.length;serverIndex<3;serverIndex++)document.getElementById("server"+(1+e)).value=2-serverIndex+".pool.ntp.org";setSelectedValue("region","custom"),setSelectedValue("region",currentRegion),updateServerList()}function timezoneChanged(){timezoneRegions=timezoneData[1],definitionTimezones=timezoneData[3],newTimezoneDefinition=getSelectedValue("timezone"),getSelectedValue("region")==timezoneRegions[definitionTimezones[previousTimezoneDefinition]]&&(setSelectedValue("region",timezoneRegions[definitionTimezones[newTimezoneDefinition]]),updateServerList()),previousTimezoneDefinition=newTimezoneDefinition}function updateServerList(){var a=getSelectedValue("region");for(serverIndex=1;serverIndex<=3;serverIndex++)if(a=="custom")setElementEnabled(document.getElementById("server"+serverIndex),!0,document.getElementById("server"+serverIndex).value);else{var b=(3-serverIndex+"."+a+".pool.ntp.org").replace(/\.global\./,".");setElementEnabled(document.getElementById("server"+serverIndex),!1,b)}}var previousTimezoneDefinition="PST8PDT,M3.2.0/2,M11.1.0/2";